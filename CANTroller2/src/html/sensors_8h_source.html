<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: sensors.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">sensors.h</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="preprocessor">#pragma once</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="preprocessor">#include &lt;memory&gt;</span> <span class="comment">// for std::shared_ptr</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#include &lt;SparkFun_FS3000_Arduino_Library.h&gt;</span>  <span class="comment">// For air velocity sensor  http://librarymanager/All#SparkFun_FS3000</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor">#include &lt;Arduino.h&gt;</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#include &lt;FunctionalInterrupt.h&gt;</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="preprocessor">#include &quot;driver/rmt.h&quot;</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#include &lt;ESP32Servo.h&gt;</span>        <span class="comment">// Makes PWM output to control motors (for rudimentary control of our gas and steering)</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#include &lt;Preferences.h&gt;</span>  <span class="comment">// Functions for writing values to nvs flash partition</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">// This enum class represent the components which can be simulated (sensor). It&#39;s a uint8_t type under the covers, so it can be used as an index</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">// typedef uint8_t opt_t;</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="keyword">enum class</span> sens : <span class="keywordtype">int</span> { none=0, joy=1, pressure=2, brkpos=3, speedo=4, tach=5, airvelo=6, mapsens=7, engtemp=8, mulebatt=9, starter=10, basicsw=11, NUM_SENSORS=12 };  <span class="comment">//, ignition, syspower };  // , NUM_SENSORS, err_flag };</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="keyword">enum class</span> src : <span class="keywordtype">int</span> { UNDEF=0, FIXED=1, PIN=2, TOUCH=3, POT=4, CALC=5 };</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> </div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="keywordtype">int</span> sources[<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(sens::NUM_SENSORS)] = { <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(src::UNDEF) };</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="preprocessor">#include &quot;i2cbus.h&quot;</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">// Potentiometer does an analog read from a pin and maps it to a percent (0%-100%). We filter the value to keep it smooth.</span></div>
<div class="foldopen" id="foldopen00021" data-start="{" data-end="};">
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno"><a class="line" href="class_potentiometer.html">   21</a></span><span class="keyword">class </span><a class="code hl_class" href="class_potentiometer.html">Potentiometer</a> {</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    <span class="keywordtype">float</span> _ema_alpha = .95;</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>    <span class="keywordtype">float</span> _pc_min = 0.0;</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>    <span class="keywordtype">float</span> _pc_max = 100.0;</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    <span class="keywordtype">float</span> _pc_activity_margin = 7.5;</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>    uint8_t _pin;</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>    <span class="keywordtype">float</span> _val = 0.0, _activity_ref;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>    <a class="code hl_class" href="class_timer.html">Timer</a> pot_timer{100000};  <span class="comment">// adc cannot read too fast w/o errors, so give some time between readings</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>    <span class="comment">// tune these by monitoring adc_raw and twist pot to each limit. set min at the highest value seen when turned full CCW, and vice versas for max, then trim each toward adc_midrange until you get full 0 to 100% range</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>    <span class="keywordtype">float</span> adc_min = 380; <span class="comment">// TUNED 230603 - Used only in determining theconversion factor</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>    <span class="keywordtype">float</span> adc_max = 4095; <span class="comment">// TUNED 230613 - adc max measured = ?, or 9x.? % of adc_range. Used only in determining theconversion factor</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    <span class="keywordtype">float</span> adc_raw;</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>(uint8_t arg_pin) : _pin(arg_pin) {}</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>() = <span class="keyword">delete</span>; <span class="comment">// must have a pin defined</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    sens senstype = sens::none;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>        printf(<span class="stringliteral">&quot;Pot setup..\n&quot;</span>);</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>        set_pin(_pin, INPUT);</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>        _activity_ref = _val;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>    }</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>    <span class="keywordtype">void</span> update() {</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>        <span class="keywordflow">if</span> (pot_timer.expireset()) {</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>            adc_raw = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(analogRead(_pin));</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>            <span class="keywordtype">float</span> new_val = map(adc_raw, adc_min, adc_max, _pc_min, _pc_max);</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>            ema_filt(new_val, &amp;_val, _ema_alpha);</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>            _val = constrain(_val, _pc_min, _pc_max); <span class="comment">// the lower limit of the adc reading isn&#39;t steady (it will dip below zero) so constrain it back in range</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>            <span class="keywordflow">if</span> (std::abs(_val - _activity_ref) &gt; _pc_activity_margin) {</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>                <span class="comment">// Serial.printf(&quot;a:%ld n:%lf v:%lf r:%lf m:%lf &quot;, adc_raw, new_val, _val, _activity_ref, _pc_activity_margin);</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>                kick_inactivity_timer(7);  <span class="comment">// evidence of user activity</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>                _activity_ref = _val;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>                <span class="comment">// Serial.printf(&quot;r2:%lf\n&quot;, _activity_ref);</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>            }</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>        }</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>    }</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> VAL_T&gt;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>    VAL_T mapToRange(VAL_T min, VAL_T max) {</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>        <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>VAL_T<span class="keyword">&gt;</span>(map(_val, _pc_min, _pc_max, <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(min), <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(max)));</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>    }</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>    <span class="keywordtype">float</span> val() { <span class="keywordflow">return</span> _val; }</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>    <span class="keywordtype">float</span> min() { <span class="keywordflow">return</span> _pc_min; }</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>    <span class="keywordtype">float</span> max() { <span class="keywordflow">return</span> _pc_max; }</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>};</div>
</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span><span class="comment">// NOTE: the following classes all contain their own initial config values (for simplicity). We could instead use Config objects and pass them in at construction time, which might be</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span><span class="comment">//       a little cleaner organization-wise, since all the configs would be consolidated. It would also allow us to read Configs from storage somewhere, so we could have persistent</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="comment">//       calibration.</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span> </div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span><span class="comment">// Param is a value which is constrained between min/max limits, representing a &quot;raw&quot; (aka unfiltered) quantity. A value with tight limits</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span><span class="comment">// (wehere min=val=max) is constant and cannot be changed without changing the limits. An unconstrained value can be represented by setting</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span><span class="comment">// either or both min/max to infinity.</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> VALUE_T&gt;</div>
<div class="foldopen" id="foldopen00073" data-start="{" data-end="};">
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno"><a class="line" href="class_param.html">   73</a></span><span class="keyword">class </span><a class="code hl_class" href="class_param.html">Param</a> {</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>    std::shared_ptr&lt;VALUE_T&gt; _val, _min, _max;</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>    VALUE_T _last; <span class="comment">// keep track of the last value (still needed?)</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>    <span class="keywordtype">bool</span> _saturated = <span class="keyword">false</span>; <span class="comment">// keeps track of whether the value has been constrained by the limits or not</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>    <span class="comment">// NOTE: add centerpoint...?</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span> </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>    <span class="keywordtype">void</span> constrain_value() {</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        _saturated = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>        <span class="keywordflow">if</span> (*_val &lt; *_min) {</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>            *_val = *_min;</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>            _saturated = <span class="keyword">true</span>;  <span class="comment">// Constraint was necessary</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>        }</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*_val &gt; *_max) {</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>            *_val = *_max;</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            _saturated = <span class="keyword">true</span>;  <span class="comment">// Constraint was necessary</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>        }</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>    }</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>    </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>    std::string _long_name = <span class="stringliteral">&quot;Unnamed value&quot;</span>;</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>    std::string _short_name = <span class="stringliteral">&quot;noname&quot;</span>;</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>    std::string _native_units_name = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>    std::string _human_units_name = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span> </div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>    <span class="comment">// Creates a constant Param with the default value for VALUE_T</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>    <span class="comment">// NOTE: this is really only needed for initalization cases where we don&#39;t have a valid starting value when we first make the Param</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>    <a class="code hl_class" href="class_param.html">Param</a>(){</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>        _val = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>        _min = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        _max = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>        _last = *_val;</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>    }</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>    <span class="comment">// Creates a constant Param (with min/max == val)</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>    <a class="code hl_class" href="class_param.html">Param</a>(VALUE_T arg_val) {</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>        _val = std::make_shared&lt;VALUE_T&gt;(arg_val);</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>        _min = std::make_shared&lt;VALUE_T&gt;(arg_val);</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>        _max = std::make_shared&lt;VALUE_T&gt;(arg_val);</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>        _last = *_val;</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>    } </div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    <span class="comment">// Creates a regular constrained Param</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>    <a class="code hl_class" href="class_param.html">Param</a>(VALUE_T arg_val, VALUE_T arg_min, VALUE_T arg_max) {</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>        _val = std::make_shared&lt;VALUE_T&gt;(arg_val);</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>        _min = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>        _max = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>        set_limits(arg_min, arg_max);</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>        _last = *_val;</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>    } </div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    <span class="comment">// Creates a constraned Param which uses external limits.</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>    <span class="comment">// NOTE: if using external limits, it&#39;s (currently) possible to get stale values, since there is no</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>    <span class="comment">//       callback mechanism in place. We could get around this by calling constrain_value() on every</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>    <span class="comment">//       get() call, but that seems like overkill...</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>    <a class="code hl_class" href="class_param.html">Param</a>(VALUE_T arg_val, std::shared_ptr&lt;VALUE_T&gt; arg_min_ptr, std::shared_ptr&lt;VALUE_T&gt; arg_max_ptr) {</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>        _val = std::make_shared&lt;VALUE_T&gt;(arg_val);</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>        _min = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>        _max = std::make_shared&lt;VALUE_T&gt;();</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>        set_limits(arg_min_ptr, arg_max_ptr);</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>        _last = *_val;</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>    } </div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span> </div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>    <span class="keywordtype">void</span> set_limits(VALUE_T arg_min, VALUE_T arg_max) {  <span class="comment">// Use if min/max are kept in-class</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>        <span class="keywordflow">if</span> (arg_min &gt; arg_max)</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>            printf(<span class="stringliteral">&quot;Error: min is &gt;= max\n&quot;</span>);</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>            *_min = arg_min;</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>            *_max = arg_max;</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>            constrain_value();</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>        }</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    }</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    <span class="keywordtype">void</span> set_limits(std::shared_ptr&lt;VALUE_T&gt; arg_min_ptr, std::shared_ptr&lt;VALUE_T&gt; arg_max_ptr) { <span class="comment">// Use if min/max are external</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>        <span class="keywordflow">if</span> (arg_min_ptr.get() &gt; arg_max_ptr.get())</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>            printf(<span class="stringliteral">&quot;Error: *min is &gt; *max\n&quot;</span>);</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>            _min = arg_min_ptr;</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>            _max = arg_max_ptr;</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>            constrain_value();</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>        }</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>    }</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span> </div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>    <span class="comment">// return value indicates if the value actually changed or not</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>    <span class="keywordtype">bool</span> set(VALUE_T arg_val) {</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>        _last = *_val;</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>        *_val = arg_val;</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>        constrain_value();</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>        <span class="keywordflow">if</span> (*_val != _last) {</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>        }</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>    }</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span> </div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    <span class="keywordtype">bool</span> add(VALUE_T arg_add) {</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>        <span class="keywordflow">return</span> set(*_val + arg_add);</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>    }</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    <span class="comment">// Getter functions</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>    VALUE_T val() { <span class="keywordflow">return</span> *_val; }</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    VALUE_T min() { <span class="keywordflow">return</span> *_min; }</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>    VALUE_T max() { <span class="keywordflow">return</span> *_max; }</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>    VALUE_T* ptr() { <span class="keywordflow">return</span> _val.get(); }</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>    VALUE_T* min_ptr() { <span class="keywordflow">return</span> _min.get(); }</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>    VALUE_T* max_ptr() { <span class="keywordflow">return</span> _max.get(); }</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>    std::shared_ptr&lt;VALUE_T&gt; shptr() { <span class="keywordflow">return</span> _val; }</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>    std::shared_ptr&lt;VALUE_T&gt; min_shptr() { <span class="keywordflow">return</span> _min; }</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>    std::shared_ptr&lt;VALUE_T&gt; max_shptr() { <span class="keywordflow">return</span> _max; }</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>    VALUE_T last() { <span class="keywordflow">return</span> _last; } <span class="comment">// NOTE: currently unused, do we still need this for drawing purposes?</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>    <span class="keywordtype">bool</span> saturated() { <span class="keywordflow">return</span> _saturated; }</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>};</div>
</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span> </div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span><span class="comment">// Device class - is a base class for any connected system device or signal associated with a pin</span></div>
<div class="foldopen" id="foldopen00181" data-start="{" data-end="};">
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno"><a class="line" href="class_device.html">  181</a></span><span class="keyword">class </span><a class="code hl_class" href="class_device.html">Device</a> {</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>    <span class="comment">// Which types of sources are possible for this device?</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>    uint8_t _pin;</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>    <span class="keywordtype">bool</span> _enabled = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>    <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>* _pot; <span class="comment">// to pull input from the pot if we&#39;re in simulation mode</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    src _source = src::UNDEF;</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    <span class="keywordtype">bool</span> _can_source[6] = { <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span> };</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>                        <span class="comment">// UNDEF, FIXED,  PIN, TOUCH,  POT,  CALC</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>    <span class="comment">// source handling functions (should be overridden in child classes as needed)</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_undef() {}</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_fixed() {}</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pin() {}</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_touch() {}</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pot() {}</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_calc() {}</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_common() {}  <span class="comment">// Runs when setting val from any source, after one of the above</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_source() {}</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>    <a class="code hl_class" href="class_timer.html">Timer</a> timer;  <span class="comment">// Can be used for external purposes</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown device&quot;</span>;</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>    std::string _short_name = <span class="stringliteral">&quot;device&quot;</span>;</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>    sens senstype = sens::none;</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>    <a class="code hl_class" href="class_device.html">Device</a>() = <span class="keyword">delete</span>; <span class="comment">// should always be created with a pin</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>    <span class="comment">// NOTE: should we start in PIN mode?</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>    <a class="code hl_class" href="class_device.html">Device</a>(uint8_t arg_pin) : _pin(arg_pin) {}</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>    <span class="keywordtype">bool</span> can_source(src arg_source) { <span class="keywordflow">return</span> _can_source[<span class="keyword">static_cast&lt;</span>uint8_t<span class="keyword">&gt;</span>(arg_source)]; }</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>    <span class="keywordtype">bool</span> set_source(src arg_source) {</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>        <span class="keywordflow">if</span> (_can_source[<span class="keyword">static_cast&lt;</span>uint8_t<span class="keyword">&gt;</span>(arg_source)]) {</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>            _source = arg_source;</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>            update_source();</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>            sources[<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(senstype)] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(arg_source);</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>        } </div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>    }</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>    <span class="keywordtype">void</span> update() {</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>        <span class="keywordflow">if</span> (!_enabled) <span class="keywordflow">return</span>; <span class="comment">// do nothing if the Device is disabled</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>        <span class="keywordflow">switch</span> (_source) {</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>            <span class="keywordflow">case</span> src::UNDEF:</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>                set_val_from_undef();</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>            <span class="keywordflow">case</span> src::FIXED:</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>                set_val_from_fixed();</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>            <span class="keywordflow">case</span> src::PIN:</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>                set_val_from_pin();</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>            <span class="keywordflow">case</span> src::TOUCH:</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>                set_val_from_touch();</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>            <span class="keywordflow">case</span> src::POT:</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>                set_val_from_pot();</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>            <span class="keywordflow">case</span> src::CALC:</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>                set_val_from_calc();</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>            <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>                <span class="comment">// should never get here</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>                printf(<span class="stringliteral">&quot;invalid Device source: %d\n&quot;</span>, _source);</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>        }</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>        set_val_common();</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>    }</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>    <span class="keywordtype">void</span> attach_pot(<a class="code hl_class" href="class_potentiometer.html">Potentiometer</a> &amp;pot_arg) {</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>        _pot = &amp;pot_arg;</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>    }</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>    <span class="comment">// Setters and getters</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>    <span class="keywordtype">void</span> set_enabled(<span class="keywordtype">bool</span> arg_enable) { _enabled = arg_enable; }</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>    <span class="keywordtype">void</span> set_can_source(src arg_source, <span class="keywordtype">bool</span> is_possible) { _can_source[<span class="keyword">static_cast&lt;</span>uint8_t<span class="keyword">&gt;</span>(arg_source)] = is_possible; }</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>    src source() { <span class="keywordflow">return</span> _source; }</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>    uint8_t pin() { <span class="keywordflow">return</span> _pin; }</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>    <span class="keywordtype">bool</span> enabled() { <span class="keywordflow">return</span> _enabled; }</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>};</div>
</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span> </div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="comment">// Device::Transducer is a base class for any system devices that convert real-world values &lt;--&gt; signals in either direction. It has a &quot;native&quot;</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span><span class="comment">// value which represents the sensed or driven hardware input/output. It also has a &quot;human&quot; value which represents the logical or human-readable</span></div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span><span class="comment">// equivalent value. Adjusting either value will automatically change the other one.</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span><span class="keyword">enum class</span> TransducerDirection : uint8_t {REV, FWD}; <span class="comment">// possible dir values. REV means native sensed value has the opposite polarity of the real world effect (for example, if we sense fewer us per rotation, the engine is going faster)</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> NATIVE_T, <span class="keyword">typename</span> HUMAN_T&gt;</div>
<div class="foldopen" id="foldopen00261" data-start="{" data-end="};">
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno"><a class="line" href="class_transducer.html">  261</a></span><span class="keyword">class </span><a class="code hl_class" href="class_transducer.html">Transducer</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_device.html">Device</a> {</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown transducer&quot;</span>;</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>    std::string _short_name = <span class="stringliteral">&quot;xducer&quot;</span>;</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>    <span class="comment">// Multiplier and adder values to plug in for unit conversion math</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>    NATIVE_T _val_raw;  <span class="comment">// Keep track of the most recent unfiltered and unconstrained native value, for monitoring and diag purposes</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>    <span class="keywordtype">float</span> _m_factor = 1.0;</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>    <span class="keywordtype">float</span> _b_offset = 0.0;</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>    <span class="keywordtype">float</span> _zerovalue = NAN;  <span class="comment">// value to return from to_native conversion when val is zero (needed for speedometer)</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>    <span class="keywordtype">bool</span> _invert = <span class="keyword">false</span>;  <span class="comment">// Flag to indicated if unit conversion math should multiply or divide</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>    TransducerDirection dir = TransducerDirection::FWD; <span class="comment">// NOTE: whats ts for, exactly?</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>    </div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>    <span class="comment">// these linear conversion functions change native values to human and back - overwrite in child classes as needed</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>    <span class="comment">//   _m_factor : is conversion rate in human/native units (in normal noninverted case)</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>    <span class="comment">//   _b_offset : (in human units) is added to result of multiplying native value by _m_factor</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>    <span class="comment">//   _invert : if set true, before multiplying the math will invert the given native value. </span></div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>    <span class="comment">//             intended if native and human are inverse values like time (eg us) and frequency (eg mph, rpm). </span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>    <span class="comment">//             e.g. for native in sec/in and human in ft/minute, then use _m_factor of 60 / 12 = 5 ft/min (per in/sec)</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>    <span class="comment">//   dir : optional mirroring of result around min/max range center point. set to REV if native value increases as human decreases</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>    <span class="comment">// note, to avoid crashes, divide by zero attempts result in return of max value in lieu of infinity</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>    <span class="keyword">virtual</span> HUMAN_T from_native(NATIVE_T arg_val_native) {</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>        <span class="keywordtype">float</span> arg_val_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(arg_val_native); <span class="comment">// convert everything to floats so we don&#39;t introduce rounding errors</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>        <span class="keywordtype">float</span> min_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_native.min());</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>        <span class="keywordtype">float</span> max_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_native.max());</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>        <span class="keywordtype">float</span> ret = -1;</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>        <span class="keywordflow">if</span> (!_invert) {</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>            <span class="keywordflow">if</span> (dir == TransducerDirection::REV) {</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>                ret = min_f + max_f - _b_offset - _m_factor * arg_val_f;  <span class="comment">// Serial.printf(&quot;%lf = %lf + %lf - %lf - %lf * %lf\n&quot;, ret, min_f, max_f, _b_offset, _m_factor, arg_val_f);</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>            }</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>            <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>                ret = _b_offset + _m_factor * arg_val_f; <span class="comment">// Serial.printf(&quot;%lf = %lf + %lf * %lf\n&quot;, ret, _b_offset, _m_factor, arg_val_f);</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>            }</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (std::abs(arg_val_f) &gt; 0.000001) { <span class="comment">// NOTE: isn&#39;t 0.0 a valid value tho?  Soren: Only if the pulley can rotate all the way around in under 1 planck time</span></div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>            <span class="keywordflow">if</span> (dir == TransducerDirection::REV) {</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>                ret = min_f + max_f - _b_offset - _m_factor / arg_val_f;  <span class="comment">// Serial.printf(&quot;%lf = %lf + %lf - %lf - %lf / %lf\n&quot;, ret, min_f, max_f, _b_offset, _m_factor, arg_val_f);</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>            }</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>            <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>                ret = _b_offset + _m_factor / arg_val_f;  <span class="comment">// Serial.printf(&quot;%lf = %lf + %lf / %lf\n&quot;, ret, _b_offset, _m_factor, arg_val_f);</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>            }</div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>            printf (<span class="stringliteral">&quot;err: from_native conversion div/zero attempt. max=%5.2f, d=%d, i=%d, v=%5.2f, m=%5.2f, b=%5.2f\n&quot;</span>, max_f, dir, _invert, arg_val_f, _m_factor, _b_offset);</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>            ret = max_f;  <span class="comment">// Best return given division would be infinite  // Serial.printf(&quot;%lf = %lf\n&quot;, ret, max_f);</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>        }</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>        <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>HUMAN_T<span class="keyword">&gt;</span>(ret);</div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>    }</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>    <span class="keyword">virtual</span> NATIVE_T to_native(HUMAN_T arg_val_human) {</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>        <span class="keywordtype">float</span> arg_val_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(arg_val_human); <span class="comment">// convert everything to floats so we don&#39;t introduce rounding errors</span></div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>        <span class="keywordtype">float</span> min_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_human.min());</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>        <span class="keywordtype">float</span> max_f = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_human.max());</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>        <span class="keywordtype">float</span> ret = -1;</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>        <span class="keywordflow">if</span> (dir == TransducerDirection::REV) {</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>            arg_val_f = min_f + max_f - arg_val_f;</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>        }</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>        <span class="keywordflow">if</span> (_invert &amp;&amp; std::abs(arg_val_f - _b_offset) &gt; 0.000001) {  <span class="comment">// trying to dodge risk of floating point error comparing near-zero values</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>            ret = _m_factor / (arg_val_f - _b_offset);</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!_invert &amp;&amp; std::abs(_m_factor) &gt; 0.000001) {  <span class="comment">// risk here of floating point error comparing near-zero values</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>            ret = (arg_val_f - _b_offset) / _m_factor;</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!std::isnan(_zerovalue)) {</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>            ret = _zerovalue;</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>            printf (<span class="stringliteral">&quot;err: to_native conversion div/zero attempt. max=%5.2f, d=%d, i=%d, v=%5.2f, m=%5.2f, b=%5.2f\n&quot;</span>, max_f, dir, _invert, arg_val_f, _m_factor, _b_offset);</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>            ret = max_f;  <span class="comment">// Best return given division would be infinite</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>        }</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>        <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>NATIVE_T<span class="keyword">&gt;</span>(ret);</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>    }</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span> </div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>    <span class="comment">// NOTE: do we really need two values? or should this just be a single value and get converted wherever needed?</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>    <span class="comment">// To hold val/min/max display values in display units (like V, mph, etc.)</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>    <a class="code hl_class" href="class_param.html">Param&lt;HUMAN_T&gt;</a> _human;</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>    <a class="code hl_class" href="class_param.html">Param&lt;NATIVE_T&gt;</a> _native;</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>    </div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>    <span class="comment">// override these in children that need to react to limits changing</span></div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_native_limits() {}</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_human_limits() {}</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>    <a class="code hl_class" href="class_transducer.html">Transducer</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_device.html">Device</a>(arg_pin) {}</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>    <a class="code hl_class" href="class_transducer.html">Transducer</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span> </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>    <span class="keywordtype">void</span> set_native_limits(<a class="code hl_class" href="class_param.html">Param&lt;NATIVE_T&gt;</a> &amp;arg_min, <a class="code hl_class" href="class_param.html">Param&lt;NATIVE_T&gt;</a> &amp;arg_max) {</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>        <span class="keywordflow">if</span> (arg_min.val() &gt; arg_max.val()) {</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>            dir = TransducerDirection::REV;</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>            _native.set_limits(arg_max.val(), arg_min.val());</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>        }</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>            dir = TransducerDirection::FWD;</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>            _native.set_limits(arg_min.val(), arg_max.val());</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>        }</div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>        update_native_limits();</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span> </div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>    }</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>    <span class="keywordtype">void</span> set_human_limits(<a class="code hl_class" href="class_param.html">Param&lt;HUMAN_T&gt;</a> &amp;arg_min, <a class="code hl_class" href="class_param.html">Param&lt;HUMAN_T&gt;</a> &amp;arg_max) {</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>        <span class="keywordflow">if</span> (arg_min.val() &gt; arg_max.val()) {</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>            dir = TransducerDirection::REV;</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>            _human.set_limits(arg_max.val(), arg_min.val());</div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>        }</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>            dir = TransducerDirection::FWD;</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>            _human.set_limits(arg_min.val(), arg_max.val());</div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>        }</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>        update_human_limits();</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>    }</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>    <span class="keywordtype">void</span> set_native_limits(NATIVE_T arg_min, NATIVE_T arg_max) {</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>        <span class="keywordflow">if</span> (arg_min &gt; arg_max) {</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>            dir = TransducerDirection::REV;</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>            _native.set_limits(arg_max, arg_min);</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>        }</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>            dir = TransducerDirection::FWD;</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>            _native.set_limits(arg_min, arg_max);</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>        }</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>        update_native_limits();</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>        <span class="comment">// Need to set human limits here.</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>        <span class="comment">// HUMAN_T human_min = from_native(_native.min());</span></div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>        <span class="comment">// HUMAN_T human_max = from_native(_native.max());</span></div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>    }</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>    <span class="keywordtype">void</span> set_human_limits(HUMAN_T arg_min, HUMAN_T arg_max) {</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>        <span class="keywordflow">if</span> (arg_min &gt; arg_max) {</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>            dir = TransducerDirection::REV;</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>            _human.set_limits(arg_max, arg_min);</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>        }</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>            dir = TransducerDirection::FWD;</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>            _human.set_limits(arg_min, arg_max);</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>        }</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>        update_human_limits();</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>        <span class="comment">// need to set native limits here</span></div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>        <span class="comment">// _human.set_native_limits(from_human(_human.min()), from_human(_human.max()));</span></div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span> </div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>    }</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span> </div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>    <span class="keywordtype">bool</span> set_native(NATIVE_T arg_val_native) {</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>        _val_raw = arg_val_native;</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>        <span class="keywordflow">if</span> (_native.set(arg_val_native)) {</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>            _human.set(from_native(_native.val()));</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>        }</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>    }</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>    <span class="keywordtype">bool</span> add_native(NATIVE_T arg_add_native) {</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>        _val_raw += arg_add_native;</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>        <span class="keywordflow">if</span> (_native.add(arg_add_native)) {</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>            _human.set(from_native(_native.val()));</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>        }</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>    }</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>    <span class="keywordtype">bool</span> set_human(HUMAN_T arg_val_human) {</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>        _val_raw = to_native(arg_val_human);</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>        <span class="keywordflow">if</span> (_human.set(arg_val_human)) {</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>            _native.set(to_native(_human.val()));</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>        }</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>    }</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>    <span class="keywordtype">bool</span> add_human(HUMAN_T arg_add_human) {</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>        HUMAN_T delta = (HUMAN_T)(arg_add_human * tuning_rate_pcps * loop_avg_us * (max_human() - min_human()) / (100.0 * 1000000));</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>        _val_raw += to_native(delta);</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>        <span class="keywordflow">if</span> (_human.add(delta)) {</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>            _native.set(to_native(_human.val()));</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>        }</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>    }</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span> </div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>    <span class="comment">// Convert units from base numerical value to disp units:  val_native = m-factor*val_numeric + offset  -or-  val_native = m-factor/val_numeric + offset  where m-factor, b-offset, invert are set here</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>    <span class="keywordtype">void</span> set_convert(<span class="keywordtype">float</span> arg_m_factor, <span class="keywordtype">float</span> arg_b_offset, <span class="keywordtype">bool</span> arg_invert) {</div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>        _m_factor = arg_m_factor;</div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>        _b_offset = arg_b_offset;</div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>        _invert = arg_invert;</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>    }</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>    <span class="comment">// Getter functions</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>    NATIVE_T native() { <span class="keywordflow">return</span> _native.val(); }</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>    HUMAN_T human() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>    <span class="keywordtype">float</span> percent() { <span class="keywordflow">return</span> map(_human.val(), _human.min, _human.max, 0.0, 100.0); }</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>    NATIVE_T raw() { <span class="keywordflow">return</span> _val_raw; }  <span class="comment">// This is a native unit value, unconstrained and unfiltered</span></div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>    NATIVE_T min_native() { <span class="keywordflow">return</span> _native.min(); }</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>    NATIVE_T max_native() { <span class="keywordflow">return</span> _native.max(); }</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>    HUMAN_T min_human() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>    HUMAN_T max_human() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>    HUMAN_T* min_human_ptr() { <span class="keywordflow">return</span> _human.min_ptr(); }</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>    HUMAN_T* max_human_ptr() { <span class="keywordflow">return</span> _human.max_ptr(); }</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>    NATIVE_T* native_ptr() { <span class="keywordflow">return</span> _native.ptr(); }</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>    HUMAN_T* human_ptr() { <span class="keywordflow">return</span> _human.ptr(); }</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>    std::shared_ptr&lt;NATIVE_T&gt; native_shptr() { <span class="keywordflow">return</span> _native.shptr(); }</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>    std::shared_ptr&lt;HUMAN_T&gt; human_shptr() { <span class="keywordflow">return</span> _human.shptr(); }</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>};</div>
</div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span> </div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span><span class="comment">// Sensor class - is a base class for control system sensors, ie anything that measures real world data or electrical signals </span></div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> NATIVE_T, <span class="keyword">typename</span> HUMAN_T&gt;</div>
<div class="foldopen" id="foldopen00451" data-start="{" data-end="};">
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno"><a class="line" href="class_sensor.html">  451</a></span><span class="keyword">class </span><a class="code hl_class" href="class_sensor.html">Sensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_transducer.html">Transducer</a>&lt;NATIVE_T, HUMAN_T&gt; {</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown sensor&quot;</span>;</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>    std::string _short_name = <span class="stringliteral">&quot;sensor&quot;</span>;</div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>    <span class="keywordtype">float</span> _ema_alpha = 0.1;</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>    <a class="code hl_class" href="class_param.html">Param&lt;HUMAN_T&gt;</a> _val_filt;</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>    <span class="keywordtype">bool</span> _should_filter = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span> </div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>    <span class="keywordtype">void</span> calculate_ema() { <span class="comment">// Exponential Moving Average</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>        <span class="keywordflow">if</span> (_should_filter) {</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>            <span class="keywordtype">float</span> cur_val = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(this-&gt;_human.val());</div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>            <span class="keywordtype">float</span> filt_val = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_val_filt.val());</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>            _val_filt.set(ema_filt(cur_val, filt_val, _ema_alpha));</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>            _val_filt.set(this-&gt;_human.val());</div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>            <span class="comment">// _should_filter = true;  // soren: I commented this out, wouldn&#39;t this always turn on filtering?</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>        }</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>    }</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span> </div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_touch() {</div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>        this-&gt;_val_filt.set(this-&gt;_human.val());</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>    }</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pot() {</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>        this-&gt;_human.set(this-&gt;_pot-&gt;mapToRange(this-&gt;_human.min(), this-&gt;_human.max()));</div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>        this-&gt;_val_raw = this-&gt;_native.val();  <span class="comment">// Arguably pot should set the raw value and let the filter work normally, instead of this</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>        this-&gt;_val_filt.set(this-&gt;_human.val()); <span class="comment">// don&#39;t filter the value we get from the pot, the pot output is already filtered</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>    }</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span> </div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_human_limits() { _val_filt.set_limits(this-&gt;_human.min_shptr(), this-&gt;_human.max_shptr()); } <span class="comment">// make sure our filtered value has the same limits as our regular value</span></div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_source() { <span class="keywordflow">if</span> (this-&gt;_source == src::PIN) _should_filter = <span class="keyword">false</span>; } <span class="comment">// if we just switched to pin input, the old filtered value is not valid</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span> </div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>    <a class="code hl_class" href="class_sensor.html">Sensor</a>(uint8_t pin) : <a class="code hl_class" href="class_transducer.html">Transducer&lt;NATIVE_T, HUMAN_T&gt;</a>(pin) {}  </div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>    <span class="keywordtype">void</span> set_ema_alpha(<span class="keywordtype">float</span> arg_alpha) { _ema_alpha = arg_alpha; }</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>    <span class="keywordtype">float</span> ema_alpha() { <span class="keywordflow">return</span> _ema_alpha; }</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>    HUMAN_T filt() { <span class="keywordflow">return</span> _val_filt.val(); }</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>    HUMAN_T* filt_ptr() { <span class="keywordflow">return</span> _val_filt.ptr(); }</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>    std::shared_ptr&lt;HUMAN_T&gt; filt_shptr() { <span class="keywordflow">return</span> _val_filt.shptr(); } <span class="comment">// NOTE: should just be public?</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>};</div>
</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span> </div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span><span class="comment">// Base class for sensors which communicate using i2c.</span></div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span><span class="comment">// NOTE: this is a strange type of Sensor, it&#39;s not really a Transducer but it does do filtering. maybe we should rethink the hierarchy a little?</span></div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span><span class="comment">//       I think we can move Param to common.h and add a class ExponentialMovingAverage there as well that just has the ema functionality, then make</span></div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="comment">//       I2CSensor a child of -&gt; Device, ExponentialMovingAverage and not a Sensor at all.</span></div>
<div class="foldopen" id="foldopen00496" data-start="{" data-end="};">
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno"><a class="line" href="class_i2_c_sensor.html">  496</a></span><span class="keyword">class </span><a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_sensor.html">Sensor</a>&lt;float,float&gt; {</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>    <span class="keywordtype">bool</span> _detected = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>    <a class="code hl_class" href="class_i2_c.html">I2C</a>* _i2c;</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span> </div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>    <span class="comment">// implement in child classes using the appropriate i2c sensor</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>    <span class="keyword">virtual</span> <span class="keywordtype">float</span> read_sensor() = 0;</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pin() {</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>        this-&gt;set_native(read_sensor());</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>        calculate_ema();  <span class="comment">// Sensor EMA filter</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>    }</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span> </div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pot() {</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>        this-&gt;_human.set(this-&gt;_pot-&gt;mapToRange(this-&gt;_human.min(), this-&gt;_human.max()));</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>        this-&gt;_val_raw = this-&gt;_native.val();</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>        this-&gt;_val_filt.set(this-&gt;_human.val()); <span class="comment">// don&#39;t filter the value we get from the pot, the pot output is already filtered</span></div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>    }</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span> </div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> update_human_limits() {</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>        _native.set_limits(_human.min_shptr(), _human.max_shptr());  <span class="comment">// Our two i2c sensors (airvelo &amp; MAP) don&#39;t reveal low-level readings, so we only get human units</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>        _val_filt.set_limits(_human.min_shptr(), _human.max_shptr());</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>    }</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span>    uint8_t addr;</div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>    <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a>(<a class="code hl_class" href="class_i2_c.html">I2C</a>* i2c_arg, uint8_t i2c_address_arg) : <a class="code hl_class" href="class_sensor.html">Sensor&lt;float,float&gt;</a>(-1), _i2c(i2c_arg), addr(i2c_address_arg) { set_can_source(src::PIN, <span class="keyword">true</span>); }</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>    <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown I2C device&quot;</span>;</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>    std::string _short_name = <span class="stringliteral">&quot;i2cdev&quot;</span>;</div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>        _detected = _i2c-&gt;detected_by_addr(addr);</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>        set_source(src::PIN); <span class="comment">// we aren&#39;t actually reading from a pin but the point is the same...</span></div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>    }</div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>};</div>
</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span> </div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span><span class="comment">// AirVeloSensor measures the air intake into the engine in MPH. It communicates with the external sensor using i2c.</span></div>
<div class="foldopen" id="foldopen00531" data-start="{" data-end="};">
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno"><a class="line" href="class_air_velo_sensor.html">  531</a></span><span class="keyword">class </span><a class="code hl_class" href="class_air_velo_sensor.html">AirVeloSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a> {</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>    <span class="comment">// NOTE: would all AirVeloSensors have the same address? how does this get determined?</span></div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>    <span class="keywordtype">float</span> _min_mph = 0.0;</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>    <span class="keywordtype">float</span> _abs_max_mph = 33.55; <span class="comment">// Sensor maximum mph reading.  Our sensor mounted in 2-in ID intake tube</span></div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>    <span class="keywordtype">float</span> _op_max_mph = 28.5;  <span class="comment">// 620/2 cm3/rot * 5000 rot/min (max) * 60 min/hr * 1/(pi * ((2 * 2.54) / 2)^2) 1/cm2 * 1/160934 mi/cm = 28.5 mi/hr (mph)            // 620/2 cm3/rot * 5000 rot/min (max) * 60 min/hr * 1/(pi * (2.85 / 2)^2) 1/cm2 * 1/160934 mi/cm = 90.58 mi/hr (mph) (?!)  </span></div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>    <span class="keywordtype">float</span> _initial_airvelo_mph = 0.0;</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>    FS3000 _sensor;</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>    <span class="keywordtype">float</span> goodreading = NAN;</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>    int64_t airvelo_read_period_us = 35000;</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>    <a class="code hl_class" href="class_timer.html">Timer</a> airveloTimer;</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>    <span class="keyword">virtual</span> <span class="keywordtype">float</span> read_sensor() {</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>        <span class="keywordflow">if</span> (!_i2c-&gt;detected(i2c_airvelo)) <span class="keywordflow">return</span> NAN;</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_i2c-&gt;not_my_turn(i2c_airvelo)) <span class="keywordflow">return</span> goodreading;</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (airveloTimer.expireset()) goodreading = _sensor.readMilesPerHour();  <span class="comment">// note, this returns a float from 0-33.55 for the FS3000-1015 </span></div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>        <span class="keywordflow">return</span> goodreading;</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>    }</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>    <span class="keyword">static</span> <span class="keyword">constexpr</span> uint8_t addr = 0x28;</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>    sens senstype = sens::airvelo;</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>    <a class="code hl_class" href="class_air_velo_sensor.html">AirVeloSensor</a>(<a class="code hl_class" href="class_i2_c.html">I2C</a>* i2c_arg) : <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a>(i2c_arg, addr) {</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>        _ema_alpha = 0.2;</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>        set_human_limits(_min_mph, _abs_max_mph);</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>        set_human(_initial_airvelo_mph);</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>        set_can_source(src::POT, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>        airveloTimer.set(airvelo_read_period_us);</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>    }</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>    <a class="code hl_class" href="class_air_velo_sensor.html">AirVeloSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>    std::string _long_name = <span class="stringliteral">&quot;Air velocity sensor&quot;</span>;</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>    std::string _short_name = <span class="stringliteral">&quot;airvel&quot;</span>;</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>    std::string _native_units_name = <span class="stringliteral">&quot;mph&quot;</span>;</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>    std::string _human_units_name = <span class="stringliteral">&quot;mph&quot;</span>;</div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span> </div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_common() {</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>        <span class="keywordflow">if</span> (_i2c-&gt;i2cbaton == i2c_airvelo) _i2c-&gt;pass_i2c_baton();</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>    }</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>        _m_factor = 1.0;</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>        _b_offset = 0.0;</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>        printf(<span class="stringliteral">&quot;%s..&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>        I2CSensor::setup();</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>        printf(<span class="stringliteral">&quot; %sdetected&quot;</span>, _detected ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;not &quot;</span>);</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>        <span class="keywordflow">if</span> (_detected) {</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>            <span class="keywordflow">if</span> (_sensor.begin() == <span class="keyword">false</span>) {</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>                printf(<span class="stringliteral">&quot;, not responding\n&quot;</span>);  <span class="comment">// Begin communication with air flow sensor) over I2C </span></div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>                set_source(src::FIXED); <span class="comment">// sensor is detected but not working, leave it in an error state (&#39;fixed&#39; as in not changing)</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>                _sensor.setRange(AIRFLOW_RANGE_15_MPS);</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>                printf (<span class="stringliteral">&quot; and responding properly\n&quot;</span>);</div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>            }</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>            printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>            set_source(src::UNDEF); <span class="comment">// don&#39;t even have a device at all...</span></div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>        }</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>    }</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>    <span class="comment">// Getter functions</span></div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>    <span class="keywordtype">float</span> min_mph() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>    <span class="keywordtype">float</span> max_mph() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>    <span class="keywordtype">float</span> abs_max_mph() { <span class="keywordflow">return</span> _abs_max_mph; }</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>    <span class="keywordtype">float</span>* max_mph_ptr() { <span class="keywordflow">return</span> _human.max_ptr(); }</div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>    std::shared_ptr&lt;float&gt; max_mph_shptr() { <span class="keywordflow">return</span> _human.max_shptr(); }</div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>};</div>
</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span> </div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span><span class="comment">// MAPSensor measures the air pressure of the engine manifold in PSI. It communicates with the external sensor using i2c.</span></div>
<div class="foldopen" id="foldopen00595" data-start="{" data-end="};">
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno"><a class="line" href="class_m_a_p_sensor.html">  595</a></span><span class="keyword">class </span><a class="code hl_class" href="class_m_a_p_sensor.html">MAPSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a> {</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>    <span class="comment">// NOTE: would all MAPSensors have the same address? how does this get determined?</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>    <span class="keywordtype">float</span> _abs_min_atm = 0.06;  <span class="comment">// Sensor min</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>    <span class="keywordtype">float</span> _abs_max_atm = 2.46;  <span class="comment">// Sensor max</span></div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>    <span class="keywordtype">float</span> _op_min_atm = 0.68;  <span class="comment">// Typical low map for a car is 10.8 psi = 22 inHg, 1 psi = 0.068 atm</span></div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>    <span class="keywordtype">float</span> _op_max_atm = 1.02;</div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>    <span class="keywordtype">float</span> _initial_atm = 1.00;  <span class="comment">// 1 atm = 14.6959 psi</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>    <a class="code hl_class" href="class_timer.html">Timer</a> map_read_timer;</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>    uint32_t map_read_timeout = 100000, map_retry_timeout = 10000;</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>    <span class="keywordtype">float</span> goodreading = NAN;</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>    <a class="code hl_class" href="class_spark_fun___micro_pressure.html">SparkFun_MicroPressure</a> _sensor;</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>    <span class="keyword">virtual</span> <span class="keywordtype">float</span> read_sensor() {</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>        <span class="keywordflow">if</span> (!_i2c-&gt;detected(i2c_map)) <span class="keywordflow">return</span> NAN;</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_i2c-&gt;not_my_turn(i2c_map)) <span class="keywordflow">return</span> goodreading;</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (map_read_timer.expired()) {</div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>            <span class="keywordtype">float</span> temp = _sensor.readPressure(ATM, <span class="keyword">true</span>);  <span class="comment">// _sensor.readPressure(PSI);  // &lt;- blocking version takes 6.5ms to read</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>            <span class="keywordflow">if</span> (!std::isnan(temp)) {</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>                goodreading = temp;</div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>                map_read_timer.set(map_read_timeout);</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>            }</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>            <span class="keywordflow">else</span> map_read_timer.set(map_retry_timeout);</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>            <span class="comment">// Serial.printf(&quot;av:%f\n&quot;, goodreading);</span></div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>            <span class="comment">// this-&gt;_val_raw = this-&gt;human_val();  // (NATIVE_T)goodreading; // note, this returns a float from 0-33.55 for the FS3000-1015             </span></div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>        }</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>        <span class="keywordflow">return</span> goodreading;</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>    }</div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>    <span class="keyword">static</span> <span class="keyword">constexpr</span> uint8_t addr = 0x18;</div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>    sens senstype = sens::mapsens;</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>    <a class="code hl_class" href="class_m_a_p_sensor.html">MAPSensor</a>(<a class="code hl_class" href="class_i2_c.html">I2C</a>* i2c_arg) : <a class="code hl_class" href="class_i2_c_sensor.html">I2CSensor</a>(i2c_arg, addr) {</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>        _ema_alpha = 0.2;</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>        set_human_limits(_abs_min_atm, _abs_max_atm);</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>        set_human(_initial_atm);</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>        set_can_source(src::POT, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>        map_read_timer.set(map_read_timeout);</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>    }</div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>    <a class="code hl_class" href="class_m_a_p_sensor.html">MAPSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>    std::string _long_name = <span class="stringliteral">&quot;Manifold Air Pressure sensor&quot;</span>;</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>    std::string _short_name = <span class="stringliteral">&quot;map&quot;</span>;</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>    std::string _native_units_name = <span class="stringliteral">&quot;atm&quot;</span>;</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>    std::string _human_units_name = <span class="stringliteral">&quot;atm&quot;</span>;</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span> </div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_common() {</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>        <span class="keywordflow">if</span> (_i2c-&gt;i2cbaton == i2c_map) _i2c-&gt;pass_i2c_baton();</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>    }</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>        _m_factor = 1.0;</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>        _b_offset = 0.0;</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>        printf(<span class="stringliteral">&quot;%s..&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>        I2CSensor::setup();</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>        printf(<span class="stringliteral">&quot; %sdetected&quot;</span>, _detected ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;not &quot;</span>);</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>        <span class="keywordflow">if</span> (_detected) {</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>            <span class="keywordflow">if</span> (_sensor.begin() == <span class="keyword">false</span>) {</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>                printf(<span class="stringliteral">&quot;, not responding\n&quot;</span>);  <span class="comment">// Begin communication with air flow sensor) over I2C </span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>                set_source(src::FIXED); <span class="comment">// sensor is detected but not working, leave it in an error state (&#39;fixed&#39; as in not changing)</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>                printf(<span class="stringliteral">&quot; and reading %f atm\n&quot;</span>, _sensor.readPressure(ATM));</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>                <span class="comment">// printf(&quot;  Sensor responding properly\n&quot;);</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>            }</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>            printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>            set_source(src::UNDEF); <span class="comment">// don&#39;t even have a device at all...</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>        }</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>    }</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>    <span class="comment">// Getter functions</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>    <span class="keywordtype">float</span> min_atm() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>    <span class="keywordtype">float</span> max_atm() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>    <span class="keywordtype">float</span> abs_min_atm() { <span class="keywordflow">return</span> _abs_min_atm; }</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>    <span class="keywordtype">float</span> abs_max_atm() { <span class="keywordflow">return</span> _abs_max_atm; }</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>    <span class="keywordtype">float</span>* min_atm_ptr() { <span class="keywordflow">return</span> _human.min_ptr(); }</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>    <span class="keywordtype">float</span>* max_atm_ptr() { <span class="keywordflow">return</span> _human.max_ptr(); }</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>    std::shared_ptr&lt;float&gt; min_atm_shptr() { <span class="keywordflow">return</span> _human.min_shptr(); }</div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>    std::shared_ptr&lt;float&gt; max_atm_shptr() { <span class="keywordflow">return</span> _human.max_shptr(); }</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>};</div>
</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span> </div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span><span class="comment">// class AnalogSensor are sensors where the value is based on an ADC reading (eg brake pressure, brake actuator position, pot)</span></div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> NATIVE_T, <span class="keyword">typename</span> HUMAN_T&gt;</div>
<div class="foldopen" id="foldopen00673" data-start="{" data-end="};">
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno"><a class="line" href="class_analog_sensor.html">  673</a></span><span class="keyword">class </span><a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_sensor.html">Sensor</a>&lt;NATIVE_T, HUMAN_T&gt; {</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>    <a class="code hl_class" href="class_timer.html">Timer</a> read_timer{25000};  <span class="comment">// adc cannot read too fast w/o errors, so give some time between readings</span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pin() {</div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>        <span class="keywordflow">if</span> (read_timer.expireset()) {</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>            this-&gt;set_native(<span class="keyword">static_cast&lt;</span>NATIVE_T<span class="keyword">&gt;</span>(analogRead(this-&gt;_pin)));  <span class="comment">// Soren: can this be done without two casts?</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span>            this-&gt;calculate_ema(); <span class="comment">// filtered values are kept in human format</span></div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>        }</div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>    }</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>    <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_sensor.html">Sensor&lt;NATIVE_T, HUMAN_T&gt;</a>(arg_pin) {}</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown analog sensor&quot;</span>;</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>    std::string _short_name = <span class="stringliteral">&quot;analog&quot;</span>;</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>    std::string _native_units_name = <span class="stringliteral">&quot;adc&quot;</span>;</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>    std::string _human_units_name = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span> </div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>        set_pin(this-&gt;_pin, INPUT);</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>        this-&gt;set_source(src::PIN);</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>    }</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>    int32_t adc() { <span class="keywordflow">return</span> this-&gt;_native.val(); }  <span class="comment">// Soren: I created these to be available to any child sensors, but untested and not confident it&#39;s right</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>    int32_t min_adc() { <span class="keywordflow">return</span> this-&gt;_native.min(); }</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>    int32_t max_adc() { <span class="keywordflow">return</span> this-&gt;_native.max(); }</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>};</div>
</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span> </div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span><span class="comment">// CarBattery reads the voltage level from the Mule battery</span></div>
<div class="foldopen" id="foldopen00699" data-start="{" data-end="};">
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno"><a class="line" href="class_car_battery.html">  699</a></span><span class="keyword">class </span><a class="code hl_class" href="class_car_battery.html">CarBattery</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a>&lt;int32_t, float&gt; {</div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>    <span class="comment">// float _initial_adc = adcmidscale_adc;</span></div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>    <span class="keywordtype">float</span> _initial_v = 10.0;</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>    <span class="keywordtype">float</span> _abs_min_v = 0.0; <span class="comment">// The min vehicle voltage we can sense</span></div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>    <span class="keywordtype">float</span> _abs_max_v = 16.0; <span class="comment">// The min vehicle voltage we can sense</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>    <span class="keywordtype">float</span> _op_min_v = 7.0; <span class="comment">// The min vehicle voltage we expect to see</span></div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>    <span class="keywordtype">float</span> _op_max_v = 13.8;  <span class="comment">// The max vehicle voltage we expect to see.</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>    sens senstype = sens::mulebatt;</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>    <a class="code hl_class" href="class_car_battery.html">CarBattery</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor&lt;int32_t, float&gt;</a>(arg_pin) {</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>        _ema_alpha = 0.01;  <span class="comment">// alpha value for ema filtering, lower is more continuous, higher is more responsive (0-1). </span></div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>        _m_factor = _abs_max_v / adcrange_adc;</div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>        _human.set_limits(_abs_min_v, _abs_max_v);</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>        _native.set_limits(0.0, adcrange_adc);</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>        set_human(_initial_v);</div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>    }</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>    <a class="code hl_class" href="class_car_battery.html">CarBattery</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>        AnalogSensor::setup();</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>    }</div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>    <span class="keywordtype">void</span> set_val_from_touch() {</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>        set_human(12.0);</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>    }</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span> </div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>    std::string _long_name = <span class="stringliteral">&quot;Vehicle battery voltage&quot;</span>;</div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>    std::string _short_name = <span class="stringliteral">&quot;mulbat&quot;</span>;</div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>    std::string _native_units_name = <span class="stringliteral">&quot;adc&quot;</span>;</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>    std::string _human_units_name = <span class="stringliteral">&quot;V&quot;</span>;</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span> </div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>    <span class="keywordtype">float</span> v() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>    <span class="keywordtype">float</span> min_v() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>    <span class="keywordtype">float</span> max_v() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>    <span class="keywordtype">float</span> op_min_v() { <span class="keywordflow">return</span> _op_min_v; }</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>    <span class="keywordtype">float</span> op_max_v() { <span class="keywordflow">return</span> _op_max_v; }</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>};</div>
</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span> </div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span><span class="comment">// LiPoBatt reads the voltage level from a LiPo cell</span></div>
<div class="foldopen" id="foldopen00739" data-start="{" data-end="};">
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno"><a class="line" href="class_li_po_batt.html">  739</a></span><span class="keyword">class </span><a class="code hl_class" href="class_li_po_batt.html">LiPoBatt</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a>&lt;int32_t, float&gt; {</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>    <span class="keywordtype">float</span> _initial_adc = adcmidscale_adc;</div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>    <span class="keywordtype">float</span> _initial_v = 10.0;</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>    <span class="keywordtype">float</span> _abs_min_v = 0.0; <span class="comment">// The min lipo voltage we can sense</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>    <span class="keywordtype">float</span> _abs_max_v = 4.8; <span class="comment">// The min lipo voltage we can sense</span></div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>    <span class="keywordtype">float</span> _op_min_v = 3.2; <span class="comment">// The min lipo voltage we expect to see</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>    <span class="keywordtype">float</span> _op_max_v = 4.3;  <span class="comment">// The max lipo voltage we expect to see</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>    sens senstype = sens::none;</div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>    <a class="code hl_class" href="class_li_po_batt.html">LiPoBatt</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor&lt;int32_t, float&gt;</a>(arg_pin) {</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>        _ema_alpha = 0.01;  <span class="comment">// alpha value for ema filtering, lower is more continuous, higher is more responsive (0-1). </span></div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>        _m_factor = _abs_max_v / adcrange_adc;</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>        _human.set_limits(_abs_min_v, _abs_max_v);</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>        _native.set_limits(0.0, adcrange_adc);</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>        set_native(_initial_adc);</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>    }</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>    <a class="code hl_class" href="class_li_po_batt.html">LiPoBatt</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>        AnalogSensor::setup();</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>    }</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>    std::string _long_name = <span class="stringliteral">&quot;LiPo pack voltage &quot;</span>;</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>    std::string _short_name = <span class="stringliteral">&quot;lipo&quot;</span>;</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>    std::string _native_units_name = <span class="stringliteral">&quot;adc&quot;</span>;</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>    std::string _human_units_name = <span class="stringliteral">&quot;V&quot;</span>;</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span> </div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>    <span class="keywordtype">float</span> v() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>    <span class="keywordtype">float</span> min_v() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>    <span class="keywordtype">float</span> max_v() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>    <span class="keywordtype">float</span> op_min_v() { <span class="keywordflow">return</span> _op_min_v; }</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>    <span class="keywordtype">float</span> op_max_v() { <span class="keywordflow">return</span> _op_max_v; }</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>};</div>
</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span><span class="comment">// PressureSensor represents a brake fluid pressure sensor.</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span><span class="comment">// It extends AnalogSensor to handle reading an analog pin</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span><span class="comment">// and converting the ADC value to a pressure value in PSI.</span></div>
<div class="foldopen" id="foldopen00776" data-start="{" data-end="};">
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno"><a class="line" href="class_pressure_sensor.html">  776</a></span><span class="keyword">class </span><a class="code hl_class" href="class_pressure_sensor.html">PressureSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a>&lt;int32_t, float&gt; {</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>    sens senstype = sens::pressure;</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>    int32_t op_min_adc, op_max_adc; <span class="comment">// Sensor reading when brake fully released.  230430 measured 658 adc (0.554V) = no brakes</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>    <span class="comment">// Soren 230920: Reducing max to value even wimpier than Chris&#39; pathetic 2080 adc (~284 psi) brake press, to prevent overtaxing the motor</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>    <span class="keywordtype">float</span> hold_initial_psi, hold_increment_psi, panic_initial_psi, panic_increment_psi, margin_psi;</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>    std::string _long_name = <span class="stringliteral">&quot;Brake pressure sensor&quot;</span>;</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>    std::string _short_name = <span class="stringliteral">&quot;presur&quot;</span>;</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>    std::string _native_units_name = <span class="stringliteral">&quot;adc&quot;</span>;</div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>    std::string _human_units_name = <span class="stringliteral">&quot;psi&quot;</span>;</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span> </div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>    <a class="code hl_class" href="class_pressure_sensor.html">PressureSensor</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor&lt;int32_t, float&gt;</a>(arg_pin) {</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>        _m_factor = 1000.0 * (3.3 - 0.554) / ( (adcrange_adc - op_min_adc) * (4.5 - 0.554) ); <span class="comment">// 1000 psi * (adc_max v - v_min v) / ((4095 adc - 658 adc) * (v-max v - v-min v)) = 0.2 psi/adc </span></div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>        _b_offset = -from_native(op_min_adc);</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>        _invert = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>        _ema_alpha = 0.15;</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>        op_min_adc = 658; <span class="comment">// Sensor reading when brake fully released.  230430 measured 658 adc (0.554V) = no brakes</span></div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>        op_max_adc = 2080; <span class="comment">// ~208psi by this math - &quot;Maximum&quot; braking  // older?  int32_t max_adc = 2080; // ~284psi by this math - Sensor measured maximum reading. (ADC count 0-4095). 230430 measured 2080 adc (1.89V) is as hard as [wimp] chris can push</span></div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>        hold_initial_psi = 120.0;  <span class="comment">// Pressure initially applied when brakes are hit to auto-stop the car (ADC count 0-4095)</span></div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>        hold_increment_psi = 3.0;  <span class="comment">// Incremental pressure added periodically when auto stopping (ADC count 0-4095)</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>        panic_initial_psi = 140.0; <span class="comment">// Pressure initially applied when brakes are hit to auto-stop the car (ADC count 0-4095)</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>        panic_increment_psi = 5.0; <span class="comment">// Incremental pressure added periodically when auto stopping (ADC count 0-4095)</span></div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>        margin_psi = 1;  <span class="comment">// Max acceptible error when checking psi levels</span></div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span> </div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>        set_native_limits(op_min_adc, op_max_adc);</div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>        set_human_limits(from_native(op_min_adc), from_native(op_max_adc));</div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>        set_native(op_min_adc);</div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>        set_can_source(src::POT, <span class="keyword">true</span>);            </div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>    }</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>    <a class="code hl_class" href="class_pressure_sensor.html">PressureSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>        AnalogSensor::setup();</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>    }</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>    <span class="keywordtype">float</span> psi() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>    <span class="keywordtype">float</span> min_psi() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>    <span class="keywordtype">float</span> max_psi() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>    <span class="keywordtype">float</span> op_min() { <span class="keywordflow">return</span> from_native(op_min_adc); }</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>    <span class="keywordtype">float</span> op_max() { <span class="keywordflow">return</span> from_native(op_max_adc); }</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>};</div>
</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span><span class="comment">// BrakePositionSensor represents a linear position sensor</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span><span class="comment">// for measuring brake position (TODO which position? pad? pedal?)</span></div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span><span class="comment">// Extends AnalogSensor for handling analog pin reading and conversion.</span></div>
<div class="foldopen" id="foldopen00820" data-start="{" data-end="};">
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno"><a class="line" href="class_brake_position_sensor.html">  820</a></span><span class="keyword">class </span><a class="code hl_class" href="class_brake_position_sensor.html">BrakePositionSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor</a>&lt;int32_t, float&gt; {</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>    <span class="comment">// TODO: add description</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>    <span class="comment">// std::shared_ptr&lt;float&gt; _zeropoint;</span></div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>    <span class="comment">// void set_val_from_touch() { _val_filt.set((op_min_retract_in + *_zeropoint) / 2); } // To keep brake position in legal range during simulation</span></div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>    sens senstype = sens::brkpos;</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>    int32_t abs_min_retract_adc, abs_max_extend_adc, op_min_retract_adc, op_max_extend_adc;</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>    <span class="keywordtype">float</span> op_min_retract_in, op_max_extend_in, _parkpos, _margin, _zeropoint, abs_min_retract_in, abs_max_extend_in;</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>    std::string _long_name = <span class="stringliteral">&quot;Brake position sensor&quot;</span>;</div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>    std::string _short_name = <span class="stringliteral">&quot;brkpos&quot;</span>;</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>    std::string _native_units_name = <span class="stringliteral">&quot;adc&quot;</span>;</div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>    std::string _human_units_name = <span class="stringliteral">&quot;in&quot;</span>;</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span> </div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>    <a class="code hl_class" href="class_brake_position_sensor.html">BrakePositionSensor</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_analog_sensor.html">AnalogSensor&lt;int32_t, float&gt;</a>(arg_pin) {</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>        _m_factor = 3.3 * 10000.0 / (3.3 * adcrange_adc * 557); <span class="comment">// 3.3 v * 10k ohm * 1/5 1/v * 1/4095 1/adc * 1/557 in/ohm = 0.0029 in/adc</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>        _invert = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>        _b_offset = 0.0;</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>        _ema_alpha = 0.35;</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>        _zeropoint = 3.179;  <span class="comment">// TUNED 230602 - Brake position value corresponding to the point where fluid PSI hits zero (in)</span></div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>        _margin = .01;  <span class="comment">// TODO: add description</span></div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>        _parkpos = 4.234;  <span class="comment">// TUNED 230602 - Best position to park the actuator out of the way so we can use the pedal (in)</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>        op_min_retract_adc = 76;  <span class="comment">// Calculated on windows calculator. Calculate it here, silly</span></div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>        op_max_extend_adc = 965;  <span class="comment">// Calculated on windows calculator. Calculate it here, silly</span></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>        abs_min_retract_adc = 0;</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>        abs_max_extend_adc = adcrange_adc;</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span>        abs_min_retract_in = 0.335;  <span class="comment">// TUNED 230602 - Retract value corresponding with the absolute minimum retract actuator is capable of. (&quot;in&quot;sandths of an inch)</span></div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>        abs_max_extend_in = 8.300;  <span class="comment">// TUNED 230602 - Extend value corresponding with the absolute max extension actuator is capable of. (in)</span></div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>        op_min_retract_in = 0.506;  <span class="comment">// Retract limit during nominal operation. Brake motor is prevented from pushing past this. (in)</span></div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>        op_max_extend_in = _parkpos; <span class="comment">// 4.624;  // TUNED 230602 - Extend limit during nominal operation. Brake motor is prevented from pushing past this. (in)</span></div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>        set_human_limits(op_min_retract_in, op_max_extend_in);            </div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span>        set_native_limits(op_min_retract_adc, op_max_extend_adc);</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>        set_can_source(src::POT, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>    }</div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>    <a class="code hl_class" href="class_brake_position_sensor.html">BrakePositionSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>        AnalogSensor::setup();</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>    }</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>    <span class="keywordtype">bool</span> parked() { <span class="keywordflow">return</span> (_val_filt.val() &gt;= _parkpos - _margin); }  <span class="comment">// is tha brake motor parked?</span></div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>    <span class="keywordtype">bool</span> released() { <span class="keywordflow">return</span> (_val_filt.val() &gt;= _zeropoint - _margin); }</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>    <span class="keywordtype">float</span> in() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>    <span class="keywordtype">float</span> min_in() { <span class="keywordflow">return</span> _human.min(); }</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>    <span class="keywordtype">float</span> max_in() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>    <span class="keywordtype">float</span> op_min() { <span class="keywordflow">return</span> op_min_retract_in; }</div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>    <span class="keywordtype">float</span> op_max() { <span class="keywordflow">return</span> op_max_extend_in; }</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>    <span class="comment">// float absmin_in() { return abs_min_retract_in; }</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>    <span class="comment">// float absmax_in() { return abs_max_extend_in; }</span></div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>    <span class="keywordtype">float</span> parkpos() { <span class="keywordflow">return</span> _parkpos; }</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>    <span class="keywordtype">float</span> margin() { <span class="keywordflow">return</span> _margin; }</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>    <span class="keywordtype">float</span> zeropoint() { <span class="keywordflow">return</span> _zeropoint; }</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>    <span class="keywordtype">float</span>* zeropoint_ptr() { <span class="keywordflow">return</span> &amp;_zeropoint; }</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span>    <span class="comment">// std::shared_ptr&lt;float&gt; zeropoint_shptr() { return _zeropoint; }</span></div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span>};</div>
</div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span> </div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span><span class="comment">// class PulseSensor are hall-monitor sensors where the value is based on magnetic pulse timing of a rotational Source (eg tachometer, speedometer)</span></div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> HUMAN_T&gt;</div>
<div class="foldopen" id="foldopen00878" data-start="{" data-end="};">
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno"><a class="line" href="class_pulse_sensor.html">  878</a></span><span class="keyword">class </span><a class="code hl_class" href="class_pulse_sensor.html">PulseSensor</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_sensor.html">Sensor</a>&lt;int32_t, HUMAN_T&gt; {</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>    int32_t _stop_timeout_us = 1250000;  <span class="comment">// Time after last magnet pulse when we can assume the engine is stopped (in us)</span></div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>    <a class="code hl_class" href="class_timer.html">Timer</a> _stop_timer;</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>    <span class="keywordtype">bool</span> _negative = <span class="keyword">false</span>, _pin_activity;</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>    <span class="keywordtype">float</span> _stop_thresh;</div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>    <span class="keywordtype">float</span> _last_read_time_us;</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>    int32_t _min_us = 100000.0;  <span class="comment">// default. overwrite in children</span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>    <span class="keyword">volatile</span> int64_t _isr_us = 0;</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>    <span class="keyword">volatile</span> int64_t _isr_timer_start_us = 0;</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>    <span class="keyword">volatile</span> int64_t _isr_timer_read_us = 0;</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>    int32_t _isr_buf_us = 0;</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>    int64_t _delta_abs_min_us; <span class="comment">// must be passed into constructor</span></div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>    <span class="comment">// bool _pin_activity = LOW;  // _invert = true,</span></div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span> </div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>    <span class="comment">// Shadows a hall sensor being triggered by a passing magnet once per pulley turn. The ISR calls</span></div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>    <span class="comment">// esp_timer_get_time() on every pulse to know the time since the previous pulse. I tested this on the bench up</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>    <span class="comment">// to about 0.750 mph which is as fast as I can move the magnet with my hand, and it works.</span></div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>    <span class="comment">// Update: Janky bench test appeared to work up to 11000 rpm.</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>    <span class="keywordtype">void</span> IRAM_ATTR _isr() { <span class="comment">// The isr gets the period of the vehicle pulley rotations.</span></div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>        _isr_timer_read_us = esp_timer_get_time();</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>        int64_t time_us = _isr_timer_read_us - _isr_timer_start_us;</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>        <span class="keywordflow">if</span> (time_us &gt; _delta_abs_min_us) {  <span class="comment">// ignore spurious triggers or bounces</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>            _isr_timer_start_us = _isr_timer_read_us;</div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>            _isr_us = time_us;</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>            _pin_activity = !_pin_activity;</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>        }</div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>    }</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span> </div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_val_from_pin() {</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>        _isr_buf_us = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(_isr_us);  <span class="comment">// Copy delta value (in case another interrupt happens during handling)</span></div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>        _isr_us = 0;  <span class="comment">// Indicates to isr we processed this value</span></div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>        <span class="keywordflow">if</span> (_isr_buf_us &gt;= _min_us) {  <span class="comment">// If a valid rotation has happened since last time, delta will have a value</span></div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>            this-&gt;set_native(_isr_buf_us);</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>            this-&gt;calculate_ema();</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>            _last_read_time_us = _stop_timer.elapsed();</div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>            _stop_timer.reset();</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>        }</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span>        <span class="keywordflow">else</span>; <span class="comment">// TODO: flag an error here, out of range or sensor problem</span></div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span> </div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>        <span class="comment">// NOTE: should be checking filt here maybe?</span></div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>        <span class="keywordflow">if</span> (_stop_timer.expired()) {  <span class="comment">// If time between pulses is long enough an engine can&#39;t run that slow</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>            this-&gt;_human.set(0.0);</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>            this-&gt;_val_filt.set(0.0);</div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>        }        </div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>    }</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span> </div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>    <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor</a>(uint8_t arg_pin, int64_t delta_abs_min_us_arg, <span class="keywordtype">float</span> stop_thresh_arg)</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>      : <a class="code hl_class" href="class_sensor.html">Sensor&lt;int32_t, HUMAN_T&gt;</a>(arg_pin), _stop_timer(_stop_timeout_us), _delta_abs_min_us(delta_abs_min_us_arg), _stop_thresh(stop_thresh_arg) {}</div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>    <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>    std::string _long_name = <span class="stringliteral">&quot;Unknown Hall Effect sensor&quot;</span>;</div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>    std::string _short_name = <span class="stringliteral">&quot;pulsen&quot;</span>;</div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>    std::string _native_units_name = <span class="stringliteral">&quot;us&quot;</span>;</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>    std::string _human_units_name = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span> </div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>        set_pin(this-&gt;_pin, INPUT_PULLUP);</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>        attachInterrupt(digitalPinToInterrupt(this-&gt;_pin), [<span class="keyword">this</span>]{ _isr(); }, _negative ? FALLING : RISING);</div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>        this-&gt;set_source(src::PIN);</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>    }</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>    <span class="keywordtype">bool</span> stopped() { <span class="keywordflow">return</span> this-&gt;_val_filt.val() &lt; _stop_thresh; }  <span class="comment">// Note due to weird float math stuff, can not just check if tach == 0.0</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span>    <span class="keywordtype">float</span> last_read_time() { <span class="keywordflow">return</span> _last_read_time_us; }</div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span> </div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>    int32_t us() { <span class="keywordflow">return</span> this-&gt;_native.val(); }  <span class="comment">// Soren: I created these to be available to any child sensors, but untested and not confident it&#39;s right</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span>    int32_t min_us() { <span class="keywordflow">return</span> this-&gt;_native.min(); }</div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>    int32_t max_us() { <span class="keywordflow">return</span> this-&gt;_native.max(); }</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>};</div>
</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span> </div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span><span class="comment">// Tachometer represents a magnetic pulse measurement of the enginge rotation.</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span><span class="comment">// It extends PulseSensor to handle reading a hall monitor sensor and converting RPU to RPM</span></div>
<div class="foldopen" id="foldopen00949" data-start="{" data-end="};">
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno"><a class="line" href="class_tachometer.html">  949</a></span><span class="keyword">class </span><a class="code hl_class" href="class_tachometer.html">Tachometer</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor</a>&lt;float&gt; {</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span>    int64_t _delta_abs_min_us = 6500;;</div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>    <span class="keywordtype">float</span> _stop_thresh_rpm = 0.2;  <span class="comment">// 6500 us corresponds to about 10000 rpm, which isn&#39;t possible. Use to reject retriggers</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>    <span class="keywordtype">float</span> _abs_max_rpm, _redline_rpm, _initial_rpm;</div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>    int32_t _min_us, _zerovalue, _stop_timeout_us;</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>    sens senstype = sens::tach;</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>    <span class="keywordtype">float</span> _idle_rpm = 600.0, _idle_cold_rpm = 750.0, _idle_hot_rpm = 500.0;</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>    <span class="keywordtype">float</span> _margin, _govern_rpm; </div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span>    <a class="code hl_class" href="class_tachometer.html">Tachometer</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor&lt;float&gt;</a>(arg_pin, _delta_abs_min_us, _stop_thresh_rpm) {</div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>        _abs_max_rpm = 7000.0;  <span class="comment">// Max possible engine rotation speed</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>        _redline_rpm = 5500.0;  <span class="comment">// Max possible engine rotation speed</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>        _min_us = 110000;  <span class="comment">// corresponds to 5500 rpm</span></div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>        _negative = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span>        _invert = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>        _m_factor = 60.0 * 1000000.0;  <span class="comment">// 1 rot/us * 60 sec/min * 1000000 us/sec = 60000000 rot/min (rpm)</span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>        _b_offset = 0.0;</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>        _ema_alpha = 0.015;  <span class="comment">// alpha value for ema filtering, lower is more continuous, higher is more responsive (0-1). </span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span>        _govern_rpm = _redline_rpm;</div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span>        _stop_thresh_rpm = 0.2;</div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>        _margin = 10;</div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span>        _initial_rpm = 50.0;</div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>        _zerovalue = 999999;</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>        _stop_timeout_us = 1250000;</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>        set_human_limits(0.0, _redline_rpm);</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>        set_native_limits(_min_us, _stop_timeout_us);</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>        set_human(_initial_rpm);</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>        set_can_source(src::POT, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>    }</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>    <a class="code hl_class" href="class_tachometer.html">Tachometer</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>        PulseSensor::setup();</div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>    }</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span>    std::string _long_name = <span class="stringliteral">&quot;Tachometer&quot;</span>;</div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>    std::string _short_name = <span class="stringliteral">&quot;tach&quot;</span>;</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>    std::string _native_units_name = <span class="stringliteral">&quot;us&quot;</span>;</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>    std::string _human_units_name = <span class="stringliteral">&quot;rpm&quot;</span>;</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span> </div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>    <span class="comment">// Query/getter functions</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>    <span class="keywordtype">float</span> rpm() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>    <span class="comment">// bool engine_stopped() { return stopped(); }</span></div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span>    <span class="keywordtype">bool</span> engine_stopped() { <span class="keywordflow">return</span> _val_filt.val() &lt; _stop_thresh_rpm ; }  <span class="comment">// Note due to weird float math stuff, can not just check if tach == 0.0</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span>    <span class="keywordtype">float</span> margin_rpm() { <span class="keywordflow">return</span> _margin; }</div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>    <span class="keywordtype">float</span> redline_rpm() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>    <span class="keywordtype">float</span> govern_rpm() { <span class="keywordflow">return</span> _govern_rpm; }</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>    <span class="keywordtype">float</span>* govern_rpm_ptr() { <span class="keywordflow">return</span> &amp;_govern_rpm; }</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>    <span class="keywordtype">float</span> idle_rpm() { <span class="keywordflow">return</span> _idle_rpm; }</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>    <span class="keywordtype">float</span> idle_cold_rpm() { <span class="keywordflow">return</span> _idle_cold_rpm; }</div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>    <span class="keywordtype">float</span> idle_hot_rpm() { <span class="keywordflow">return</span> _idle_hot_rpm; }</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>    <span class="keywordtype">float</span>* idle_rpm_ptr() { <span class="keywordflow">return</span> &amp;_idle_rpm; }</div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>    <span class="keywordtype">void</span> set_idle_rpm(<span class="keywordtype">float</span> newidle) { _idle_rpm = constrain(newidle, _human.min(), _govern_rpm); }</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>    <span class="keywordtype">void</span> set_govern_rpm(<span class="keywordtype">float</span> newgovern) { _govern_rpm = constrain(newgovern, _idle_rpm, _human.max()); }</div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>    <span class="keywordtype">void</span> set_idlecold_rpm(<span class="keywordtype">float</span> newidlecold) { _idle_cold_rpm = constrain(newidlecold, _idle_hot_rpm + 1.0, _human.max()); }</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>    <span class="keywordtype">void</span> set_idlehot_rpm(<span class="keywordtype">float</span> newidlehot) { _idle_hot_rpm = constrain(newidlehot, _human.min(), _idle_cold_rpm - 1.0); }</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>    <span class="keywordtype">float</span> abs_max_rpm() { <span class="keywordflow">return</span> _abs_max_rpm; }</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>    <span class="keywordtype">float</span>* redline_rpm_ptr() { <span class="keywordflow">return</span> _human.max_ptr(); }</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>    std::shared_ptr&lt;float&gt; redline_rpm_shptr() { <span class="keywordflow">return</span> _human.max_shptr(); }</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>    <span class="keywordtype">bool</span>* pin_activity_ptr() { <span class="keywordflow">return</span> &amp;_pin_activity; }</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>};</div>
</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span> </div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span><span class="comment">// Speedometer represents a magnetic pulse measurement of the enginge rotation.</span></div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span><span class="comment">// It extends PulseSensor to handle reading a hall monitor sensor and converting RPU to MPH</span></div>
<div class="foldopen" id="foldopen01014" data-start="{" data-end="};">
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"><a class="line" href="class_speedometer.html"> 1014</a></span><span class="keyword">class </span><a class="code hl_class" href="class_speedometer.html">Speedometer</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor</a>&lt;float&gt; {</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>  <span class="keyword">protected</span>:</div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>    int64_t _delta_abs_min_us; </div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>    <span class="keywordtype">float</span> _stop_thresh_mph, _min_mph, _max_mph, _min_us, _initial_mph, _redline_mph, _govern_mph, _idle_mph, _margin;</div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>    <span class="keywordtype">bool</span> _pin_activity = LOW;</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>    int32_t _zerovalue;</div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>    sens senstype = sens::speedo;</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>    <a class="code hl_class" href="class_speedometer.html">Speedometer</a>(uint8_t arg_pin) : <a class="code hl_class" href="class_pulse_sensor.html">PulseSensor&lt;float&gt;</a>(arg_pin, _delta_abs_min_us, _stop_thresh_mph) {</div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>        _delta_abs_min_us = 4500;  <span class="comment">// 4500 us corresponds to about 40 mph, which isn&#39;t possible. Use to reject retriggers</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>        _min_mph = 0.0;</div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>        _max_mph = 25.0; <span class="comment">// What is max speed car can ever go</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>        _min_us = 119000;  <span class="comment">// corresponds to 25.0 mph</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span>        _initial_mph = 0.0; <span class="comment">// Current speed, raw value converted to mph (in mph)</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>        _redline_mph = 15.0; <span class="comment">// What is our steady state speed at redline? Pulley rotation frequency (in milli-mph)</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>        _ema_alpha = 0.015;  <span class="comment">// alpha value for ema filtering, lower is more continuous, higher is more responsive (0-1). </span></div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>        _invert = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>        <span class="comment">// new math with two magnets on the rear axle:</span></div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>        _m_factor = 1000000.0 * 3600.0 * 20 * M_PI / (2 * 12 * 5280);  <span class="comment">// 1 magnet/us * 1000000 us/sec * 3600 sec/hr * 1/2 whlrot/magnet * 20*pi in/whlrot * 1/12 ft/in * 1/5280 mi/ft = 1785000 mi/hr (mph)    </span></div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>        _b_offset = 0.0;</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span>        _margin = 0.2;</div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>        _stop_thresh_mph = 0.2;  <span class="comment">// Below which the car is considered stopped</span></div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>        _zerovalue = 9999999;</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>        set_human_limits(_min_mph, _redline_mph);</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>        set_native_limits(_min_us, _stop_timeout_us);</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>        set_human(_initial_mph);</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>        set_can_source(src::PIN, <span class="keyword">true</span>);</div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>        set_can_source(src::POT, <span class="keyword">true</span>);</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>    }</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>    <a class="code hl_class" href="class_speedometer.html">Speedometer</a>() = <span class="keyword">delete</span>;</div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>        printf(<span class="stringliteral">&quot;%s..\n&quot;</span>, this-&gt;_long_name.c_str());</div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>        PulseSensor::setup();</div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>    }</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>    std::string _long_name = <span class="stringliteral">&quot;Speedometer&quot;</span>;</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>    std::string _short_name = <span class="stringliteral">&quot;speedo&quot;</span>;</div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>    std::string _native_units_name = <span class="stringliteral">&quot;us&quot;</span>;</div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>    std::string _human_units_name = <span class="stringliteral">&quot;mph&quot;</span>;</div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span> </div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>    <span class="comment">// Query/getter functions</span></div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span>    <span class="keywordtype">float</span> mph() { <span class="keywordflow">return</span> _human.val(); }</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>    <span class="comment">// bool car_stopped() { return stopped(); }</span></div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span>    <span class="keywordtype">bool</span> car_stopped() { <span class="keywordflow">return</span> _val_filt.val() &lt; _stop_thresh_mph ; }  <span class="comment">// Note due to weird float math stuff, can not just check if tach == 0.0</span></div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span>    <span class="keywordtype">float</span> margin_mph() { <span class="keywordflow">return</span> _margin; }</div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>    <span class="keywordtype">float</span> redline_mph() { <span class="keywordflow">return</span> _human.max(); }</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>    <span class="keywordtype">float</span> govern_mph() { <span class="keywordflow">return</span> _govern_mph; }</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span>    <span class="keywordtype">float</span> idle_mph() { <span class="keywordflow">return</span> _idle_mph; }</div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>    <span class="keywordtype">float</span>* idle_mph_ptr() { <span class="keywordflow">return</span> &amp;_idle_mph; }</div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>    <span class="keywordtype">void</span> set_govern_mph(<span class="keywordtype">float</span> newgovern) { _govern_mph = newgovern; }</div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>    <span class="keywordtype">float</span> max_mph() { <span class="keywordflow">return</span> _max_mph; }</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>    <span class="keywordtype">float</span>* redline_mph_ptr() { <span class="keywordflow">return</span> _human.max_ptr(); }</div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>    std::shared_ptr&lt;float&gt; redline_mph_shptr() { <span class="keywordflow">return</span> _human.max_shptr(); }</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>    <span class="keywordtype">bool</span>* pin_activity_ptr() { <span class="keywordflow">return</span> &amp;_pin_activity; }</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>};</div>
</div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span><span class="comment">// NOTE: I implemented the gas servo, but it looks like it&#39;s all in native units. should it still be a transducer?</span></div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span><span class="comment">// ServoPWM is a base class for our type of actuators, where by varying a pulse width (in us), motors move.</span></div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span><span class="comment">//    e.g. the gas, brake and steering motors. The gas motor is an actual servo, the others are controlled with servo signaling via jaguars.</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span><span class="comment">// template&lt;typename NATIVE_T, typename HUMAN_T&gt;</span></div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span><span class="comment">// class ServoPWM : public Transducer&lt;NATIVE_T, HUMAN_T&gt; {</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span><span class="comment">//   protected:</span></div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span><span class="comment">//     Servo _servo;</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span><span class="comment">//     // NOTE: should be marked &#39;override&#39; but compiler says it doesn&#39;t override anything...?</span></div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span><span class="comment">//     void set_native_limits(Param&lt;NATIVE_T&gt; &amp;minParam, Param&lt;NATIVE_T&gt; &amp;maxParam) {</span></div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span><span class="comment">//         this-&gt;set_native_limits(minParam, maxParam);</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span><span class="comment">//         _servo.attach(this-&gt;_pin, this-&gt;min_native-&gt;val(), this-&gt;max_native-&gt;val());</span></div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span><span class="comment">//     void set_human_limits(Param&lt;HUMAN_T&gt; &amp;minParam, Param&lt;HUMAN_T&gt; &amp;maxParam) {</span></div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span><span class="comment">//         this-&gt;set_human_limits(minParam, maxParam);</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span><span class="comment">//         _servo.attach(this-&gt;_pin, this-&gt;min_native-&gt;val(), this-&gt;max_native-&gt;val());</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span><span class="comment">//   public:</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span><span class="comment">//     // ServoPWM(uint8_t pin, uint_t freq) : Transducer&lt;NATIVE_T, HUMAN_T&gt;(pin) {</span></div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span><span class="comment">//     ServoPWM(uint8_t pin, uint8_t freq) : Transducer&lt;NATIVE_T, HUMAN_T&gt;(pin) {</span></div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span><span class="comment">//         _servo.setPeriodHertz(freq);</span></div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span><span class="comment">//         _servo.attach(this-&gt;_pin, this-&gt;_native.min(), this-&gt;_native.max());</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span><span class="comment">//         // _servo.attach(this-&gt;_pin, this-&gt;_native.abs_min(), this-&gt;_native.abs_max());</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">//     ServoPWM() = delete;</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span><span class="comment">//     std::string _long_name = &quot;Unknown PWM motor output&quot;;</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span><span class="comment">//     std::string _short_name = &quot;pwmout&quot;;</span></div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span><span class="comment">//     std::string _native_units_name = &quot;us&quot;;</span></div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span><span class="comment">//     std::string _human_units_name = &quot;&quot;;</span></div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span><span class="comment">//     void setup() {</span></div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span><span class="comment">//         set_pin(this-&gt;_pin, OUTPUT);</span></div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span><span class="comment">//     void write() {</span></div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span><span class="comment">//         this-&gt;_val_raw = this-&gt;_native.val();</span></div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span><span class="comment">//         _servo.writeMicroseconds((int32_t)this-&gt;_val_raw);  // Write result to servo interface</span></div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span><span class="comment">// };</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span><span class="comment">// // Device::Toggle is a base class for system signals or devices having a boolean value</span></div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span><span class="comment">// class Toggle : public Device {</span></div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span><span class="comment">//   public:</span></div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span><span class="comment">//     // NOTE: how should we handle simulatability? I almost think it should be done at a higher level than the device...</span></div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span><span class="comment">//     // NOTE: should use Param here maybe?</span></div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span><span class="comment">//     bool val, val_last, can_sim;</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span><span class="comment">//     Toggle(int32_t arg_pin) : Device(arg_pin){  // std::string&amp; eng_name, </span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span><span class="comment">//         can_sim = true;</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span><span class="comment">// };</span></div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span><span class="comment">// // Device::Toggle::InToggle is system signals or devices having a boolean value that serve as inputs (eg basicsw, cruisesw)</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span><span class="comment">// class InToggle : public Toggle {</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span><span class="comment">//   public:</span></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span><span class="comment">//     InToggle(int32_t arg_pin) : Toggle(arg_pin) {</span></div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span><span class="comment">//         set_can_source(src::PIN, true);</span></div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span><span class="comment">//         _source = src::PIN;</span></div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span><span class="comment">//     void set_val(bool arg_val) {</span></div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span><span class="comment">//         if (_source != src::PIN) {</span></div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span><span class="comment">//             val_last = val;</span></div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span><span class="comment">//             val = arg_val;</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span><span class="comment">//         }</span></div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span><span class="comment">//     void read() {</span></div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="comment">//         val_last = val;</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span><span class="comment">//         val = digitalRead(_pin);</span></div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span><span class="comment">// };</span></div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="comment">// // Device::Toggle::OutToggle is system signals or devices having a boolean value that serve as outputs (eg ignition, leds, etc.)</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span><span class="comment">// class OutToggle : public Toggle {</span></div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span><span class="comment">//   public:</span></div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span><span class="comment">//     OutToggle(int32_t arg_pin) : Toggle(arg_pin) {</span></div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span><span class="comment">//         // NOTE: LIVE is not a valid source, what should this be? Not PIN, we write to that. CALC maybe?</span></div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span><span class="comment">//         // val_source = LIVE;</span></div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span><span class="comment">//     void set_val(bool arg_val) {</span></div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span><span class="comment">//         val_last = val;</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span><span class="comment">//         val = arg_val;</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="comment">//         // if (val_source == LIVE) write();</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="comment">//     void write() {</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span><span class="comment">//         digitalWrite(_pin, val);</span></div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="comment">//     }</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="comment">// };</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span><span class="comment">// NOTE: if devices.h gets to be too long, we can (and maybe just should) move this to a separate file, it&#39;s not really a device...</span></div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span><span class="comment">// Simulator manages the source handling logic for all simulatable components. Currently, components can recieve simulated input from either the touchscreen, or from</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span><span class="comment">// NOTE: this class is designed to be backwards-compatible with existing code, which does everything with global booleans. if/when we switch all our Devices to use sources,</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="comment">//       we can simplify the logic here a lot.</span></div>
<div class="foldopen" id="foldopen01152" data-start="{" data-end="};">
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"><a class="line" href="class_simulator.html"> 1152</a></span><span class="keyword">class </span><a class="code hl_class" href="class_simulator.html">Simulator</a> {</div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span>    <span class="comment">// NOTE: if we only simulated devices, we could keep track of simulability in the Device class. We could keep the default source in Device the same way.</span></div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>    <span class="comment">// 3-tuple for a given component, keeping track of simulability status (whether this component is allowed to be simulated), an associated Device (a pointer to the actual component),</span></div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>    <span class="comment">// and a default source (the mode we would like the component to switch back to when it stops being simulated)</span></div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span>    <span class="keyword">typedef</span> std::tuple&lt;bool, Device*, src&gt; simulable_t;</div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>    std::map&lt;sens, simulable_t&gt; _devices; <span class="comment">// a collection of simulatable components</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span>    <span class="keywordtype">bool</span> _enabled = <span class="keyword">false</span>; <span class="comment">// keep track of whether the simulator is running or not</span></div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span>    sens _potmap; <span class="comment">// keep track of which component is getting info from the pot</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span>    <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>&amp; _pot;</div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>    Preferences* _myprefs;</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>    <a class="code hl_class" href="class_simulator.html">Simulator</a>(<a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>&amp; pot_arg, Preferences* myprefs) : _pot(pot_arg), _myprefs(myprefs) {</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span>        <span class="keywordflow">for</span> (uint8_t sensor = (uint8_t)sens::none + 1; sensor &lt; (uint8_t)sens::NUM_SENSORS; sensor++) set_can_sim((sens)sensor, <span class="keyword">false</span>);   <span class="comment">// initially turn off simulation of sensors  // static constexpr bool initial_sim_joy = false;</span></div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span>        set_potmap(); <span class="comment">// set initial pot map</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>    }  <span class="comment">// syspower, ignition removed, as they are not sensors or even inputs</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span> </div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>    <span class="keywordtype">void</span> updateSimulationStatus(<span class="keywordtype">bool</span> enableSimulation) {</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>        <span class="comment">// If the simulation status hasn&#39;t changed, there&#39;s nothing to do</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>        <span class="keywordflow">if</span> (_enabled == enableSimulation) <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span>        <span class="comment">// Iterate over all devices</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;deviceEntry : _devices) {</div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span>            <span class="keywordtype">bool</span> can_sim = std::get&lt;0&gt;(deviceEntry.second);</div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span>            <span class="comment">// If the device can be simulated and isn&#39;t being mapped from the potentiometer</span></div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>            <span class="keywordflow">if</span> (can_sim &amp;&amp; _potmap != deviceEntry.first) {</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>                <a class="code hl_class" href="class_device.html">Device</a> *d = std::get&lt;1&gt;(deviceEntry.second);</div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>                <span class="comment">// If the device exists</span></div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>                <span class="comment">// NOTE: the nullptr checks here and below exist so that we can work with boolean components as well as Devices, for backwards compatability</span></div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>                <span class="keywordflow">if</span> (d != <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>                    <span class="comment">// If we&#39;re enabling the simulation, set the device&#39;s source to the touchscreen</span></div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>                    <span class="comment">// Otherwise, set it to its default mode</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>                    <span class="keywordflow">if</span> (enableSimulation) {</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>                        d-&gt;set_source(src::TOUCH);</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>                        src default_mode = std::get&lt;2&gt;(deviceEntry.second);</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>                        d-&gt;set_source(default_mode);</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>                    }</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>                }</div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>            }</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>        }</div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>        <span class="comment">// Update the simulation status</span></div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>        _enabled = enableSimulation;</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span>    }</div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span>    <span class="comment">// turn on the simulator. all components which are set to be simulated will switch to simulated input</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>    <span class="keywordtype">void</span> enable() {</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span>        updateSimulationStatus(<span class="keyword">true</span>);</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>    }</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>    <span class="comment">// turn off the simulator. all devices will be set to their default input (if they are not being mapped from the pot)</span></div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>    <span class="keywordtype">void</span> disable() {</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>        updateSimulationStatus(<span class="keyword">false</span>);</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>    }</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>    <span class="keywordtype">void</span> toggle() {</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span>        <span class="keywordflow">return</span> _enabled ? disable() : enable();</div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>    }</div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>    <span class="comment">// check if a componenet is currently being simulated (by either the touchscreen or the pot)</span></div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span>    <span class="keywordtype">bool</span> simulating() { <span class="keywordflow">return</span> _enabled; }  <span class="comment">// equivalent to enabled()  // Maybe include || potmapping() too ?</span></div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>    <span class="keywordtype">bool</span> simulating(sens arg_sensor) {</div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>        <span class="keywordflow">return</span> can_sim(arg_sensor) &amp;&amp; (_enabled || _potmap == arg_sensor);</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>    }</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>    <span class="comment">// associate a Device and a given fall-back source with a sensor</span></div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>    <span class="keywordtype">void</span> register_device(sens arg_sensor, <a class="code hl_class" href="class_device.html">Device</a> &amp;d, src default_mode) {</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>        <span class="keywordtype">bool</span> can_sim = <span class="keyword">false</span>; <span class="comment">// by default, disable simulation for this component</span></div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span>        <span class="keyword">auto</span> kv = _devices.find(arg_sensor); <span class="comment">// look for the component</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>        <span class="keywordflow">if</span> (kv != _devices.end()) {</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>            can_sim = std::get&lt;0&gt;(kv-&gt;second); <span class="comment">// if an entry for the component already existed, preserve its simulatability status</span></div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>            <span class="keywordflow">if</span> (can_sim) { <span class="comment">// if simulability has already been enabled...</span></div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>                <span class="keywordflow">if</span> (arg_sensor == _potmap) { <span class="comment">// ...and the pot is supposed to map to this component...</span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span>                    d.set_source(src::POT); <span class="comment">// ...then set the input source for the associated Device to read from the pot</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_enabled) { <span class="comment">// ...and the pot isn&#39;t mapping to this component, but the simulator is running...</span></div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>                    d.set_source(src::TOUCH); <span class="comment">// ...then set the input source for the associated Device to read from the touchscreen</span></div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span>                }</div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>            }</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>        }</div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>        <span class="keywordflow">if</span> (d.can_source(src::POT)) {</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span>            d.attach_pot(_pot); <span class="comment">// if this device can be mapped from the pot, connect it to pot input</span></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>        }</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>        _devices[arg_sensor] = simulable_t(can_sim, &amp;d, default_mode); <span class="comment">// store info for this component</span></div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>    }</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>    <span class="comment">// check if a component can be simulated (by either the touchscreen or the pot)</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span>    <span class="keywordtype">bool</span> can_sim(sens arg_sensor) {</div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span>        <span class="keyword">auto</span> kv = _devices.find(arg_sensor); <span class="comment">// look for the component</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>        <span class="keywordflow">if</span> (kv != _devices.end()) {</div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>            <span class="keywordflow">return</span> std::get&lt;0&gt;(kv-&gt;second); <span class="comment">// if it exists, check the simulability status</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span>        }</div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// couldn&#39;t find component, so there&#39;s no way we can simulate it</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span>    }</div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>    <span class="keywordtype">bool</span> touchable(sens arg_sensor) {</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>        <span class="keywordflow">return</span> can_sim(arg_sensor) &amp;&amp; (sources[<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(arg_sensor)] == <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(src::TOUCH));</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>    }</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span>    <span class="comment">// set simulatability status for a component</span></div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>    <span class="keywordtype">void</span> set_can_sim(sens arg_sensor, int32_t can_sim) { set_can_sim(arg_sensor, (can_sim &gt; 0)); }  <span class="comment">// allows interpreting -1 as 0, convenient for our tuner etc.</span></div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>    </div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>    <span class="keywordtype">void</span> set_can_sim(sens arg_sensor, <span class="keywordtype">bool</span> can_sim) {</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>        <span class="keyword">auto</span> kv = _devices.find(arg_sensor); <span class="comment">// look for component</span></div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>        <span class="keywordflow">if</span> (kv != _devices.end()) { <span class="comment">// if an entry for this component already exists, check if the new simulatability status is different from the old</span></div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>            <span class="keywordtype">bool</span> old_can_sim = std::get&lt;0&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>            <span class="keywordflow">if</span> (can_sim != old_can_sim) { <span class="comment">// if the simulation status has changed, we need to update the input source for the component</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>                src default_mode = src::UNDEF;</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>                <a class="code hl_class" href="class_device.html">Device</a> *d = std::get&lt;1&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>                <span class="keywordflow">if</span> (d != <span class="keyword">nullptr</span>) { <span class="comment">// if there is no associated Device with this component then input handling is done in the main code</span></div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>                    default_mode = std::get&lt;2&gt;(kv-&gt;second); <span class="comment">// preserve the stored default controller mode</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>                    <span class="keywordflow">if</span> (can_sim) { <span class="comment">// if we just enabled simulatability...</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>                        <span class="keywordflow">if</span> (arg_sensor == _potmap) { <span class="comment">// ...and the pot is supposed to map to this component...</span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>                            d-&gt;set_source(src::POT); <span class="comment">// ...then set the input source for the associated Device to read from the pot</span></div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_enabled) { <span class="comment">// ...and the pot isn&#39;t mapping to this component, but the simulator is running...</span></div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>                            d-&gt;set_source(src::TOUCH); <span class="comment">// ...then set the input source for the associated Device to read from the touchscreen</span></div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>                        }</div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>                        d-&gt;set_source(default_mode); <span class="comment">// we disabled simulation for this component, set it back to its default input source</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>                    }</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>                }</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>                kv-&gt;second = simulable_t(can_sim, d, default_mode); <span class="comment">// update the entry with the new simulatability status</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>            }</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span>            _devices[arg_sensor] = simulable_t(can_sim, <span class="keyword">nullptr</span>, src::UNDEF); <span class="comment">// add a new entry with the simulatability status for this component</span></div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>        }</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>    }</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>    <span class="comment">// set the component to be overridden by the pot (the pot can only override one component at a time)</span></div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>    <span class="keywordtype">void</span> set_potmap(sens arg_sensor) {</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>        <span class="keywordflow">if</span> (arg_sensor != _potmap) { <span class="comment">// if we&#39;re mapping to a different component, we need to reset the input source for the old one</span></div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>            <span class="keyword">auto</span> kv = _devices.find(_potmap);</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>            <span class="keywordflow">if</span> (kv != _devices.end()) {</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>                <a class="code hl_class" href="class_device.html">Device</a> *d = std::get&lt;1&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span>                <span class="keywordflow">if</span> (d != <span class="keyword">nullptr</span>) { <span class="comment">// if we were mapping to a component with an associated Device...</span></div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>                    <span class="keywordtype">bool</span> _can_sim = std::get&lt;0&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>                    <span class="keywordflow">if</span> (_enabled &amp;&amp; _can_sim) { <span class="comment">// ...and the simulator is on, and we&#39;re able to be simulated...</span></div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>                        d-&gt;set_source(src::TOUCH); <span class="comment">// ...then set the input source to the touchscreen</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>                    } <span class="keywordflow">else</span> { <span class="comment">// ...and either the simulator is off or we aren&#39;t allowing simualtion for this component...</span></div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span>                        src default_mode = std::get&lt;2&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span>                        d-&gt;set_source(default_mode); <span class="comment">// then set the input source for the component to its default</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>                    }</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>                } <span class="comment">// ...else this component is a boolean, and input source handling is done elsewhere</span></div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>            }</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>            kv = _devices.find(arg_sensor); <span class="comment">// we need to set the input source of the newly-overridden component</span></div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>            <span class="keywordflow">if</span> (kv != _devices.end()) {</div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>                <a class="code hl_class" href="class_device.html">Device</a> *d = std::get&lt;1&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>                <span class="keywordflow">if</span> (d != <span class="keyword">nullptr</span> ) { <span class="comment">// if  we&#39;re mapping to a component with an associated device, we need to change the input source to the pot</span></div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>                    <span class="keywordflow">if</span> (d-&gt;can_source(src::POT)) { <span class="comment">// ...and we&#39;re allowed to map to this component...</span></div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>                        <span class="keywordtype">bool</span> _can_sim = std::get&lt;0&gt;(kv-&gt;second);</div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>                        <span class="keywordflow">if</span> (_can_sim) { <span class="comment">// if we allow simualation for this componenent...</span></div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>                            d-&gt;set_source(src::POT); <span class="comment">// ...then set its input source to the pot</span></div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span>                        }</div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span>                        printf(<span class="stringliteral">&quot;invalid pot map selected: %d/n&quot;</span>, arg_sensor);</div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>                    }</div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>                }</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span>            }</div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>            _potmap = arg_sensor;</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>            _myprefs-&gt;putUInt(<span class="stringliteral">&quot;potmap&quot;</span>, <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(_potmap));</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>        }</div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>    }</div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>    <span class="keywordtype">void</span> set_potmap() { </div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>        set_potmap(<span class="keyword">static_cast&lt;</span>sens<span class="keyword">&gt;</span>(_myprefs-&gt;getUInt(<span class="stringliteral">&quot;potmap&quot;</span>, <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(sens::none))));</div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>    }</div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span>    <span class="comment">// Getter functions</span></div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span>    <span class="keywordtype">bool</span> potmapping(sens s) { <span class="keywordflow">return</span> can_sim(s) &amp;&amp; _potmap == s; }  <span class="comment">// query if a certain sensor is being potmapped</span></div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>    <span class="keywordtype">bool</span> potmapping(int32_t s) { <span class="keywordflow">return</span> can_sim(<span class="keyword">static_cast&lt;</span>sens<span class="keyword">&gt;</span>(s)) &amp;&amp; (_potmap == <span class="keyword">static_cast&lt;</span>sens<span class="keyword">&gt;</span>(s)); }  <span class="comment">// query if a certain sensor is being potmapped        </span></div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>    <span class="keywordtype">bool</span> potmapping() { <span class="keywordflow">return</span> can_sim(_potmap) &amp;&amp; !(_potmap == sens::none); }  <span class="comment">// query if any sensors are being potmapped</span></div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>    int32_t potmap() { <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(_potmap); }  <span class="comment">// query which sensor is being potmapped</span></div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>    <span class="keywordtype">bool</span> enabled() { <span class="keywordflow">return</span> _enabled; }</div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span>    <span class="keywordtype">bool</span>* enabled_ptr() { <span class="keywordflow">return</span> &amp;_enabled; }</div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>};</div>
</div>
<div class="foldopen" id="foldopen01314" data-start="{" data-end="};">
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"><a class="line" href="class_r_m_t_input.html"> 1314</a></span><span class="keyword">class </span><a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a></div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>{</div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>    <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a>(rmt_channel_t channel, gpio_num_t gpio)</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>    {</div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>        channel_ = channel;</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>        gpio_ = gpio;</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>    }</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>    <span class="keywordtype">void</span> init()</div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>    {</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>        rmt_config_t _config;</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>        _config.channel = channel_;</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>        _config.gpio_num = gpio_;</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>        _config.clk_div = 50; <span class="comment">// slowed from 80 because the buffer was getting full</span></div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>        _config.mem_block_num = 1;</div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>        _config.rmt_mode = RMT_MODE_RX;</div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span>        _config.flags = 0;</div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span>        _config.rx_config.filter_en = <span class="keyword">true</span>;          <span class="comment">// Enable the filter</span></div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span>        _config.rx_config.filter_ticks_thresh = 100; <span class="comment">// Set the filter threshold</span></div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>        _config.rx_config.idle_threshold = 12000;    <span class="comment">// Set the idle threshold</span></div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span> </div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>        esp_err_t config_result = rmt_config(&amp;_config);</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>        <span class="keywordflow">if</span> (config_result != ESP_OK)</div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>        {</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>            Serial.printf(<span class="stringliteral">&quot;Failed to configure RMT: %d\n&quot;</span>, config_result);</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>            <span class="comment">// while (1); // halt execution</span></div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>        }</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>        esp_err_t install_result = rmt_driver_install(channel_, 2000, 0);</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>        <span class="keywordflow">if</span> (install_result != ESP_OK)</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>        {</div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>            Serial.printf(<span class="stringliteral">&quot;Failed to install RMT driver: %d\n&quot;</span>, install_result);</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>            <span class="comment">// while (1); // halt execution</span></div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>        }</div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>        rmt_get_ringbuf_handle(channel_, &amp;rb_);</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span>        <span class="keywordflow">if</span> (rb_ == NULL)</div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>        {</div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>            Serial.println(<span class="stringliteral">&quot;Failed to initialize ring buffer&quot;</span>);</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>            <span class="comment">// while (1); // halt execution</span></div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>        }</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>        esp_err_t start_result = rmt_rx_start(channel_, 1);</div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>        <span class="keywordflow">if</span> (start_result != ESP_OK)</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>        {</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>            Serial.printf(<span class="stringliteral">&quot;Failed to start RMT receiver: %d\n&quot;</span>, start_result);</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>            <span class="comment">// while (1); // halt execution</span></div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span>        }</div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>    }</div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>    int32_t readPulseWidth(<span class="keywordtype">bool</span> persistence)  <span class="comment">// persistence means the last reading will be returned until a newer one is gathered. Otherwise 0 if no reading</span></div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span>    {</div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>        <span class="keywordtype">size_t</span> rx_size = 0;</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>        rmt_item32_t *item = (rmt_item32_t *)xRingbufferReceive(rb_, &amp;rx_size, 0);</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>        <span class="keywordflow">if</span> (item != NULL &amp;&amp; rx_size == <span class="keyword">sizeof</span>(rmt_item32_t))</div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>        {</div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>            pulse_width = item-&gt;duration0 + item-&gt;duration1;</div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span>            vRingbufferReturnItem(rb_, (<span class="keywordtype">void</span> *)item);</div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>            <span class="keywordflow">if</span> (!persistence || pulse_width &gt; 0) pulse_width_last = pulse_width * scale_factor;</div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span>        }</div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>        <span class="keywordflow">else</span> pulse_width = 0;</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>        <span class="keywordflow">return</span> (persistence) ? pulse_width_last : pulse_width; <span class="comment">// No data</span></div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>    }</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>    rmt_channel_t channel_;</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>    gpio_num_t gpio_;</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>    int32_t pulse_width, pulse_width_last;</div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>    <span class="keywordtype">float</span> scale_factor = 0.625;</div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>    RingbufHandle_t rb_;</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>};</div>
</div>
<div class="foldopen" id="foldopen01380" data-start="{" data-end="};">
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"><a class="line" href="class_hotrc.html"> 1380</a></span><span class="keyword">class </span><a class="code hl_class" href="class_hotrc.html">Hotrc</a> {  <span class="comment">// All things Hotrc, in a convenient, easily-digestible format the kids will just love</span></div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>    <span class="keywordtype">float</span> ema_alpha = 0.075;  <span class="comment">// alpha value for ema filtering, lower is more continuous, higher is more responsive (0-1).</span></div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>    <span class="keywordtype">float</span> pc[NUM_AXES][NUM_VALUS];           <span class="comment">// values range from -100% to 100% are all derived or auto-assigned</span></div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span>    int32_t us[NUM_CHANS][NUM_VALUS] = {</div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>        {  971, 1470, 1968, 0, 1500, 0, 0, 0 },     <span class="comment">// 1000-30+1, 1500-30,  2000-30-2   // [HORZ] [OPMIN/CENT/OPMAX/RAW/FILT/DBBOT/DBTOP/MARGIN]</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span>        { 1081, 1580, 2078, 0, 1500, 0, 0, 0 },     <span class="comment">// 1000+80+1, 1500+80,  2000+80-2,  // [VERT] [OPMIN/CENT/OPMAX/RAW/FILT/DBBOT/DBTOP/MARGIN]</span></div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span>        { 1151, 1500, 1848, 0, 1500, 0, 0, 0 },     <span class="comment">// 1000+150+1,   1500, 2000-150-2,  // [CH3] [OPMIN/CENT/OPMAX/RAW/FILT/DBBOT/DBTOP/MARGIN]</span></div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>        { 1251, 1500, 1748, 0, 1500, 0, 0, 0 }, };  <span class="comment">// 1000+250+1,   1500, 2000-250-2,  // [CH4] [OPMIN/CENT/OPMAX/RAW/FILT/DBBOT/DBTOP/MARGIN]</span></div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>    <span class="keywordtype">float</span> ema_us[NUM_AXES] = { 1500.0, 1500.0 };  <span class="comment">// [HORZ/VERT]</span></div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span>    int32_t absmin_us = 880;</div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>    int32_t absmax_us = 2080;</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span>    int32_t deadband_us = 13;  <span class="comment">// All [DBBOT] and [DBTOP] values above are derived from this by calling calc_params()</span></div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>    int32_t margin_us = 20;  <span class="comment">// All [MARGIN] values above are derived from this by calling calc_params()</span></div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span>    int32_t failsafe_us = 880; <span class="comment">// Hotrc must be configured per the instructions: search for &quot;HotRC Setup Procedure&quot;</span></div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span>    int32_t failsafe_margin_us = 100; <span class="comment">// in the carpet dumpster file: https://docs.google.com/document/d/1VsAMAy2v4jEO3QGt3vowFyfUuK1FoZYbwQ3TZ1XJbTA/edit</span></div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span>    int32_t failsafe_pad_us = 10;</div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>    <a class="code hl_class" href="class_simulator.html">Simulator</a>* sim;</div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>    <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>* pot;</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span>    <span class="keyword">static</span> <span class="keyword">const</span> uint32_t failsafe_timeout = 15000;</div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>    <a class="code hl_class" href="class_timer.html">Timer</a> failsafe_timer;  <span class="comment">// How long to receive failsafe pulse value continuously before recognizing radio is lost. To prevent false positives</span></div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>    <span class="keywordtype">bool</span> _radiolost = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span>    <span class="keywordtype">bool</span> sw[NUM_CHANS] = { 1, 1, 0, 0 };  <span class="comment">// index[2]=CH3, index[3]=CH4 and using [0] and [1] indices for LAST values of ch3 and ch4 respectively</span></div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span>    <span class="keywordtype">bool</span> _sw_event[NUM_CHANS];  <span class="comment">// First 2 indices are unused.  What a tragic waste</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span>    <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a> rmt[NUM_CHANS] = {</div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span>        <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a>(RMT_CHANNEL_4, gpio_num_t(hotrc_ch1_h_pin)),  <span class="comment">// hotrc[HORZ]</span></div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>        <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a>(RMT_CHANNEL_5, gpio_num_t(hotrc_ch2_v_pin)),  <span class="comment">// hotrc[VERT]</span></div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>        <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a>(RMT_CHANNEL_6, gpio_num_t(hotrc_ch3_pin)),  <span class="comment">// hotrc[CH3]</span></div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>        <a class="code hl_class" href="class_r_m_t_input.html">RMTInput</a>(RMT_CHANNEL_7, gpio_num_t(hotrc_ch4_pin)),  <span class="comment">// hotrc[CH4]</span></div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>    };</div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>    <span class="keywordtype">bool</span> spike_signbit;</div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span>    int32_t spike_length, this_delta, interpolated_slope, loopindex, previndex, spike_cliff[NUM_AXES];</div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span>    int32_t spike_threshold[NUM_AXES] = { 6, 6 };</div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>    int32_t prespike_index[NUM_AXES] = { -1, -1 };</div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>    int32_t index[NUM_AXES] = { 1, 1 };  <span class="comment">// index is the oldest values are popped from then new incoming values pushed in to the LIFO</span></div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span>    <span class="keyword">static</span> <span class="keyword">const</span> int32_t depth = 9;  <span class="comment">// more depth will reject longer spikes at the expense of controller delay</span></div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>    int32_t raw_history[NUM_AXES][depth], filt_history[NUM_AXES][depth];  <span class="comment">// Values before and after filtering.</span></div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>  <span class="keyword">public</span>:</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span>    <a class="code hl_class" href="class_hotrc.html">Hotrc</a>(<a class="code hl_class" href="class_simulator.html">Simulator</a>* _sim, <a class="code hl_class" href="class_potentiometer.html">Potentiometer</a>* _pot) : sim(_sim), pot(_pot) {</div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span>        calc_params();</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>    }</div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>    <span class="keywordtype">void</span> setup() {</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>        printf(<span class="stringliteral">&quot;Hotrc init.. Starting rmt..\n&quot;</span>);</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> axis=HORZ; axis&lt;=CH4; axis++) rmt[axis].init();  <span class="comment">// Set up 4 RMT receivers, one per channel</span></div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>        failsafe_timer.set(failsafe_timeout); </div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span>    }</div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>    <span class="keywordtype">void</span> calc_params() {</div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>        <span class="keywordtype">float</span> m_factor;</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>        <span class="keywordflow">for</span> (int8_t axis=HORZ; axis&lt;=VERT; axis++) {</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>            us[axis][DBBOT] = us[axis][CENT] - deadband_us;</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>            us[axis][DBTOP] = us[axis][CENT] + deadband_us;</div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>            us[axis][MARGIN] = margin_us;</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>            pc[axis][OPMIN] = -100.0;</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>            pc[axis][CENT] = 0.0;</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>            pc[axis][OPMAX] = 100.0;</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>            m_factor = (pc[axis][OPMAX] - pc[axis][OPMIN]) / (<span class="keywordtype">float</span>)(us[axis][OPMAX] - us[axis][OPMIN]);</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>            pc[axis][DBBOT] = pc[axis][CENT] - deadband_us * m_factor;</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span>            pc[axis][DBTOP] = pc[axis][CENT] + deadband_us * m_factor;</div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>            pc[axis][MARGIN] = margin_us * m_factor;</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>        }</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>    }</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>    <span class="keywordtype">int</span> update() {</div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>        toggles_update();</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>        <span class="keywordflow">if</span> (!(sim-&gt;simulating(sens::joy))) direction_update();</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span>        radiolost_update();</div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>        <span class="keywordflow">return</span> joydir();</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span>    }</div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>    <span class="keywordtype">void</span> toggles_reset() {  <span class="comment">// Shouldn&#39;t be necessary to reset events due to sw_event(ch) auto-resets when read</span></div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>        <span class="keywordflow">for</span> (int8_t ch = CH3; ch &lt;= CH4; ch++) _sw_event[ch] = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>    }</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>    <span class="keywordtype">bool</span> radiolost() { <span class="keywordflow">return</span> _radiolost; }</div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>    <span class="keywordtype">bool</span>* radiolost_ptr() { <span class="keywordflow">return</span> &amp;_radiolost; }</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>    <span class="keywordtype">bool</span> sw_event(uint8_t ch) {  <span class="comment">// returns if there&#39;s an event on the given channel then resets that channel</span></div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>        <span class="keywordtype">bool</span> retval = _sw_event[ch];</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>        _sw_event[ch] = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>        <span class="keywordflow">return</span> retval;        </div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>    }</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>    <span class="keywordtype">void</span> set_pc(int8_t axis, int8_t param, <span class="keywordtype">float</span> val) { pc[axis][param] = val; }</div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>    <span class="keywordtype">void</span> set_us(int8_t axis, int8_t param, int32_t val) { us[axis][param] = val; }</div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span>    int32_t next_unfilt_rawval (uint8_t axis) { <span class="keywordflow">return</span> raw_history[axis][index[axis]]; }  <span class="comment">// helps to debug the filter from outside the class</span></div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>    <span class="keywordtype">int</span> joydir(int8_t axis = VERT) {</div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span>        <span class="keywordflow">if</span> (axis == VERT) <span class="keywordflow">return</span> ((pc[axis][FILT] &gt; pc[axis][DBTOP]) ? JOY_UP : ((pc[axis][FILT] &lt; pc[axis][DBBOT]) ? JOY_DN : JOY_CENT));</div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>        <span class="keywordflow">return</span> ((pc[axis][FILT] &gt; pc[axis][DBTOP]) ? JOY_RT : ((pc[axis][FILT] &lt; pc[axis][DBBOT]) ? JOY_LT : JOY_CENT));</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>    }  <span class="comment">// return (pc[axis][FILT] &gt; pc[axis][DBTOP]) ? ((axis == VERT) ? JOY_UP : JOY_RT) : (pc[axis][FILT] &lt; pc[axis][DBBOT]) ? ((axis == VERT) ? JOY_DN : JOY_LT) : JOY_CENT;</span></div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>  <span class="keyword">private</span>:</div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span>    <span class="keywordtype">void</span> toggles_update() {  <span class="comment">//</span></div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>        <span class="keywordflow">for</span> (int8_t chan = CH3; chan &lt;= CH4; chan++) {</div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>            us[chan][RAW] = (int32_t)(rmt[chan].readPulseWidth(<span class="keyword">true</span>));</div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>            sw[chan] = (us[chan][RAW] &lt;= us[chan][CENT]); <span class="comment">// Ch3 switch true if short pulse, otherwise false  us[CH3][CENT]</span></div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>            <span class="keywordflow">if</span> ((sw[chan] != sw[chan-2]) &amp;&amp; !_radiolost) {</div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span>                _sw_event[chan] = <span class="keyword">true</span>; <span class="comment">// So a handler routine can be signaled. Handler must reset this to false. Skip possible erroneous events while radio lost, because on powerup its switch pulses go low</span></div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>                kick_inactivity_timer(5);  <span class="comment">// evidence of user activity</span></div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span>            }</div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span>            sw[chan-2] = sw[chan];  <span class="comment">// chan-2 index being used to store previous values of index chan</span></div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>        }</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>    }</div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>    <span class="keywordtype">float</span> us_to_pc(int8_t axis, int32_t _us, <span class="keywordtype">bool</span> deadbands=<span class="keyword">false</span>) {</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>        <span class="keywordflow">if</span> (deadbands) {</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span>            <span class="keywordflow">if</span> (_us &gt;= us[axis][DBTOP]) <span class="keywordflow">return</span> map((<span class="keywordtype">float</span>)_us, (<span class="keywordtype">float</span>)us[axis][DBTOP], (<span class="keywordtype">float</span>)us[axis][OPMAX], pc[axis][CENT], pc[axis][OPMAX]);</div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span>            <span class="keywordflow">if</span> (_us &lt;= us[axis][DBBOT]) <span class="keywordflow">return</span> map((<span class="keywordtype">float</span>)_us, (<span class="keywordtype">float</span>)us[axis][DBBOT], (<span class="keywordtype">float</span>)us[axis][OPMIN], pc[axis][CENT], pc[axis][OPMIN]);</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>            <span class="keywordflow">return</span> pc[axis][CENT];</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>        }</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span>        <span class="keywordflow">if</span> (_us &gt;= us[axis][CENT]) <span class="keywordflow">return</span> map((<span class="keywordtype">float</span>)_us, (<span class="keywordtype">float</span>)us[axis][CENT], (<span class="keywordtype">float</span>)us[axis][OPMAX], pc[axis][CENT], pc[axis][OPMAX]);</div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>        <span class="keywordflow">return</span> map((<span class="keywordtype">float</span>)_us, (<span class="keywordtype">float</span>)us[axis][CENT], (<span class="keywordtype">float</span>)us[axis][OPMIN], pc[axis][CENT], pc[axis][OPMIN]);    </div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span>    }</div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>    <span class="keywordtype">void</span> direction_update() {</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>        <span class="keywordflow">if</span> (sim-&gt;simulating(sens::joy)) {</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>            <span class="keywordflow">if</span> (sim-&gt;potmapping(sens::joy)) pc[HORZ][FILT] = pot-&gt;mapToRange(pc[HORZ][OPMIN], pc[HORZ][OPMAX]);  <span class="comment">// overwrite horz value if potmapping</span></div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>            <span class="comment">// Serial.printf(&quot;%d %d %lf\n&quot;,sim-&gt;potmapping(sens::joy),sim-&gt;potmapping(), pc[HORZ][FILT]);</span></div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>        }</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>        <span class="keywordflow">else</span> <span class="keywordflow">for</span> (int8_t axis = HORZ; axis &lt;= VERT; axis++) {  <span class="comment">// read pulses and update filtered percent values</span></div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>            us[axis][RAW] = (int32_t)(rmt[axis].readPulseWidth(<span class="keyword">true</span>));</div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>            int32_t us_spike = spike_filter(axis, us[axis][RAW]);</div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>            ema_filt(us_spike, &amp;us[axis][FILT], ema_alpha);</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span>            pc[axis][RAW] = us_to_pc(axis, us[axis][RAW], <span class="keyword">false</span>);</div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span>            pc[axis][FILT] = us_to_pc(axis, us[axis][FILT], <span class="keyword">true</span>);</div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>            <span class="keywordflow">if</span> (_radiolost) pc[axis][FILT] = pc[axis][CENT];  <span class="comment">// if radio lost set joy_axis_filt to CENTer value</span></div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (std::abs(pc[axis][FILT] - pc[axis][CENT]) &gt; pc[axis][MARGIN]) kick_inactivity_timer(6);  <span class="comment">// indicate evidence of user activity</span></div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>        }</div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span>        <span class="keywordflow">for</span> (int8_t axis = HORZ; axis &lt;= VERT; axis++) pc[axis][FILT] = constrain(pc[axis][FILT], pc[axis][OPMIN], pc[axis][OPMAX]);</div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span>    }</div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>    <span class="keywordtype">bool</span> radiolost_update() {</div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span>        <span class="keywordflow">if</span> (us[VERT][FILT] &gt; failsafe_us + failsafe_margin_us) {</div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span>            failsafe_timer.reset();</div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span>            _radiolost = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span>        }</div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (failsafe_timer.expired()) _radiolost = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span>        <span class="keywordflow">return</span> _radiolost;</div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>    }</div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span>    <span class="comment">// Spike filter pushes new hotrc readings into a LIFO ring buffer, replaces any well-defined spikes with values </span></div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span>    <span class="comment">// interpolated from before and after the spike. Also smoothes out abrupt value changes that don&#39;t recover later</span></div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>    int32_t spike_filter (uint8_t axis, int32_t new_val) {  <span class="comment">// pushes next val in, massages any detected spikes, returns filtered past value</span></div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>        previndex = (depth + index[axis] - 1) % depth;  <span class="comment">// previndex is where the incoming new value will be stored</span></div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>        this_delta = new_val - filt_history[axis][previndex];  <span class="comment">// Value change since last reading</span></div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span>        <span class="keywordflow">if</span> (std::abs(this_delta) &gt; spike_cliff[axis]) {  <span class="comment">// If new value is a cliff edge (start or end of a spike)</span></div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span>            <span class="keywordflow">if</span> (prespike_index[axis] == -1) {  <span class="comment">// If this cliff edge is the start of a new spike</span></div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span>                prespike_index[axis] = previndex;  <span class="comment">// save index of last good value just before the cliff</span></div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span>                spike_signbit = signbit(this_delta);  <span class="comment">// Save the direction of the cliff</span></div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span>            }</div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (spike_signbit == signbit(this_delta)) {  <span class="comment">// If this cliff edge deepens an in-progress spike (or more likely the change is valid)</span></div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span>                inject_interpolations(axis, previndex, filt_history[axis][previndex]);  <span class="comment">// Smoothly grade the values from before the last cliff to previous value</span></div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span>                prespike_index[axis] = previndex;  <span class="comment">// Consider this cliff edge the start of the spike instead</span></div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span>            }</div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span>            <span class="keywordflow">else</span> {  <span class="comment">// If this cliff edge is a recovery of an in-progress spike</span></div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>                inject_interpolations(axis, index[axis], new_val);  <span class="comment">// Fill in the spiked values with interpolated values</span></div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>                prespike_index[axis] = -1;  <span class="comment">// Cancel the current spike</span></div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span>            }</div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span>        }</div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prespike_index[axis] == index[axis]) {  <span class="comment">// If a current spike lasted thru our whole buffer</span></div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>            inject_interpolations (axis, previndex, filt_history[axis][previndex]);  <span class="comment">// Smoothly grade the whole buffer</span></div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>            prespike_index[axis] = -1;  <span class="comment">// Cancel the current spike</span></div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>        }</div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>        int32_t returnval = filt_history[axis][index[axis]];  <span class="comment">// Save the incumbent value at current index (oldest value) into buffer</span></div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>        filt_history[axis][index[axis]] = new_val;</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span>        raw_history[axis][index[axis]] = new_val;</div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span>        ++(index[axis]) %= depth;  <span class="comment">// Update index for next time</span></div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span>        <span class="keywordflow">return</span> returnval;  <span class="comment">// Return the saved old value</span></div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span>    }</div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span>    <span class="keywordtype">void</span> inject_interpolations(uint8_t axis, int32_t endspike_index, int32_t endspike_val) {  <span class="comment">// Replaces values between indexes with linear interpolated values</span></div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>        spike_length = ((depth + endspike_index - prespike_index[axis]) % depth) - 1;  <span class="comment">// Equal to the spiking values count plus one</span></div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span>        <span class="keywordflow">if</span> (!spike_length) <span class="keywordflow">return</span>;  <span class="comment">// Two cliffs in the same direction on consecutive readings needs no adjustment, also prevents divide by zero </span></div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span>        interpolated_slope = (endspike_val - filt_history[axis][prespike_index[axis]]) / spike_length;</div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span>        loopindex = 0;</div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span>        <span class="keywordflow">while</span> (++loopindex &lt;= spike_length)</div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span>            filt_history[axis][(prespike_index[axis] + loopindex) % depth] = filt_history[axis][prespike_index[axis]] + loopindex * interpolated_slope;</div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span>    }</div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>};</div>
</div>
<div class="ttc" id="aclass_air_velo_sensor_html"><div class="ttname"><a href="class_air_velo_sensor.html">AirVeloSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:531</div></div>
<div class="ttc" id="aclass_analog_sensor_html"><div class="ttname"><a href="class_analog_sensor.html">AnalogSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:673</div></div>
<div class="ttc" id="aclass_brake_position_sensor_html"><div class="ttname"><a href="class_brake_position_sensor.html">BrakePositionSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:820</div></div>
<div class="ttc" id="aclass_car_battery_html"><div class="ttname"><a href="class_car_battery.html">CarBattery</a></div><div class="ttdef"><b>Definition</b> sensors.h:699</div></div>
<div class="ttc" id="aclass_device_html"><div class="ttname"><a href="class_device.html">Device</a></div><div class="ttdef"><b>Definition</b> sensors.h:181</div></div>
<div class="ttc" id="aclass_hotrc_html"><div class="ttname"><a href="class_hotrc.html">Hotrc</a></div><div class="ttdef"><b>Definition</b> sensors.h:1380</div></div>
<div class="ttc" id="aclass_i2_c_html"><div class="ttname"><a href="class_i2_c.html">I2C</a></div><div class="ttdef"><b>Definition</b> i2cbus.h:5</div></div>
<div class="ttc" id="aclass_i2_c_sensor_html"><div class="ttname"><a href="class_i2_c_sensor.html">I2CSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:496</div></div>
<div class="ttc" id="aclass_li_po_batt_html"><div class="ttname"><a href="class_li_po_batt.html">LiPoBatt</a></div><div class="ttdef"><b>Definition</b> sensors.h:739</div></div>
<div class="ttc" id="aclass_m_a_p_sensor_html"><div class="ttname"><a href="class_m_a_p_sensor.html">MAPSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:595</div></div>
<div class="ttc" id="aclass_param_html"><div class="ttname"><a href="class_param.html">Param</a></div><div class="ttdef"><b>Definition</b> sensors.h:73</div></div>
<div class="ttc" id="aclass_potentiometer_html"><div class="ttname"><a href="class_potentiometer.html">Potentiometer</a></div><div class="ttdef"><b>Definition</b> sensors.h:21</div></div>
<div class="ttc" id="aclass_pressure_sensor_html"><div class="ttname"><a href="class_pressure_sensor.html">PressureSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:776</div></div>
<div class="ttc" id="aclass_pulse_sensor_html"><div class="ttname"><a href="class_pulse_sensor.html">PulseSensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:878</div></div>
<div class="ttc" id="aclass_r_m_t_input_html"><div class="ttname"><a href="class_r_m_t_input.html">RMTInput</a></div><div class="ttdef"><b>Definition</b> sensors.h:1315</div></div>
<div class="ttc" id="aclass_sensor_html"><div class="ttname"><a href="class_sensor.html">Sensor</a></div><div class="ttdef"><b>Definition</b> sensors.h:451</div></div>
<div class="ttc" id="aclass_simulator_html"><div class="ttname"><a href="class_simulator.html">Simulator</a></div><div class="ttdef"><b>Definition</b> sensors.h:1152</div></div>
<div class="ttc" id="aclass_spark_fun___micro_pressure_html"><div class="ttname"><a href="class_spark_fun___micro_pressure.html">SparkFun_MicroPressure</a></div><div class="ttdef"><b>Definition</b> i2cbus.h:83</div></div>
<div class="ttc" id="aclass_speedometer_html"><div class="ttname"><a href="class_speedometer.html">Speedometer</a></div><div class="ttdef"><b>Definition</b> sensors.h:1014</div></div>
<div class="ttc" id="aclass_tachometer_html"><div class="ttname"><a href="class_tachometer.html">Tachometer</a></div><div class="ttdef"><b>Definition</b> sensors.h:949</div></div>
<div class="ttc" id="aclass_timer_html"><div class="ttname"><a href="class_timer.html">Timer</a></div><div class="ttdef"><b>Definition</b> globals.h:299</div></div>
<div class="ttc" id="aclass_transducer_html"><div class="ttname"><a href="class_transducer.html">Transducer</a></div><div class="ttdef"><b>Definition</b> sensors.h:261</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>

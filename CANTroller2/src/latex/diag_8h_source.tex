\doxysection{diag.\+h}
\hypertarget{diag_8h_source}{}\label{diag_8h_source}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ "{}Arduino.h"{}}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <esp\_task\_wdt.h>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <iostream>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <iomanip>}\ \ \textcolor{comment}{//\ For\ formatting\ console\ loop\ timing\ string\ output}}
\DoxyCodeLine{00006\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_diag_runtime}{DiagRuntime}}\ \{}
\DoxyCodeLine{00007\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00008\ \ \ \ \ \textcolor{keywordtype}{bool}\ report\_error\_changes\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00009\ \ \ \ \ \mbox{\hyperlink{class_hotrc}{Hotrc}}*\ hotrc;}
\DoxyCodeLine{00010\ \ \ \ \ \mbox{\hyperlink{class_temperature_sensor_manager}{TemperatureSensorManager}}*\ tempsens;}
\DoxyCodeLine{00011\ \ \ \ \ \mbox{\hyperlink{class_pressure_sensor}{PressureSensor}}*\ pressure;}
\DoxyCodeLine{00012\ \ \ \ \ \mbox{\hyperlink{class_brake_position_sensor}{BrakePositionSensor}}*\ brkpos;}
\DoxyCodeLine{00013\ \ \ \ \ \mbox{\hyperlink{class_tachometer}{Tachometer}}*\ tach;}
\DoxyCodeLine{00014\ \ \ \ \ \mbox{\hyperlink{class_speedometer}{Speedometer}}*\ speedo;}
\DoxyCodeLine{00015\ \ \ \ \ \mbox{\hyperlink{class_gas_servo}{GasServo}}*\ gas;}
\DoxyCodeLine{00016\ \ \ \ \ \mbox{\hyperlink{class_brake_motor}{BrakeMotor}}*\ brake;}
\DoxyCodeLine{00017\ \ \ \ \ \mbox{\hyperlink{class_steer_motor}{SteerMotor}}*\ steer;}
\DoxyCodeLine{00018\ \ \ \ \ \mbox{\hyperlink{class_car_battery}{CarBattery}}*\ mulebatt;}
\DoxyCodeLine{00019\ \ \ \ \ \mbox{\hyperlink{class_air_velo_sensor}{AirVeloSensor}}*\ airvelo;}
\DoxyCodeLine{00020\ \ \ \ \ \mbox{\hyperlink{class_m_a_p_sensor}{MAPSensor}}*\ mapsens;}
\DoxyCodeLine{00021\ \ \ \ \ \mbox{\hyperlink{class_potentiometer}{Potentiometer}}*\ pot;}
\DoxyCodeLine{00022\ \ \ \ \ \mbox{\hyperlink{class_ignition}{Ignition}}*\ ignition;}
\DoxyCodeLine{00023\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ entries\ =\ 100;\ \ \textcolor{comment}{//\ size\ of\ log\ buffers}}
\DoxyCodeLine{00024\ \ \ \ \ int64\_t\ times[2][entries];}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{comment}{//\ two\ sets\ of\ large\ arrays\ for\ storage\ of\ log\ data.\ when\ one\ fills\ up\ it\ jumps\ to\ the\ other,\ so\ the\ first\ might\ be\ written\ to\ an\ sd\ card}}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{keywordtype}{float}\ tel[2][NumTelemetryFull][entries];\ \ \textcolor{comment}{//\ array\ for\ telemetry\ of\ all\ sensors\ for\ given\ timestamp}}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ 0,\ dic\ =\ 0,\ runmode;\ \ \textcolor{comment}{//\ start\ with\ dictionary\ 0}}
\DoxyCodeLine{00028\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ logTimer\{100000\};\ \ \textcolor{comment}{//\ microseconds\ per\ logged\ reading}}
\DoxyCodeLine{00029\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ errTimer\{175000\};}
\DoxyCodeLine{00030\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ speedoTimer\{2500000\},\ tachTimer\{2500000\};\ \ \textcolor{comment}{//\ how\ much\ time\ within\ which\ we\ expect\ the\ car\ will\ move\ after\ hitting\ the\ gas}}
\DoxyCodeLine{00031\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{comment}{//\ diag\ tunable\ values}}
\DoxyCodeLine{00033\ \ \ \ \ uint32\_t\ err\_margin\_adc\ =\ 5;}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keywordtype}{char}\ err\_type\_card[NUM\_ERR\_TYPES][5]\ =\ \{\ \textcolor{stringliteral}{"{}Lost"{}},\ \textcolor{stringliteral}{"{}Rang"{}}\ \};\ \ \textcolor{comment}{//\ this\ needs\ to\ match\ err\_type\ enum\ \ \ //\ ,\ "{}Cal"{},\ "{}Warn"{},\ "{}Crit"{},\ "{}Info"{}\ \};}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{char}\ err\_sens\_card[NumTelemetryFull+2][7]\ =\ \{\ \ \textcolor{comment}{//\ this\ needs\ to\ match\ telemetry\_idiots\ and\ telemetry\_full\ enums,\ with\ NA\ and\ None\ tacked\ on\ the\ end}}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Throtl"{}},\ \textcolor{stringliteral}{"{}BkMotr"{}},\ \textcolor{stringliteral}{"{}Steer"{}},\ \textcolor{stringliteral}{"{}HotRC"{}},\ \textcolor{stringliteral}{"{}Speedo"{}},\ \textcolor{stringliteral}{"{}Tach"{}},\ \textcolor{stringliteral}{"{}BkPres"{}},\ \textcolor{stringliteral}{"{}BkPosn"{}},\ \textcolor{stringliteral}{"{}Temps"{}},\ \textcolor{stringliteral}{"{}Other"{}},\ \textcolor{stringliteral}{"{}GPIO"{}},\ }
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}HrcHrz"{}},\ \textcolor{stringliteral}{"{}HrcVrt"{}},\ \textcolor{stringliteral}{"{}HrcCh3"{}},\ \textcolor{stringliteral}{"{}HrcCh4"{}},\ \textcolor{stringliteral}{"{}Batery"{}},\ \textcolor{stringliteral}{"{}AirVel"{}},\ \textcolor{stringliteral}{"{}MAP"{}},\ \textcolor{stringliteral}{"{}Pot"{}},\ \textcolor{stringliteral}{"{}TmpEng"{}},\ \textcolor{stringliteral}{"{}TmpWFL"{}},\ \textcolor{stringliteral}{"{}TmpWFR"{}},}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}TmpWRL"{}},\ \textcolor{stringliteral}{"{}TmpWRR"{}},\ \textcolor{stringliteral}{"{}TmpBrk"{}},\ \textcolor{stringliteral}{"{}TmpAmb"{}},\ \textcolor{stringliteral}{"{}Ign"{}},\ \textcolor{stringliteral}{"{}Start"{}},\ \textcolor{stringliteral}{"{}BasicS"{}},\ \textcolor{stringliteral}{"{}FuelP"{}},}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}NA"{}},\ \textcolor{stringliteral}{"{}None"{}}}
\DoxyCodeLine{00040\ \ \ \ \ \};}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{comment}{//\ diag\ non-\/tunable\ values}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordtype}{bool}\ temp\_err[NUM\_TEMP\_CATEGORIES];\ \ \textcolor{comment}{//\ [AMBIENT/ENGINE/WHEEL]}}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keywordtype}{bool}\ err\_sens\_alarm[NUM\_ERR\_TYPES]\ =\ \{\ \textcolor{keyword}{false},\ \textcolor{keyword}{false}\ \};}
\DoxyCodeLine{00044\ \ \ \ \ int8\_t\ err\_sens\_fails[NUM\_ERR\_TYPES]\ =\ \{\ 0,\ 0\ \};}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordtype}{bool}\ err\_sens[NUM\_ERR\_TYPES][NumTelemetryFull];\ \textcolor{comment}{//\ \ [LOST/RANGE]\ [\_HotRCHorz/\_HotRCVert/\_HotRCCh3/\_HotRCCh4/\_Pressure/\_BrkPos/\_Tach/\_Speedo/\_AirVelo/\_MAP/\_TempEng/\_MuleBatt/\_BasicSw/\_Starter]\ \ \ //\ sens::opt\_t::NUM\_SENSORS]}}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordtype}{bool}\ err\_last[NUM\_ERR\_TYPES][NumTelemetryFull];\ \textcolor{comment}{//\ \ [LOST/RANGE]\ [\_HotRCHorz/\_HotRCVert/\_HotRCCh3/\_HotRCCh4/\_Pressure/\_BrkPos/\_Tach/\_Speedo/\_AirVelo/\_MAP/\_TempEng/\_MuleBatt/\_BasicSw/\_Starter]\ \ \ //\ sens::opt\_t::NUM\_SENSORS]}}
\DoxyCodeLine{00047\ \ \ \ \ uint8\_t\ most\_critical\_sensor[NUM\_ERR\_TYPES];}
\DoxyCodeLine{00048\ \ \ \ \ uint8\_t\ most\_critical\_last[NUM\_ERR\_TYPES];}
\DoxyCodeLine{00049\ \ \ \ \ \mbox{\hyperlink{class_diag_runtime}{DiagRuntime}}\ (\mbox{\hyperlink{class_hotrc}{Hotrc}}*\ a\_hotrc,\ \mbox{\hyperlink{class_temperature_sensor_manager}{TemperatureSensorManager}}*\ a\_temp,\ \mbox{\hyperlink{class_pressure_sensor}{PressureSensor}}*\ a\_pressure,\ \mbox{\hyperlink{class_brake_position_sensor}{BrakePositionSensor}}*\ a\_brkpos,}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_tachometer}{Tachometer}}*\ a\_tach,\ \mbox{\hyperlink{class_speedometer}{Speedometer}}*\ a\_speedo,\ \mbox{\hyperlink{class_gas_servo}{GasServo}}*\ a\_gas,\ \mbox{\hyperlink{class_brake_motor}{BrakeMotor}}*\ a\_brake,\ \mbox{\hyperlink{class_steer_motor}{SteerMotor}}*\ a\_steer,\ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{class_car_battery}{CarBattery}}*\ a\_mulebatt,\ \mbox{\hyperlink{class_air_velo_sensor}{AirVeloSensor}}*\ a\_airvelo,\ \mbox{\hyperlink{class_m_a_p_sensor}{MAPSensor}}*\ a\_mapsens,\ \mbox{\hyperlink{class_potentiometer}{Potentiometer}}*\ a\_pot,\ \mbox{\hyperlink{class_ignition}{Ignition}}*\ a\_ignition)}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ :\ hotrc(a\_hotrc),\ tempsens(a\_temp),\ pressure(a\_pressure),\ brkpos(a\_brkpos),\ tach(a\_tach),\ speedo(a\_speedo),\ gas(a\_gas),\ brake(a\_brake),\ }
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ steer(a\_steer),\ mulebatt(a\_mulebatt),\ airvelo(a\_airvelo),\ mapsens(a\_mapsens),\ pot(a\_pot),\ ignition(a\_ignition)\ \{\}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ i=0;\ i<NUM\_ERR\_TYPES;\ i++)}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ j=0;\ j<NumTelemetryFull;\ j++)}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[i][j]\ =\ err\_last[i][j]\ =\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ Initialize\ sensor\ error\ flags\ to\ false}}
\DoxyCodeLine{00059\ \ \ \ \ \}}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordtype}{void}\ update(\textcolor{keywordtype}{int}\ \_runmode)\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ runmode\ =\ \_runmode;}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (errTimer.expireset())\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Auto-\/Diagnostic\ \ :\ \ \ Check\ for\ worrisome\ oddities\ and\ dubious\ circumstances.\ Report\ any\ suspicious\ findings}}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ section\ should\ become\ a\ real\ time\ self-\/diagnostic\ system,\ to\ look\ for\ anything\ that\ doesn't\ seem\ right\ and\ display\ an}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ informed\ trouble\ code.\ Much\ like\ the\ engine\ computer\ in\ cars\ nowadays,\ which\ keep\ track\ of\ any\ detectable\ failures\ for\ you\ to}}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ retreive\ with\ an\ OBD\ tool.\ Some\ checks\ are\ below,\ along\ with\ other\ possible\ things\ to\ check\ for:}}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ not\_detected\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ first\ reset}}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ cat\ =\ 0;\ cat\ <\ NUM\_TEMP\_CATEGORIES;\ cat++)\ temp\_err[cat]\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ first\ reset}}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ tempsens-\/>locint();\ l++)\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!tempsens-\/>detected(l))\ not\_detected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tempsens-\/>val(l)\ >=\ temp\_lims\_f[tempsens-\/>errclass(l)][WARNING])\ temp\_err[tempsens-\/>errclass(l)]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_TempEng]\ =\ not\_detected;}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Detect\ sensors\ disconnected\ or\ giving\ out-\/of-\/range\ readings.}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO\ :\ The\ logic\ of\ this\ for\ each\ sensor\ should\ be\ moved\ to\ devices.h\ objects}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_BrakeMotor]\ =\ (brake-\/>pc[OUT]\ <\ brake-\/>pc[OPMIN]\ ||\ brake-\/>pc[OUT]\ >\ brake-\/>pc[OPMAX]);}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_GasServo]\ =\ (gas-\/>pc[OUT]\ <\ gas-\/>pc[OPMIN]\ ||\ gas-\/>pc[OUT]\ >\ gas-\/>pc[OPMAX]);}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_BrakeMotor]\ =\ (steer-\/>pc[OUT]\ <\ steer-\/>pc[OPMIN]\ ||\ steer-\/>pc[OUT]\ >\ steer-\/>pc[OPMAX]);}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_BrakePosn]\ =\ (brkpos-\/>in()\ <\ brkpos-\/>op\_min()\ ||\ brkpos-\/>in()\ >\ brkpos-\/>op\_max());}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_BrakePosn]\ =\ (brkpos-\/>raw()\ <\ err\_margin\_adc);}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_BrakePres]\ =\ (pressure-\/>psi()\ <\ pressure-\/>op\_min()\ ||\ pressure-\/>psi()\ >\ pressure-\/>op\_max());}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_BrakePres]\ =\ (pressure-\/>raw()\ <\ err\_margin\_adc);}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_MuleBatt]\ =\ (mulebatt-\/>v()\ <\ mulebatt-\/>op\_min\_v()\ ||\ mulebatt-\/>v()\ >\ mulebatt-\/>op\_max\_v());}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ HotRCFailure();}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_Ignition]\ =\ (!ignition-\/>signal\ \&\&\ !tach-\/>engine\_stopped());\ \ \textcolor{comment}{//\ Not\ really\ "{}LOST"{},\ but\ lost\ isn't\ meaningful\ for\ ignition\ really\ anyway}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_Speedo]\ =\ SpeedoFailure();}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][\_Tach]\ =\ TachFailure();}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_Speedo]\ =\ (speedo-\/>mph()\ <\ speedo-\/>min\_human()\ ||\ speedo-\/>mph()\ >\ speedo-\/>max\_human());;}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][\_Tach]\ =\ (tach-\/>rpm()\ <\ tach-\/>min\_human()\ ||\ tach-\/>rpm()\ >\ tach-\/>max\_human());}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ err\_sens[VALUE][\_SysPower]\ =\ (!syspower\ \&\&\ (run.mode\ !=\ ASLEEP));}}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ set\_sensorgroups();}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ set\_sensidiots();}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ set\_idiot\_blinks();}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ report\_changes();\ \ \textcolor{comment}{//\ detect\ and\ report\ changes\ in\ any\ error\ values}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ for\ (int32\_t\ i=0;\ i<NUM\_ERR\_TYPES;\ i++)}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ for\ (int32\_t\ j=0;\ j<NumTelemetryFull;\ j++)}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ //\ printf\ ("{}\(\backslash\)n"{});}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ make\_log\_entry();}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ \ \ \ \ \}}
\DoxyCodeLine{00104\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_sensorgroups()\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ typ=0;\ typ<NUM\_ERR\_TYPES;\ typ++)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[typ][\_HotRC]\ =\ err\_sens[typ][\_HotRCHorz]\ ||\ err\_sens[typ][\_HotRCVert]\ ||\ err\_sens[typ][\_HotRCCh3]\ ||\ err\_sens[typ][\_HotRCCh4];}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[typ][\_GPIO]\ =\ err\_sens[typ][\_Ignition]\ ||\ err\_sens[typ][\_BasicSw]\ ||\ err\_sens[typ][\_Starter]\ ||\ err\_sens[typ][\_FuelPump];}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[typ][\_Other]\ =\ err\_sens[typ][\_MuleBatt]\ ||\ err\_sens[typ][\_AirVelo]\ ||\ err\_sens[typ][\_MAP]\ ||\ err\_sens[typ][\_Pot];}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[typ][\_Temps]\ =\ err\_sens[typ][\_TempEng]\ ||\ err\_sens[typ][\_TempWhFL]\ ||\ err\_sens[typ][\_TempWhFR]\ ||\ err\_sens[typ][\_TempWhRL]}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ err\_sens[typ][\_TempWhRR]\ ||\ err\_sens[typ][\_TempBrake]\ ||\ err\_sens[typ][\_TempAmb];}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ \}}
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_sensidiots()\ \{}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ err=0;\ err<=\_GPIO;\ err++)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ sensidiots[err]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ typ=0;\ typ<NUM\_ERR\_TYPES;\ typ++)\ sensidiots[err]\ =\ sensidiots[err]\ ||\ err\_sens[typ][err];}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00119\ \ \ \ \ \}}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_idiot\_blinks()\ \{\ \ \textcolor{comment}{//\ adds\ blink\ code\ to\ lost\ and\ range\ err\ neopixels\ corresponing\ to\ the\ lowest\ numbered\ failing\ sensor}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ t=LOST;\ t<=RANGE;\ t++)\ \{}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ most\_critical\_sensor[t]\ =\ \_None;}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens\_alarm[t]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens\_fails[t]\ =\ 0;}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ s=0;\ s<NumTelemetryIdiots;\ s++)}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (err\_sens[t][s])\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (most\_critical\_sensor[t]\ =\ \_None)\ most\_critical\_sensor[t]\ =\ s;}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens\_alarm[t]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens\_fails[t]++;}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00132\ \ \ \ \ \}}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordtype}{void}\ report\_changes()\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ i=0;\ i<NUM\_ERR\_TYPES;\ i++)\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ j=0;\ j<NumTelemetryFull;\ j++)\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (report\_error\_changes)\ \{}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (err\_sens[i][j]\ \&\&\ !err\_last[i][j])}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}!diag:\ \%s\ \%s\ err\(\backslash\)n"{}},\ err\_sens\_card[j],\ err\_type\_card[i]);}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!err\_sens[i][j]\ \&\&\ err\_last[i][j])}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}!diag:\ \%s\ \%s\ ok\(\backslash\)n"{}},\ err\_sens\_card[j],\ err\_type\_card[i]);}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ err\_last[i][j]\ =\ err\_sens[i][j];}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \}\ \ \ \ }
\DoxyCodeLine{00145\ \ \ \ \ \}}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keywordtype}{int}\ worst\_sensor(\textcolor{keywordtype}{int}\ type)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ most\_critical\_sensor[type];\ \ \textcolor{comment}{//\ for\ global\ awareness}}
\DoxyCodeLine{00148\ \ \ \ \ \}}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordtype}{void}\ print()\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ t=0;\ t<=NUM\_ERR\_TYPES;\ t++)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ printf\ (\textcolor{stringliteral}{"{}diag\ err:\ \%s\ (\%d):\ "{}},\ err\_type\_card[t],\ err\_sens\_fails[t]);}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ s=0;\ s<=NumTelemetryFull;\ s++)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (s\ ==\ NumTelemetryFull)\ s++;}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (err\_sens[t][s])\ printf\ (\textcolor{stringliteral}{"{}\%s,\ "{}},\ err\_sens\_card[s]);}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{keywordtype}{bool}\ SpeedoFailure()\ \{\ \ \textcolor{comment}{//\ checks\ if\ speedo\ isn't\ zero\ when\ stopped,\ or\ doesn't\ increase\ when\ we\ drive}}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ gunning\_it,\ gunning\_last\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{float}\ baseline\_speed;}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ fail\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (runmode\ ==\ SHUTDOWN)\ \{\ \ \textcolor{comment}{//\ ||\ runmode\ ==\ HOLD\ \ //\ check\ that\ the\ speed\ is\ zero\ when\ stopped}}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (gunning\_last)\ speedoTimer.reset();\ \ \ \ \ \ \ //\ if\ we\ just\ stopped\ driving,\ allow\ time\ for\ car\ to\ stop}}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ else\ if\ (speedoTimer.expired())\ \{\ \ \ \ \ \ \ \ \ \ \ \ //\ if\ it\ has\ been\ enough\ time\ since\ entering\ shutdown,\ we\ should\ be\ stopped}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ fail\ =\ (baseline\_speed\ >\ speedo-\/>margin\_mph());\ \ \textcolor{comment}{//\ when\ stopped\ the\ speedo\ reading\ should\ be\ zero,\ otherwise\ fail}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ baseline\_speed\ =\ speedo-\/>filt();\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ store\ the\ speed\ value\ when\ we\ are\ stopped}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ gunning\_it\ =\ (gas-\/>pc[OUT]\ >\ 20.0\ \&\&\ (runmode\ ==\ FLY\ ||\ runmode\ ==\ CRUISE));}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gunning\_it)\ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ we're\ attempting\ to\ drive}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!gunning\_last)\ speedoTimer.reset();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ delay\ our\ speed\ comparison\ so\ car\ can\ accelerate}}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (speedoTimer.expired())\ fail\ =\ (speedo-\/>filt()\ -\/\ baseline\_speed\ <\ speedo-\/>margin\_mph());\ \ \textcolor{comment}{//\ the\ car\ should\ be\ moving\ by\ now}}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ gunning\_last\ =\ gunning\_it;}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ fail;}
\DoxyCodeLine{00177\ \ \ \ \ \}}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{bool}\ TachFailure()\ \{\ \ \textcolor{comment}{//\ checks\ if\ tach\ isn't\ low\ when\ throttle\ is\ released,\ or\ doesn't\ increase\ when\ we\ gun\ it}}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ running\_it,\ running\_last\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{float}\ baseline\_rpm;}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ fail\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (runmode\ ==\ SHUTDOWN)\ \{\ \ \textcolor{comment}{//\ ||\ runmode\ ==\ STALL\ \ //\ check\ that\ the\ speed\ is\ zero\ when\ stopped}}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (running\_last)\ tachTimer.reset();\ \ \ \ \ \ \ //\ if\ we\ just\ stopped\ driving,\ allow\ time\ for\ car\ to\ stop}}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ else\ if\ (tachTimer.expired())\ \{\ \ \ \ \ \ \ \ \ \ \ \ //\ if\ it\ has\ been\ enough\ time\ since\ entering\ shutdown,\ we\ should\ be\ stopped}}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ fail\ =\ (baseline\_rpm\ >\ tach-\/>margin\_rpm());\ \ \textcolor{comment}{//\ when\ stopped\ the\ speedo\ reading\ should\ be\ zero,\ otherwise\ fail}}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ baseline\_rpm\ =\ tach-\/>filt();\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ store\ the\ speed\ value\ when\ we\ are\ stopped}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ running\_it\ =\ (gas-\/>pc[OUT]\ >\ 20.0\ \&\&\ (runmode\ ==\ FLY\ ||\ runmode\ ==\ CRUISE));}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (running\_it)\ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ we're\ attempting\ to\ drive}}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!running\_last)\ tachTimer.reset();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ delay\ our\ rpm\ comparison\ so\ car\ can\ respond}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tachTimer.expired())\ fail\ =\ (tach-\/>filt()\ -\/\ baseline\_rpm\ <\ tach-\/>margin\_rpm());\ \ \textcolor{comment}{//\ the\ car\ should\ be\ moving\ by\ now}}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ running\_last\ =\ running\_it;}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ fail;}
\DoxyCodeLine{00196\ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordtype}{void}\ HotRCFailure()\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ ch\ =\ HORZ;\ ch\ <=\ CH4;\ ch++)\ \{\ \ \textcolor{comment}{//\ Hack:\ This\ loop\ depends\ on\ the\ indices\ for\ hotrc\ channel\ enums\ matching\ indices\ of\ hotrc\ sensor\ errors}}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ errindex;}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ch\ ==\ HORZ)\ errindex\ =\ \_HotRCHorz;}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (ch\ ==\ VERT)\ errindex\ =\ \_HotRCVert;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (ch\ ==\ CH3)\ errindex\ =\ \_HotRCCh3;}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (ch\ ==\ CH4)\ errindex\ =\ \_HotRCCh4;}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[RANGE][errindex]\ =\ !hotrc-\/>radiolost()\ \&\&\ ((hotrc-\/>us[ch][RAW]\ <\ hotrc-\/>us[ch][OPMIN]\ -\/\ (hotrc-\/>us[ch][MARGIN]\ >>\ 1))\ }
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (hotrc-\/>us[ch][RAW]\ >\ hotrc-\/>us[ch][OPMAX]\ +\ (hotrc-\/>us[ch][MARGIN]\ >>\ 1)));\ \ \textcolor{comment}{//\ \&\&\ ch\ !=\ VERT}}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ err\_sens[LOST][errindex]\ =\ !hotrc-\/>radiolost()\ \&\&\ ((hotrc-\/>us[ch][RAW]\ <\ (hotrc-\/>absmin\_us\ -\/\ hotrc-\/>us[ch][MARGIN]))}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ||\ (hotrc-\/>us[ch][RAW]\ >\ (hotrc-\/>absmax\_us\ +\ hotrc-\/>us[ch][MARGIN])));}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ err\_sens[RANGE][\_HotRCVert]\ =\ (hotrc-\/>us[VERT][RAW]\ <\ hotrc-\/>failsafe\_us\ -\/\ hotrc-\/>us[ch][MARGIN])}}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ ||\ ((hotrc-\/>us[VERT][RAW]\ <\ hotrc-\/>us[VERT][OPMIN]\ -\/\ halfMARGIN)\ \&\&\ (hotrc-\/>us[VERT][RAW]\ >\ hotrc-\/>failsafe\_us\ +\ hotrc-\/>us[ch][MARGIN]));}}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \ \ \}}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordtype}{void}\ make\_log\_entry()\ \{}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (logTimer.expireset())\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ times[dic][index]\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_GasServo][index]\ =\ gas-\/>pc[OUT];}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_BrakeMotor][index]\ =\ brake-\/>pc[OUT];}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_SteerMotor][index]\ =\ steer-\/>pc[OUT];}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_BrakePres][index]\ =\ pressure-\/>filt();}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_BrakePosn][index]\ =\ brkpos-\/>filt();}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_Speedo][index]\ =\ speedo-\/>filt();}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ tel[dic][\_Tach][index]\ =\ tach-\/>filt();}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_HotRCHorz][index]\ =\ hotrc-\/>pc[HORZ][FILT];}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_HotRCVert][index]\ =\ hotrc-\/>pc[VERT][FILT];}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_MuleBatt][index]\ =\ mulebatt-\/>filt();}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_AirVelo][index]\ =\ airvelo-\/>filt();\ }}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_MAP][index]\ =\ mapsens-\/>filt();}}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_MAF][index]\ =\ *maf;}}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_Pot][index]\ =\ pot-\/>val();}}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ bools[dic][\_Ignition][index]\ =\ *ignition;}}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempEng][index]\ =\ }}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempWhFL][index]\ =\ }}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempWhFR][index]\ =\ }}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempWhRL][index]\ =\ }}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempWhRR][index]\ =\ }}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ tel[dic][\_TempAmb][index]\ =\ }}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ ++index\ \%=\ entries;}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ printf("{}."{});}}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!index)\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dic\ =\ !dic;}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ printf("{}Filled\ dic\ \%d\(\backslash\)n"{},\ dic);}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00243\ \ \ \ \ \}}
\DoxyCodeLine{00244\ \};}
\DoxyCodeLine{00245\ \textcolor{comment}{//\ Detectable\ transducer-\/related\ failures\ ::\ How\ we\ can\ detect\ them}}
\DoxyCodeLine{00246\ \textcolor{comment}{//\ Brakes:}}
\DoxyCodeLine{00247\ \textcolor{comment}{//\ *\ Pressure\ sensor,\ chain\ linkage,\ or\ vehicle\ brakes\ problem\ ::\ Motor\ retracted\ with\ position\ below\ zeropoint,\ but\ pressure\ did\ not\ increase.}}
\DoxyCodeLine{00248\ \textcolor{comment}{//\ *\ Pressure\ sensor\ zero\ point\ miscalibration\ (no\ force\ on\ pedal)\ ::\ Minimum\ pressure\ reading\ since\ startup\ has\ never\ reached\ 0\ PSI\ or\ less\ (cal\ is\ too\ high),\ or,\ is\ more\ than\ a\ given\ margin\ below\ 0.\ *\ Note\ this\ can\ also\ be\ an\ auto-\/calibration\ approach}}
\DoxyCodeLine{00249\ \textcolor{comment}{//\ *\ Pressure\ sensor\ max\ point\ miscalibration\ (full\ force\ on\ pedal)\ ::\ When\ target\ set\ to\ max\ pressure,\ after\ motor\ moves\ to\ the\ point\ position\ isn't\ changing,\ the\ pressure\ reading\ deviates\ from\ max\ setting\ by\ more\ than\ a\ given\ margin.\ *\ Note\ this\ can\ also\ be\ an\ auto-\/calibration\ approach}}
\DoxyCodeLine{00250\ \textcolor{comment}{//\ *\ Position\ sensor\ problem\ ::\ When\ pressure\ is\ not\ near\ max,\ motor\ is\ driven\ more\ than\ X\ volt-\/seconds\ without\ position\ change\ (of\ the\ expected\ polarity).}}
\DoxyCodeLine{00251\ \textcolor{comment}{//\ *\ Brake\ motor\ problem\ ::\ When\ motor\ is\ driven\ more\ than\ X\ volt-\/seconds\ without\ any\ change\ (of\ the\ expected\ polarity)\ to\ either\ position\ or\ pressure.}}
\DoxyCodeLine{00252\ \textcolor{comment}{//\ *\ Brake\ calibration,\ idle\ high,\ or\ speedo\ sensor\ problem\ ::\ Motor\ retracted\ to\ near\ limit,\ with\ position\ decreased\ and\ pressure\ increased\ as\ expected,\ but\ speed\ doesn't\ settle\ toward\ 0.}}
\DoxyCodeLine{00253\ \textcolor{comment}{//\ *\ Pressure\ sensor\ problem\ ::\ If\ pressure\ reading\ is\ out\ of\ range,\ or\ ever\ changes\ in\ the\ unexpected\ direction\ during\ motor\ movement.}}
\DoxyCodeLine{00254\ \textcolor{comment}{//\ *\ Position\ sensor\ or\ limit\ switch\ problem\ ::\ If\ position\ reading\ is\ outside\ the\ range\ of\ the\ motor\ limit\ switches.}}
\DoxyCodeLine{00255\ \textcolor{comment}{//\ Steering:}}
\DoxyCodeLine{00256\ \textcolor{comment}{//\ *\ Chain\ derailment\ or\ motor\ or\ limit\ switch\ problem\ ::\ Motor\ told\ to\ drive\ for\ beyond\ X\ volt-\/seconds\ in\ one\ direction\ for\ >\ Y\ seconds.}}
\DoxyCodeLine{00257\ \textcolor{comment}{//\ Throttle/Engine:}}
\DoxyCodeLine{00258\ \textcolor{comment}{//\ *\ AirVelo/MAP/tach\ sensor\ failure\ ::\ If\ any\ of\ these\ three\ sensor\ readings\ are\ out\ of\ range\ to\ the\ other\ two.}}
\DoxyCodeLine{00259\ \textcolor{comment}{//\ Tach/Speedo:}}
\DoxyCodeLine{00260\ \textcolor{comment}{//\ *\ Sensor\ read\ problem\ ::\ Derivative\ of\ consecutive\ readings\ (rate\ of\ change)\ spikes\ higher\ than\ it's\ possible\ for\ the\ physical\ rotation\ to\ change\ -\/\ (indicates\ missing\ pulses)}}
\DoxyCodeLine{00261\ \textcolor{comment}{//\ *\ Disconnected/problematic\ speed\ sensor\ ::\ ignition\ is\ on,\ tach\ is\ nonzero,\ and\ runmode\ =\ hold/fly/cruise,\ yet\ speed\ is\ zero.\ Or,\ throttle\ is\ at\ idle\ and\ brake\ pressure\ high\ for\ enough\ time,\ yet\ speed\ readings\ are\ nonzero}}
\DoxyCodeLine{00262\ \textcolor{comment}{//\ *\ Disconnected/problematic\ tach\ sensor\ ::\ runmode\ is\ hold/fly/cruise,\ ignition\ is\ on\ and\ speed\ increases,\ but\ tach\ is\ below\ idle\ speed\ }}
\DoxyCodeLine{00263\ \textcolor{comment}{//\ Temperature:}}
\DoxyCodeLine{00264\ \textcolor{comment}{//\ *\ Engine\ temperature\ sensor\ problem\ ::\ Over\ X\ min\ elapsed\ with\ Ignition\ on\ and\ tach\ >=\ low\_idle,\ but\ engine\ temp\ is\ below\ nominal\ warmup\ temp.}}
\DoxyCodeLine{00265\ \textcolor{comment}{//\ *\ Cooling\ system,\ coolant,\ fan,\ thermostat,\ or\ coolant\ sensor\ problem\ ::\ Engine\ temp\ stays\ over\ \string~204\ for\ >=\ X\ min\ without\ coolant\ temp\ dropping\ due\ to\ fan.}}
\DoxyCodeLine{00266\ \textcolor{comment}{//\ *\ Axle,\ brake,\ etc.\ wheel\ issue\ or\ wheel\ sensor\ problem\ ::\ The\ hottest\ wheel\ temp\ is\ >=\ X\ degF\ hotter\ than\ the\ 2nd\ hottest\ wheel.}}
\DoxyCodeLine{00267\ \textcolor{comment}{//\ *\ Axle,\ brake,\ etc.\ wheel\ issue\ or\ wheel/ambient\ sensor\ problem\ ::\ A\ wheel\ temp\ >=\ X\ degF\ higher\ than\ ambient\ temp.}}
\DoxyCodeLine{00268\ \textcolor{comment}{//\ *\ Ignition\ problem,\ fire\ alarm,\ or\ temp\ sensor\ problem\ ::\ Ignition\ is\ off\ but\ a\ non-\/ambient\ temp\ reading\ increases\ to\ above\ ambient\ temp.}}
\DoxyCodeLine{00269\ \textcolor{comment}{//\ AirVelo:}}
\DoxyCodeLine{00270\ \textcolor{comment}{//\ *\ Air\ filter\ clogged,\ or\ carburetor\ problem\ ::\ Track\ ratio\ of\ massairflow/throttle\ angle\ whenever\ throttle\ is\ constant.\ Then,\ if\ that\ ratio\ lowers\ over\ time\ by\ X\ below\ that\ level,\ indicates\ restricted\ air.\ }}
\DoxyCodeLine{00271\ \textcolor{comment}{//\ Battery:}}
\DoxyCodeLine{00272\ \textcolor{comment}{//\ *\ Battery\ low\ ::\ Mulebatt\ readings\ average\ is\ below\ a\ given\ threshold}}
\DoxyCodeLine{00273\ \textcolor{comment}{//\ *\ Inadequate\ charging\ ::\ Mulebatt\ readings\ average\ has\ decreased\ over\ long\ time\ period}}
\DoxyCodeLine{00274\ \textcolor{comment}{//\ }}
\DoxyCodeLine{00275\ \textcolor{comment}{//\ More\ ideas\ to\ define\ better\ and\ implement:}}
\DoxyCodeLine{00276\ \textcolor{comment}{//\ *\ Check\ if\ the\ pressure\ response\ is\ characteristic\ of\ air\ being\ in\ the\ brake\ line.}}
\DoxyCodeLine{00277\ \textcolor{comment}{//\ *\ Axle/brake\ drum\ may\ be\ going\ bad\ (increased\ engine\ RPM\ needed\ to\ achieve\ certain\ speedo)\ \ (beware\ going\ up\ hill\ may\ look\ the\ same).}}
\DoxyCodeLine{00278\ \textcolor{comment}{//\ *\ E-\/brake\ has\ been\ left\ on\ (much\ the\ same\ symptoms\ as\ above?\ (beware\ going\ up\ hill\ may\ look\ the\ same)\ }}
\DoxyCodeLine{00279\ \textcolor{comment}{//\ *\ Carburetor\ not\ behaving\ (or\ air\ filter\ is\ clogged).\ (See\ above\ about\ engine\ deiseling\ -\/\ we\ can\ detect\ this!)}}
\DoxyCodeLine{00280\ \textcolor{comment}{//\ *\ After\ increasing\ braking,\ the\ actuator\ position\ changes\ in\ the\ opposite\ direction,\ or\ vise\ versa.}}
\DoxyCodeLine{00281\ \textcolor{comment}{//\ *\ Changing\ an\ actuator\ is\ not\ having\ the\ expected\ effect.}}
\DoxyCodeLine{00282\ \textcolor{comment}{//\ *\ A\ tunable\ value\ suspected\ to\ be\ out\ of\ tune.}}
\DoxyCodeLine{00283\ \textcolor{comment}{//\ *\ Check\ regularly\ for\ ridiculous\ shit.\ Compare\ our\ variable\ values\ against\ a\ predetermined\ list\ of\ conditions\ which\ shouldn't\ be\ possible\ or\ are\ at\ least\ very\ suspect.\ For\ example:}}
\DoxyCodeLine{00284\ \textcolor{comment}{//\ \ \ A)\ Sensor\ reading\ is\ out\ of\ range,\ or\ has\ changed\ faster\ than\ it\ ever\ should.}}
\DoxyCodeLine{00285\ \textcolor{comment}{//\ \ \ B)\ Stopping\ the\ car\ on\ entering\ hold/shutdown\ mode\ is\ taking\ longer\ than\ it\ ever\ should.}}
\DoxyCodeLine{00286\ \textcolor{comment}{//\ \ \ C)\ Mule\ seems\ to\ be\ accelerating\ like\ a\ Tesla.}}
\DoxyCodeLine{00287\ \textcolor{comment}{//\ \ \ D)\ Car\ is\ accelerating\ yet\ engine\ is\ at\ idle.}}
\DoxyCodeLine{00288\ \textcolor{comment}{//\ *\ The\ control\ system\ has\ nonsensical\ values\ in\ its\ variables.}}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \textcolor{comment}{//\ more\ notes\ on\ brake\ error\ detection\ ideas:}}
\DoxyCodeLine{00291\ \textcolor{comment}{//\ 1.\ Detect\ \ brake\ chain\ is\ not\ connected\ (evidenced\ by\ change\ in\ brake\ position\ without\ expected\ pressure\ changes)}}
\DoxyCodeLine{00292\ \textcolor{comment}{//\ 2.\ Detect\ obstruction,\ motor\ failure,\ or\ inaccurate\ position.\ Evidenced\ by\ motor\ instructed\ to\ move\ but\ position\ not\ changing\ even\ when\ pressure\ is\ low.}}
\DoxyCodeLine{00293\ \textcolor{comment}{//\ 3.\ Detet\ brake\ hydraulics\ failure\ or\ inaccurate\ pressure.\ Evidenced\ by\ normal\ positional\ change\ not\ causing\ expected\ increase\ in\ pressure.}}
\DoxyCodeLine{00294\ \textcolor{comment}{//\ retract\_effective\_max\_us\ =\ volt[STOP]\ +\ duty\_pc\ *\ (volt[OPMAX]\ -\/\ volt[STOP]);\ \ //\ Stores\ instantaneous\ calculated\ value\ of\ the\ effective\ maximum\ pulsewidth\ after\ attenuation}}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_loop_timer}{LoopTimer}}\ \{}
\DoxyCodeLine{00297\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00298\ \ \ \ \ \mbox{\hyperlink{class_loop_timer}{LoopTimer}}()\ \{\}}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{comment}{//\ Loop\ timing\ related}}
\DoxyCodeLine{00300\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ loop\_timer\ =\ \mbox{\hyperlink{class_timer}{Timer}}(1000000);\ \ \textcolor{comment}{//\ how\ long\ the\ previous\ main\ loop\ took\ to\ run\ (in\ us)}}
\DoxyCodeLine{00301\ \ \ \ \ int32\_t\ loopno\ =\ 1,\ loopindex\ =\ 0,\ loop\_recentsum\ =\ 0,\ loop\_scale\_min\_us\ =\ 0,\ loop\_scale\_avg\_max\_us\ =\ 2500,\ loop\_scale\_peak\_max\_us\ =\ 25000;}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keywordtype}{float}\ loop\_sum\_s,\ loopfreq\_hz;}
\DoxyCodeLine{00303\ \ \ \ \ uint32\_t\ looptimes\_us[20];}
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{keywordtype}{bool}\ loop\_dirty[20];}
\DoxyCodeLine{00305\ \ \ \ \ int64\_t\ loop\_cout\_mark\_us,\ boot\_mark;}
\DoxyCodeLine{00306\ \ \ \ \ uint32\_t\ loop\_cout\_us\ =\ 0,\ loop\_peak\_us\ =\ 0,\ loop\_now\ =\ 0;;}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ uint32\_t\ loop\_history\ =\ 100;}
\DoxyCodeLine{00308\ \ \ \ \ uint32\_t\ loop\_periods\_us[loop\_history];}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{comment}{//\ std::vector<std::string>\ loop\_names(20);}}
\DoxyCodeLine{00310\ \ \ \ \ std::string\ loop\_names[20];}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{\ \ \textcolor{comment}{//\ Run\ once\ at\ end\ of\ setup()}}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ boot\_mark\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (looptime\_print)\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ x=1;\ x<arraysize(loop\_dirty);\ x++)\ loop\_dirty[x]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \ \ loop\_names[0]\ =\ std::string(\textcolor{stringliteral}{"{}top"{}});}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ \ \ loop\_dirty[0]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ loopindex\ =\ 1;}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ looptimes\_us[0]\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ loop\_timer.reset();\ \ \textcolor{comment}{//\ start\ timer\ to\ measure\ the\ first\ loop}}
\DoxyCodeLine{00321\ \ \ \ \ \}}
\DoxyCodeLine{00322\ \ \ \ \ \textcolor{keywordtype}{void}\ mark(std::string\ loopname\ =\ std::string(\textcolor{stringliteral}{"{}"{}}))\ \{\ \ \textcolor{comment}{//\ Add\ marks\ wherever\ you\ want\ in\ the\ main\ loop,\ set\ looptime\_print\ true,\ will\ report\ times\ between\ all\ adjacent\ marks}}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (looptime\_print)\ \{}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (loop\_dirty[loopindex])\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ loop\_names[loopindex]\ =\ loopname;\ \ \textcolor{comment}{//\ names[index],\ name);}}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ loop\_dirty[loopindex]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ looptimes\_us[loopindex]\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ loopindex++;}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00331\ \ \ \ \ \}}
\DoxyCodeLine{00332\ \ \ \ \ \textcolor{keywordtype}{float}\ calc\_avg(uint32\_t\ \_loop\_now,\ uint32\_t\ \_thisloop)\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_loop\_now\ ==\ loop\_history\ +\ 2)\ \{}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \ \ \ \ loop\_recentsum\ =\ \_thisloop;}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <=\ loop\_history;\ l++)}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ loop\_recentsum\ +=\ loop\_periods\_us[(\_loop\_now\ +\ l)\ \%\ loop\_history];}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ loop\_recentsum\ +=\ \_thisloop\ -\/\ loop\_periods\_us[loop\_now];}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{float})loop\_recentsum/(float)loop\_history;}
\DoxyCodeLine{00340\ \ \ \ \ \}}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{\ \ \textcolor{comment}{//\ Call\ once\ each\ loop\ at\ the\ very\ end}}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ uint32\_t\ thisloop\ =\ (uint32\_t)loop\_timer.elapsed();}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ loop\_avg\_us\ =\ calc\_avg(loop\_now,\ thisloop);}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ loop\_periods\_us[loop\_now]\ =\ thisloop;\ \ \textcolor{comment}{//\ us\ since\ beginning\ of\ this\ loop}}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ loop\_timer.reset();}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ loop\_sum\_s\ +=\ (float)loop\_periods\_us[loop\_now]\ /\ 1000000;}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ema\_filt(loop\_periods\_us[loop\_now],\ \&loop\_avg\_us,\ 0.01);}}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (loop\_avg\_us\ >\ 1)\ loopfreq\_hz\ =\ 1000000/loop\_avg\_us;}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ loop\_peak\_us\ =\ 0;}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int8\_t\ i=0;\ i<loop\_history;\ i++)\ \textcolor{keywordflow}{if}\ (loop\_peak\_us\ <\ loop\_periods\_us[i])\ loop\_peak\_us\ =\ loop\_periods\_us[i];\ }
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (looptime\_print)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \ \ \ \ loop\_cout\_mark\_us\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ std::fixed\ <<\ std::setprecision(0);}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r"{}}\ <<\ (uint32\_t)loop\_sum\_s\ <<\ \textcolor{stringliteral}{"{}s\ \#"{}}\ <<\ loopno;\ \ \textcolor{comment}{//\ \ <<\ "{}\ av:"{}\ <<\ std::setw(5)\ <<\ (int32\_t)(loop\_avg\_us);\ \ //\ \ <<\ "{}\ av:"{}\ <<\ std::setw(3)\ <<\ loop\_avg\_ms\ }}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ :\ "{}}\ <<\ std::setw(5)\ <<\ loop\_periods\_us[loop\_now]\ <<\ \textcolor{stringliteral}{"{}\ ("{}}\ <<\ std::setw(5)\ <<\ loop\_periods\_us[loop\_now]-\/loop\_cout\_us\ <<\ \textcolor{stringliteral}{"{})us\ "{}};\ \ \textcolor{comment}{//\ <<\ "{}\ avg:"{}\ <<\ loop\_avg\_us;\ \ //\ \ "{}\ us:"{}\ <<\ esp\_timer\_get\_time()\ <<\ }}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (int32\_t\ x=1;\ x<loopindex;\ x++)}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ std::setw(3)\ <<\ loop\_names[x]\ <<\ \textcolor{stringliteral}{"{}:"{}}\ <<\ std::setw(5)\ <<\ looptimes\_us[x]-\/looptimes\_us[x-\/1]\ <<\ \textcolor{stringliteral}{"{}\ "{}};}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ cout:"{}}\ <<\ std::setw(5)\ <<\ loop\_cout\_us;}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (loop\_periods\_us[loop\_now]-\/loop\_cout\_us\ >\ looptime\_linefeed\_threshold\ ||\ !looptime\_linefeed\_threshold)\ std::cout\ <<\ std::endl;}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \ \ \ \ loop\_cout\_us\ =\ (uint32\_t)(esp\_timer\_get\_time()\ -\/\ loop\_cout\_mark\_us);}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \ \ \ \ loopindex\ =\ 0;}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \ \ \ \ mark\ (\textcolor{stringliteral}{"{}top"{}});}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ ++loop\_now\ \%=\ loop\_history;}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ loopno++;\ \ \textcolor{comment}{//\ I\ like\ to\ count\ how\ many\ loops}}
\DoxyCodeLine{00366\ \ \ \ \ \}}
\DoxyCodeLine{00367\ \ \ \ \ \textcolor{keywordtype}{float}\ uptime()\ \{\ \ \textcolor{comment}{//\ returns\ uptime\ since\ last\ reset\ in\ minutes}}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{float})((esp\_timer\_get\_time()\ -\/\ boot\_mark))\ /\ (60.0\ *\ 1000000.0);}
\DoxyCodeLine{00369\ \ \ \ \ \}}
\DoxyCodeLine{00370\ \};}
\DoxyCodeLine{00371\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_boot_monitor}{BootMonitor}}\ \{}
\DoxyCodeLine{00372\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00373\ \ \ \ \ \textcolor{keywordtype}{int}\ timeout\_sec\ =\ 10;}
\DoxyCodeLine{00374\ \ \ \ \ uint32\_t\ uptime\_recorded\ =\ -\/1,\ uptime\_rounding\ =\ 5;}
\DoxyCodeLine{00375\ \ \ \ \ Preferences*\ myprefs;}
\DoxyCodeLine{00376\ \ \ \ \ \mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ myloop;}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordtype}{int}\ codestatus\_last\ =\ 50000,\ crashcount\ =\ 0;}
\DoxyCodeLine{00378\ \ \ \ \ uint32\_t\ bootcount;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ variable\ to\ track\ total\ number\ of\ boots\ of\ this\ code\ build}}
\DoxyCodeLine{00379\ \ \ \ \ uint32\_t\ codestatus\_postmortem;}
\DoxyCodeLine{00380\ \ \ \ \ std::string\ codestatuscard[NumCodeStatuses]\ =\ \{\ \textcolor{stringliteral}{"{}confused"{}},\ \textcolor{stringliteral}{"{}booting"{}},\ \textcolor{stringliteral}{"{}parked"{}},\ \textcolor{stringliteral}{"{}stopped"{}},\ \textcolor{stringliteral}{"{}driving"{}}\ \};}
\DoxyCodeLine{00381\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ highWaterTimer\{30000000\};}
\DoxyCodeLine{00382\ \ \ \ \ TaskHandle\_t*\ task1;\ TaskHandle\_t*\ task2;\ TaskHandle\_t*\ task3;\ TaskHandle\_t*\ task4;}
\DoxyCodeLine{00383\ \ \ \ \ UBaseType\_t\ highWaterBytes;}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{keywordtype}{bool}\ was\_panicked\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00385\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00386\ \ \ \ \ \textcolor{keywordtype}{int}\ boot\_to\_runmode\ =\ SHUTDOWN;}
\DoxyCodeLine{00387\ \ \ \ \ \mbox{\hyperlink{class_boot_monitor}{BootMonitor}}(Preferences*\ \_prefs,\ \mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ \_loop)\ :\ myprefs(\_prefs),\ myloop(\_loop)\ \{\}}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_codestatus(\textcolor{keywordtype}{int}\ \_mode)\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ codestatus\ =\ \_mode;}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (codestatus\_last\ !=\ codestatus)\ myprefs-\/>putUInt(\textcolor{stringliteral}{"{}codestatus"{}},\ codestatus);}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \ \ codestatus\_last\ =\ codestatus;}
\DoxyCodeLine{00392\ \ \ \ \ \}}
\DoxyCodeLine{00393\ \ \ \ \ \textcolor{keywordtype}{void}\ setup(TaskHandle\_t*\ t1,\ TaskHandle\_t*\ t2,\ TaskHandle\_t*\ t3,\ TaskHandle\_t*\ t4,\ \textcolor{keywordtype}{int}\ sec\ =\ -\/1)\ \{}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \ \ task1\ =\ t1;\ \ task2\ =\ t2;\ \ task3\ =\ t3;\ \ task4\ =\ t4;}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sec\ >=\ 0)\ timeout\_sec\ =\ sec;}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ myprefs-\/>begin(\textcolor{stringliteral}{"{}FlyByWire"{}},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ bootcounter();}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ set\_codestatus(Booting);}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ print\_postmortem();}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \ \ recover\_status();}
\DoxyCodeLine{00401\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!watchdog\_enabled)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00402\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Boot\ manager..\ \(\backslash\)n"{}});}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ esp\_task\_wdt\_init(timeout\_sec,\ \textcolor{keyword}{true});\ \ \textcolor{comment}{//\ see\ https://github.com/espressif/esp-\/idf/blob/master/examples/system/task\_watchdog/main/task\_watchdog\_example\_main.c}}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ esp\_task\_wdt\_add(NULL);}
\DoxyCodeLine{00405\ \ \ \ \ \}}
\DoxyCodeLine{00406\ \ \ \ \ \textcolor{keywordtype}{void}\ pet()\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!watchdog\_enabled)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ esp\_task\_wdt\_reset();}
\DoxyCodeLine{00409\ \ \ \ \ \}}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{keywordtype}{void}\ add(TaskHandle\_t\ taskh)\ \{}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!watchdog\_enabled)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \ \ esp\_task\_wdt\_add(taskh);}
\DoxyCodeLine{00413\ \ \ \ \ \}}
\DoxyCodeLine{00414\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ pet();}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (codestatus\ ==\ Booting)\ set\_codestatus(Confused);\ \ \textcolor{comment}{//\ we\ are\ not\ booting\ any\ more}}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ write\_uptime();}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ print\_high\_water(task1,\ task2,\ task3,\ task4);}
\DoxyCodeLine{00419\ \ \ \ \ \}}
\DoxyCodeLine{00420\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{keywordtype}{void}\ bootcounter()\ \{}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \ \ bootcount\ =\ myprefs-\/>getUInt(\textcolor{stringliteral}{"{}bootcount"{}},\ 0)\ +\ 1;}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ \ myprefs-\/>putUInt(\textcolor{stringliteral}{"{}bootcount"{}},\ bootcount);}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ codestatus\_postmortem\ =\ myprefs-\/>getUInt(\textcolor{stringliteral}{"{}codestatus"{}},\ Confused);}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \ \ crashcount\ =\ myprefs-\/>getUInt(\textcolor{stringliteral}{"{}crashcount"{}},\ 0);}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (codestatus\_postmortem\ !=\ Parked)\ crashcount++;}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ myprefs-\/>putUInt(\textcolor{stringliteral}{"{}crashcount"{}},\ crashcount);}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ was\_panicked\ =\ (bool)myprefs-\/>getUInt(\textcolor{stringliteral}{"{}panicstop"{}},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00429\ \ \ \ \ \}}
\DoxyCodeLine{00430\ \ \ \ \ \textcolor{keywordtype}{void}\ write\_uptime()\ \{}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ get\_uptime\ =\ myloop-\/>uptime();}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ uint32\_t\ myround\ =\ std::min((uint32\_t)get\_uptime,\ uptime\_rounding);}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ uint32\_t\ uptime\_new\ =\ (uint32\_t)(get\_uptime\ /\ (\textcolor{keywordtype}{float})myround)\ *\ myround;}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (uptime\_new\ ==\ uptime\_recorded)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ myprefs-\/>putUInt(\textcolor{stringliteral}{"{}uptime"{}},\ uptime\_new);}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ uptime\_recorded\ =\ uptime\_new;}
\DoxyCodeLine{00437\ \ \ \ \ \}}
\DoxyCodeLine{00438\ \ \ \ \ \textcolor{keywordtype}{void}\ print\_postmortem()\ \{}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Boot\ count:\ \%d\ (\%d/\%d).\ Last\ lost\ power\ while\ \%s"{}},\ bootcount,\ bootcount-\/crashcount,\ crashcount,\ codestatuscard[codestatus\_postmortem].c\_str());}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (was\_panicked)\ Serial.printf(\textcolor{stringliteral}{"{}\ and\ panicking,"{}});}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}\ after\ "{}});}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ uint32\_t\ last\_uptime\ =\ myprefs-\/>getUInt(\textcolor{stringliteral}{"{}uptime"{}},\ 0);}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_uptime\ >\ 0)\ \{}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}just\ over\ \%d\ min\ uptime\(\backslash\)n"{}},\ last\_uptime);}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \ \ \ \ write\_uptime();}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.printf(\textcolor{stringliteral}{"{}under\ 1\ min\ uptime\(\backslash\)n"{}});}
\DoxyCodeLine{00448\ \ \ \ \ \}}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{keywordtype}{void}\ print\_high\_water(xTaskHandle*\ t1,\ xTaskHandle*\ t2,\ xTaskHandle*\ t3,\ xTaskHandle*\ t4)\ \{}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (print\_task\_stack\_usage\ \&\&\ highWaterTimer.expireset())\ \{}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}mem\ minfree(B):\ heap:\%d"{}},\ xPortGetMinimumEverFreeHeapSize());\ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ \ \ \ \ highWaterBytes\ =\ uxTaskGetStackHighWaterMark(*t1)\ *\ \textcolor{keyword}{sizeof}(StackType\_t);}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}\ temptask:\%d"{}},\ highWaterBytes);}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \ \ \ \ highWaterBytes\ =\ uxTaskGetStackHighWaterMark(*t2)\ *\ \textcolor{keyword}{sizeof}(StackType\_t);}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{},\ webtask:\%d"{}},\ highWaterBytes);}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \ \ \ \ highWaterBytes\ =\ uxTaskGetStackHighWaterMark(*t3)\ *\ \textcolor{keyword}{sizeof}(StackType\_t);}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{},\ drawtask:\%d"{}},\ highWaterBytes);}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ \ \ \ highWaterBytes\ =\ uxTaskGetStackHighWaterMark(*t4)\ *\ \textcolor{keyword}{sizeof}(StackType\_t);}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{},\ pushtask:\%d\(\backslash\)n"{}},\ highWaterBytes);}
\DoxyCodeLine{00460\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00461\ \ \ \ \ \}}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{keywordtype}{void}\ recover\_status()\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((codestatus\_postmortem\ !=\ Driving\ \&\&\ codestatus\_postmortem\ !=\ Stopped)\ ||\ !crash\_driving\_recovery)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (was\_panicked)\ \{}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}\ \ Continuing\ to\ panic..\(\backslash\)n"{}});}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ \ \ \ \ ignition.panic\_request(REQ\_ON);}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}\ \ Resuming\ \%s\ status..\(\backslash\)n"{}},\ codestatuscard[codestatus\_postmortem]);}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \ \ boot\_to\_runmode\ =\ (codestatus\_postmortem\ ==\ Driving)\ ?\ FLY\ :\ HOLD;}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \ \ ignition.request(REQ\_ON);}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gas.(brake.pc[STOP]);\ \ //\ brake.pid\_targ\_pc(brake.pc[STOP]);}}
\DoxyCodeLine{00473\ \ \ \ \ \}}
\DoxyCodeLine{00474\ \};}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \textcolor{comment}{//\ Moved\ sdcard\ code\ into\ diag.h\ to\ reduce\ file\ count.\ these\ includes\ go\ with\ it}}
\DoxyCodeLine{00477\ \textcolor{preprocessor}{\#include\ <iostream>}}
\DoxyCodeLine{00478\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00479\ \textcolor{preprocessor}{\#include\ <iomanip>}}
\DoxyCodeLine{00480\ \textcolor{preprocessor}{\#include\ <SD.h>}}
\DoxyCodeLine{00481\ \textcolor{preprocessor}{\#include\ <FFat.h>}}
\DoxyCodeLine{00482\ \textcolor{preprocessor}{\#include\ <LovyanGFX.hpp>}}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \textcolor{preprocessor}{\#define\ FORMAT\_FFAT\ true\ \ }\textcolor{comment}{//\ You\ only\ need\ to\ format\ FFat\ the\ first\ time\ you\ use\ a\ specific\ card}}
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_sd_card}{SdCard}}\ \{}
\DoxyCodeLine{00487\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00488\ \ \ \ \ \textcolor{comment}{//\ LGFX*\ lcd;}}
\DoxyCodeLine{00489\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ capture\_timer\{5000000\};}
\DoxyCodeLine{00490\ \ \ \ \ \textcolor{keywordtype}{int}\ capcount\ =\ 0,\ capmax\ =\ 100;}
\DoxyCodeLine{00491\ \ \ \ \ \textcolor{keywordtype}{char}\ filenamebase[11]\ =\ \textcolor{stringliteral}{"{}/screencap"{}};}
\DoxyCodeLine{00492\ \ \ \ \ \textcolor{keywordtype}{char}\ extension[5]\ =\ \textcolor{stringliteral}{"{}.bmp"{}};}
\DoxyCodeLine{00493\ \textcolor{preprocessor}{\ \ \ \ \#ifndef\ SDCARD\_SPI}}
\DoxyCodeLine{00494\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \#define\ SDCARD\_SPI\ SPI}}
\DoxyCodeLine{00495\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00496\ \ \ \ \ std::string\ filename\_seq(\textcolor{keywordtype}{int}\ num)\ \{}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ std::string\ writefile\ =\ filenamebase\ +\ std::string(2\ -\/\ std::to\_string(num).length(),\ \textcolor{charliteral}{'0'});\ \textcolor{comment}{//\ Add\ leading\ zeros}}
\DoxyCodeLine{00498\ \ \ \ \ \ \ \ \ writefile\ +=\ std::to\_string(num)\ +\ extension;}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ writefile;}
\DoxyCodeLine{00500\ \ \ \ \ \}}
\DoxyCodeLine{00501\ \ \ \ \ std::string\ saveToSD(\textcolor{keywordtype}{int}\ num)\ \{}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ std::string\ filename\ =\ filename\_seq(num);}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ result\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ File\ file\ =\ SD.open(filename.c\_str(),\ \textcolor{stringliteral}{"{}w"{}});}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file)\ \{}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ width\ =\ 320;\ \textcolor{comment}{//\ \ =\ lcd-\/>width();}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ height\ =\ 240;\ \textcolor{comment}{//\ =\ lcd-\/>height();}}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ rowSize\ =\ (2\ *\ width\ +\ 3)\ \&\ \string~\ 3;\ \ \textcolor{comment}{//\ int\ rowSize\ =\ (3\ *\ width\ +\ 3)\ \&\ \string~\ 3;\ \ //\ 24-\/bit\ version}}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \ \ \ \ \ \ lgfx::bitmap\_header\_t\ bmpheader;}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.bfType\ =\ 0x4D42;}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.bfSize\ =\ rowSize\ *\ height\ +\ \textcolor{keyword}{sizeof}(bmpheader);}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.bfOffBits\ =\ \textcolor{keyword}{sizeof}(bmpheader);}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biSize\ =\ 40;}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biWidth\ =\ width;}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biHeight\ =\ height;}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biPlanes\ =\ 1;}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biBitCount\ =\ 16;\ \ \textcolor{comment}{//\ bmpheader.biBitCount\ =\ 24;\ \ //\ 24-\/bit\ version}}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \ \ \ \ bmpheader.biCompression\ =\ 3;\ \ \textcolor{comment}{//\ bmpheader.biCompression\ =\ 0;\ \ //\ 24-\/bit\ version}}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \ \ file.write((std::uint8\_t*)\&bmpheader,\ \textcolor{keyword}{sizeof}(bmpheader));}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \ \ \ \ std::uint8\_t\ buffer[rowSize];}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \ \ \ \ memset(\&buffer[rowSize\ -\/\ 4],\ 0,\ 4);}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y\ =\ 240\ -\/\ 1;\ y\ >=\ 0;\ y-\/-\/)\ \{}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>readRect(0,\ y,\ lcd-\/>width(),\ 1,\ (lgfx::rgb565\_t*)buffer);}}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ //\ lcd-\/>readRect(0,\ y,\ lcd-\/>width(),\ 1,\ (lgfx::rgb888\_t*)buffer);\ \ //\ 24\ bit\ color\ version}}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ file.write(buffer,\ rowSize);}
\DoxyCodeLine{00526\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \ \ \ \ result\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00530\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.print(\textcolor{stringliteral}{"{}error:file\ open\ failure\(\backslash\)n"{}});}
\DoxyCodeLine{00531\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ filename;}
\DoxyCodeLine{00532\ \ \ \ \ \}}
\DoxyCodeLine{00533\ \ \ \ \ \textcolor{keywordtype}{void}\ draw\_bmp\_file(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ ++capcount\ \%=\ capmax;}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \ \ std::string\ wfile\ =\ filename\_seq(capcount);}
\DoxyCodeLine{00536\ }
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>drawBmpFile(SD,\ wfile.c\_str(),\ random(-\/20,20),\ random(-\/20,\ 20));\ \ //\ drawBmpFile(fs,\ path,\ x,\ y,\ maxWidth,\ maxHeight,\ offX,\ offY,\ scale\_x,\ scale\_y,\ datum);}}
\DoxyCodeLine{00538\ }
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}wrote:\ \%s\(\backslash\)n"{}},\ wfile.c\_str());}
\DoxyCodeLine{00540\ \ \ \ \ \}}
\DoxyCodeLine{00541\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{comment}{//\ SdCard(LGFX*\ \_lcd\(\backslash\)\(\backslash\))\ :\ lcd(\_lcd)\ \{\}}}
\DoxyCodeLine{00543\ \ \ \ \ \mbox{\hyperlink{class_sd_card}{SdCard}}()\ \{\}}
\DoxyCodeLine{00544\ }
\DoxyCodeLine{00545\ \ \ \ \ \textcolor{keywordtype}{void}\ setup(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>init();}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.begin(115200);}}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>setColorDepth(16);}}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>setColor(TFT\_WHITE);}}
\DoxyCodeLine{00550\ }
\DoxyCodeLine{00551\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>startWrite();}}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>setAddrWindow(0,\ 0,\ lcd-\/>width(),\ lcd-\/>height());}}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ for\ (int\ y\ =\ 0;\ y\ <\ lcd-\/>height();\ ++y)\ }}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ for\ (int\ x\ =\ 0;\ x\ <\ lcd-\/>width();\ ++x)\ }}
\DoxyCodeLine{00555\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ lcd-\/>writeColor(\ lcd-\/>color888(x\ <<\ 1,\ x\ +\ y,\ y\ <<\ 1),\ 1);}}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.printf("{}BMP\ save\ test\(\backslash\)n"{});}}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>endWrite();}}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ for\ (int\ i=0;\ i<capmax;\ i++)\ \{}}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ int\ i\ =\ 0;}}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ std::string\ filename\ =\ filename\_seq(i);}}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ do\ \{}}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ SD.end();}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ delay(1000);}}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ SD.begin(sdcard\_cs\_pin,\ SDCARD\_SPI,\ 25000000);}}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \}\ while\ (!saveToSD(filename));}}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.printf("{}BMP\ save\ \%s\ success\(\backslash\)n"{},\ filename.c\_str());}}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ lcd-\/>setAddrWindow(0,\ 0,\ 320,\ 240);}}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \ \ \ \ \}}
\DoxyCodeLine{00572\ }
\DoxyCodeLine{00573\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (capture\_timer.expireset())\ \{}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ \ \ \ \ ++capcount\ \%=\ capmax;}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ wfile\ =\ saveToSD(capcount);}
\DoxyCodeLine{00577\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}wrote:\ \%s\(\backslash\)n"{}},\ wfile.c\_str());}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00579\ \ \ \ \ \}}
\DoxyCodeLine{00580\ \};}
\DoxyCodeLine{00581\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_fat_fs}{FatFs}}\ \{}
\DoxyCodeLine{00582\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00583\ \ \ \ \ \textcolor{comment}{//\ This\ file\ should\ be\ compiled\ with\ 'Partition\ Scheme'\ (in\ Tools\ menu)}}
\DoxyCodeLine{00584\ \ \ \ \ \textcolor{comment}{//\ set\ to\ 'Default\ with\ ffat'\ if\ you\ have\ a\ 4MB\ ESP32\ dev\ module\ or}}
\DoxyCodeLine{00585\ \ \ \ \ \textcolor{comment}{//\ set\ to\ '16M\ Fat'\ if\ you\ have\ a\ 16MB\ ESP32\ dev\ module.}}
\DoxyCodeLine{00586\ \ \ \ \ \mbox{\hyperlink{class_fat_fs}{FatFs}}()\ \{\}}
\DoxyCodeLine{00587\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00588\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ format:\ allocation\ unit\ size\ must\ be\ a\ power\ of\ 2,\ w/\ min=sector\_size,\ max=128*sector\_size.\ setting\ to\ 0\ will\ result\ in\ allocation\ unit\ set\ to\ the\ sector\ size.\ larger\ is\ faster\ but\ with\ more\ wasted\ space\ when\ files\ are\ small}}
\DoxyCodeLine{00589\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ sector\ size\ is\ always\ 512\ B.\ For\ wear\ levelling,\ sector\ size\ is\ determined\ by\ CONFIG\_WL\_SECTOR\_SIZE\ option\ of\ esp\_vfs\_fat\_mount\_config\_t.}}
\DoxyCodeLine{00590\ \ \ \ \ \ \ \ \ Serial.setDebugOutput(\textcolor{keyword}{true});}
\DoxyCodeLine{00591\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (FORMAT\_FFAT)\ FFat.format();}
\DoxyCodeLine{00592\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!FFat.begin())\{}
\DoxyCodeLine{00593\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}fatfs\ mount\ failed\(\backslash\)n"{}});}
\DoxyCodeLine{00594\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}fatfs\ mounted\ on\ /sd\(\backslash\)n"{}});}
\DoxyCodeLine{00597\ \ \ \ \ \}}
\DoxyCodeLine{00598\ \ \ \ \ \textcolor{keywordtype}{void}\ fattest()\ \{}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Total\ space:\ \%10u\(\backslash\)n"{}},\ FFat.totalBytes());}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Free\ space:\ \%10u\(\backslash\)n"{}},\ FFat.freeBytes());}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ listDir(FFat,\ \textcolor{stringliteral}{"{}/"{}},\ 0);}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ writeFile(FFat,\ \textcolor{stringliteral}{"{}/hello.txt"{}},\ \textcolor{stringliteral}{"{}Hello\ "{}});}
\DoxyCodeLine{00603\ \ \ \ \ \ \ \ \ appendFile(FFat,\ \textcolor{stringliteral}{"{}/hello.txt"{}},\ \textcolor{stringliteral}{"{}World!\(\backslash\)r\(\backslash\)n"{}});}
\DoxyCodeLine{00604\ \ \ \ \ \ \ \ \ readFile(FFat,\ \textcolor{stringliteral}{"{}/hello.txt"{}});}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \ \ renameFile(FFat,\ \textcolor{stringliteral}{"{}/hello.txt"{}},\ \textcolor{stringliteral}{"{}/foo.txt"{}});}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \ \ readFile(FFat,\ \textcolor{stringliteral}{"{}/foo.txt"{}});}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ deleteFile(FFat,\ \textcolor{stringliteral}{"{}/foo.txt"{}});}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ testFileIO(FFat,\ \textcolor{stringliteral}{"{}/test.txt"{}});}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Free\ space:\ \%10u\(\backslash\)n"{}},\ FFat.freeBytes());}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ deleteFile(FFat,\ \textcolor{stringliteral}{"{}/test.txt"{}});}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ Serial.println(\ \textcolor{stringliteral}{"{}Test\ complete"{}}\ );}
\DoxyCodeLine{00612\ \ \ \ \ \}}
\DoxyCodeLine{00613\ \ \ \ \ \textcolor{keywordtype}{void}\ listDir(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ dirname,\ uint8\_t\ levels)\ \{}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Listing\ directory:\ \%s\(\backslash\)r\(\backslash\)n"{}},\ dirname);}
\DoxyCodeLine{00615\ }
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ File\ root\ =\ fs.open(dirname);}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!root)\{}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ directory"{}});}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00620\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!root.isDirectory())\{}
\DoxyCodeLine{00622\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}\ -\/\ not\ a\ directory"{}});}
\DoxyCodeLine{00623\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00624\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00625\ }
\DoxyCodeLine{00626\ \ \ \ \ \ \ \ \ File\ file\ =\ root.openNextFile();}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}(file)\{}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file.isDirectory())\{}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}\ \ DIR\ :\ "{}});}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(file.name());}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (levels)\ listDir(fs,\ file.path(),\ levels\ -\/1);}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}\ \ FILE:\ "{}});}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(file.name());}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}\(\backslash\)tSIZE:\ "{}});}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(file.size());}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ \ \ \ \ file\ =\ root.openNextFile();}
\DoxyCodeLine{00640\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00641\ \ \ \ \ \}}
\DoxyCodeLine{00642\ }
\DoxyCodeLine{00643\ \ \ \ \ \textcolor{keywordtype}{void}\ readFile(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path)\ \{}
\DoxyCodeLine{00644\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Reading\ file:\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path);}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00646\ \ \ \ \ \ \ \ \ File\ file\ =\ fs.open(path);}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!file\ ||\ file.isDirectory())\{}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ file\ for\ reading"{}});}
\DoxyCodeLine{00649\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ read\ from\ file:"{}});}
\DoxyCodeLine{00653\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (file.available())\ Serial.write(file.read());}
\DoxyCodeLine{00654\ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00655\ \ \ \ \ \}}
\DoxyCodeLine{00656\ }
\DoxyCodeLine{00657\ \ \ \ \ \textcolor{keywordtype}{void}\ writeFile(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ message)\ \{}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Writing\ file:\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path);}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ File\ file\ =\ fs.open(path,\ FILE\_WRITE);}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!file)\{}
\DoxyCodeLine{00662\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ file\ for\ writing"{}});}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file.print(message))\ Serial.println(\textcolor{stringliteral}{"{}-\/\ file\ written"{}});}
\DoxyCodeLine{00666\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.println(\textcolor{stringliteral}{"{}-\/\ write\ failed"{}});}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00668\ \ \ \ \ \}}
\DoxyCodeLine{00669\ }
\DoxyCodeLine{00670\ \ \ \ \ \textcolor{keywordtype}{void}\ appendFile(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ message)\ \{}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Appending\ to\ file:\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path);}
\DoxyCodeLine{00672\ }
\DoxyCodeLine{00673\ \ \ \ \ \ \ \ \ File\ file\ =\ fs.open(path,\ FILE\_APPEND);}
\DoxyCodeLine{00674\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!file)\{}
\DoxyCodeLine{00675\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ file\ for\ appending"{}});}
\DoxyCodeLine{00676\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00678\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file.print(message))\ Serial.println(\textcolor{stringliteral}{"{}-\/\ message\ appended"{}});}
\DoxyCodeLine{00679\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.println(\textcolor{stringliteral}{"{}-\/\ append\ failed"{}});}
\DoxyCodeLine{00680\ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00681\ \ \ \ \ \}}
\DoxyCodeLine{00682\ \ \ \ \ \textcolor{keywordtype}{void}\ renameFile(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path1,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path2)\ \{}
\DoxyCodeLine{00683\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Renaming\ file\ \%s\ to\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path1,\ path2);}
\DoxyCodeLine{00684\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fs.rename(path1,\ path2))\ Serial.println(\textcolor{stringliteral}{"{}-\/\ file\ renamed"{}});}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.println(\textcolor{stringliteral}{"{}-\/\ rename\ failed"{}});}
\DoxyCodeLine{00686\ \ \ \ \ \}}
\DoxyCodeLine{00687\ \ \ \ \ \textcolor{keywordtype}{void}\ deleteFile(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path)\ \{}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Deleting\ file:\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path);}
\DoxyCodeLine{00689\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fs.remove(path))\ Serial.println(\textcolor{stringliteral}{"{}-\/\ file\ deleted"{}});}
\DoxyCodeLine{00690\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.println(\textcolor{stringliteral}{"{}-\/\ delete\ failed"{}});}
\DoxyCodeLine{00691\ \ \ \ \ \}}
\DoxyCodeLine{00692\ \ \ \ \ \textcolor{keywordtype}{void}\ testFileIO(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ path)\ \{}
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Testing\ file\ I/O\ with\ \%s\(\backslash\)r\(\backslash\)n"{}},\ path);}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00695\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ uint8\_t\ buf[512];}
\DoxyCodeLine{00696\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ len\ =\ 0;}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \ \ File\ file\ =\ fs.open(path,\ FILE\_WRITE);}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!file)\ \{}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ file\ for\ writing"{}});}
\DoxyCodeLine{00700\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00701\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00702\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ i;}
\DoxyCodeLine{00703\ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}-\/\ writing"{}});}
\DoxyCodeLine{00704\ \ \ \ \ \ \ \ \ uint32\_t\ start\ =\ millis();}
\DoxyCodeLine{00705\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i=0;\ i<2048;\ i++)\ \{}
\DoxyCodeLine{00706\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((i\ \&\ 0x001F)\ ==\ 0x001F)\ Serial.print(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{00707\ \ \ \ \ \ \ \ \ \ \ \ \ file.write(buf,\ 512);}
\DoxyCodeLine{00708\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00709\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00710\ \ \ \ \ \ \ \ \ uint32\_t\ end\ =\ millis()\ -\/\ start;}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}\ -\/\ \%u\ bytes\ written\ in\ \%u\ ms\(\backslash\)r\(\backslash\)n"{}},\ 2048\ *\ 512,\ end);}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00713\ }
\DoxyCodeLine{00714\ \ \ \ \ \ \ \ \ file\ =\ fs.open(path);}
\DoxyCodeLine{00715\ \ \ \ \ \ \ \ \ start\ =\ millis();}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \ \ end\ =\ start;}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \ \ i\ =\ 0;}
\DoxyCodeLine{00718\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file\ \&\&\ !file.isDirectory())\ \{}
\DoxyCodeLine{00719\ \ \ \ \ \ \ \ \ \ \ \ \ len\ =\ file.size();}
\DoxyCodeLine{00720\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ flen\ =\ len;}
\DoxyCodeLine{00721\ \ \ \ \ \ \ \ \ \ \ \ \ start\ =\ millis();}
\DoxyCodeLine{00722\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}-\/\ reading"{}}\ );}
\DoxyCodeLine{00723\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (len)\{}
\DoxyCodeLine{00724\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ toRead\ =\ len;}
\DoxyCodeLine{00725\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (toRead\ >\ 512)\ toRead\ =\ 512;}
\DoxyCodeLine{00726\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ file.read(buf,\ toRead);}
\DoxyCodeLine{00727\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((i++\ \&\ 0x001F)\ ==\ 0x001F)\ Serial.print(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{00728\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ len\ -\/=\ toRead;}
\DoxyCodeLine{00729\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00730\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00731\ \ \ \ \ \ \ \ \ \ \ \ \ end\ =\ millis()\ -\/\ start;}
\DoxyCodeLine{00732\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}-\/\ \%u\ bytes\ read\ in\ \%u\ ms\(\backslash\)r\(\backslash\)n"{}},\ flen,\ end);}
\DoxyCodeLine{00733\ \ \ \ \ \ \ \ \ \ \ \ \ file.close();}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00735\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.println(\textcolor{stringliteral}{"{}-\/\ failed\ to\ open\ file\ for\ reading"{}});}
\DoxyCodeLine{00736\ \ \ \ \ \}}
\DoxyCodeLine{00737\ \};}
\DoxyCodeLine{00738\ \textcolor{preprocessor}{\#if\ RUN\_TESTS}}
\DoxyCodeLine{00739\ \textcolor{preprocessor}{\ \ \ \ \#include\ "{}unittests.h"{}}}
\DoxyCodeLine{00740\ \ \ \ \ \textcolor{keywordtype}{void}\ run\_tests()\ \{}
\DoxyCodeLine{00741\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Running\ tests...\(\backslash\)n"{}});}
\DoxyCodeLine{00742\ \ \ \ \ \ \ \ \ delay(5000);}
\DoxyCodeLine{00743\ \ \ \ \ \ \ \ \ test\_Param();}
\DoxyCodeLine{00744\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Tests\ complete.\(\backslash\)n"{}});}
\DoxyCodeLine{00745\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(;;);\ \textcolor{comment}{//\ loop\ forever}}
\DoxyCodeLine{00746\ \ \ \ \ \}}
\DoxyCodeLine{00747\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00748\ \ \ \ \ \textcolor{keywordtype}{void}\ run\_tests()\ \{\}}
\DoxyCodeLine{00749\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}

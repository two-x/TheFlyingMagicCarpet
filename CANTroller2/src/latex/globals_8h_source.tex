\doxysection{globals.\+h}
\hypertarget{globals_8h_source}{}\label{globals_8h_source}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ globals.h\ -\/\ not\ dependent\ on\ anything,\ so\ include\ this\ first}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}Arduino.h"{}}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ pin\ assignments\ \ ESP32-\/S3-\/DevkitC\ series\ \ \ (note:\ "{}*"{}\ are\ pins\ we\ can\ reclaim\ if\ needed)}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#define\ \ \ \ \ boot\_sw\_pin\ \ 0\ }\textcolor{comment}{//\ button0/strap1\ \ \ //\ input,\ the\ esp\ "{}boot"{}\ button.\ if\ more\ pins\ are\ needed,\ move\ encoder\_sw\_pin\ to\ this\ pin,\ no\ other\ signal\ of\ ours\ can\ work\ on\ this\ pin\ due\ to\ high-\/at-\/boot\ requirement}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ \ \ \ \ \ tft\_dc\_pin\ \ 1\ }\textcolor{comment}{//\ adc1.0\ \ \ \ \ \ \ \ \ \ \ //\ output,\ assert\ when\ sending\ data\ to\ display\ chip\ to\ indicate\ commands\ vs.\ screen\ data}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#define\ \ tp\_cs\_fuel\_pin\ \ 2\ }\textcolor{comment}{//\ adc1.1\ \ \ \ \ \ \ \ \ \ \ //\ output,\ this\ controls\ touch\ panel\ chip\ select\ for\ resistive\ touchscreen\ (dev\ board)\ OR\ drives\ the\ vehicle's\ fuel\ pump\ (on\ car)}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#define\ \ \ sdcard\_cs\_pin\ \ 3\ }\textcolor{comment}{//\ adc1.2/strapX\ \ *\ //\ output,\ chip\ select\ for\ SD\ card\ controller\ on\ SPI\ bus.\ sdcard\ functionality\ is\ not\ implemented,\ we\ may\ not\ even\ need\ it}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#define\ \ \ \ mulebatt\_pin\ \ 4\ }\textcolor{comment}{//\ adc1.3\ \ \ \ \ \ \ \ \ \ \ //\ analog\ input,\ mule\ battery\ voltage\ sense,\ full\ scale\ is\ 16V}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#define\ \ \ \ \ \ \ \ \ pot\_pin\ \ 5\ }\textcolor{comment}{//\ adc1.4\ \ \ \ \ \ \ \ \ \ \ //\ analog\ in\ from\ 20k\ pot}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ \ \ brake\_pos\_pin\ \ 6\ }\textcolor{comment}{//\ adc1.5\ \ \ \ \ \ \ \ \ \ \ //\ analog\ input,\ tells\ us\ linear\ position\ of\ brake\ actuator.\ Blue\ is\ wired\ to\ ground,\ POS\ is\ wired\ to\ white.}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#define\ \ \ \ pressure\_pin\ \ 7\ }\textcolor{comment}{//\ adc1.6\ \ \ \ \ \ \ \ \ \ \ //\ analog\ input,\ tells\ us\ brake\ fluid\ pressure.\ Needs\ a\ R\ divider\ to\ scale\ max\ possible\ pressure\ (using\ foot)\ to\ 3.3V.}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#define\ \ \ \ \ i2c\_sda\_pin\ \ 8\ }\textcolor{comment}{//\ sda0/adc1.7\ \ \ \ \ \ //\ i2c\ bus\ for\ airspeed/map\ sensors,\ lighting\ board,\ cap\ touchscreen}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#define\ \ \ \ \ i2c\_scl\_pin\ \ 9\ }\textcolor{comment}{//\ qhd0/scl0/adc1.8\ //\ i2c\ bus\ for\ airspeed/map\ sensors,\ lighting\ board,\ cap\ touchscreen}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#define\ \ \ \ \ \ tft\_cs\_pin\ 10\ }\textcolor{comment}{//\ cs0/adc1.9\ \ \ \ \ *\ //\ output,\ active\ low,\ chip\ select\ allows\ ILI9341\ display\ chip\ use\ of\ the\ spi\ bus.\ pin\ can\ be\ reclaimed\ if\ tft\ is\ the\ only\ spi\ device\ (lose\ the\ sd\ card)}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#define\ \ \ \ spi\_mosi\_pin\ 11\ }\textcolor{comment}{//\ mosi0/adc2.0\ \ \ \ \ //\ used\ as\ spi\ interface\ data\ for\ tft\ screen,\ sd\ card\ and\ resistive\ touch\ panel}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#define\ \ \ \ spi\_sclk\_pin\ 12\ }\textcolor{comment}{//\ sclk0/adc2.1\ \ \ \ \ //\ used\ as\ spi\ interface\ clock\ for\ tft\ screen,\ sd\ card\ and\ resistive\ touch\ panel}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \ \ \ spi\_miso\_pin\ 13\ }\textcolor{comment}{//\ miso0/adc2.2\ \ \ \ \ //\ used\ as\ spi\ interface\ data\ from\ sd\ card,\ resistive\ touch\ panel,\ and\ possibly\ (?)\ tft\ screen}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#define\ hotrc\_ch2\_v\_pin\ 14\ }\textcolor{comment}{//\ qwp0/pwm0/adc2.3\ //\ hotrc\ ch2\ bidirectional\ trigger\ input}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#define\ hotrc\_ch1\_h\_pin\ 15\ }\textcolor{comment}{//\ pwm1/adc2.4\ \ \ \ \ \ //\ hotrc\ ch1\ thumb\ joystick\ input}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#define\ \ \ \ \ gas\_pwm\_pin\ 16\ }\textcolor{comment}{//\ pwm1/adc2.5\ \ \ \ \ \ //\ output,\ pwm\ signal\ duty\ cycle\ controls\ throttle\ target.\ on\ Due\ this\ is\ the\ pin\ labeled\ DAC1\ (where\ A13\ is\ on\ Mega)}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#define\ \ \ brake\_pwm\_pin\ 17\ }\textcolor{comment}{//\ pwm0/adc2.6/tx1\ \ //\ output,\ pwm\ signal\ duty\ cycle\ sets\ speed\ of\ brake\ actuator\ from\ full\ speed\ extend\ to\ full\ speed\ retract,\ (50\%\ is\ stopped)}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#define\ \ \ steer\_pwm\_pin\ 18\ }\textcolor{comment}{//\ pwm0/adc2.7/rx1\ \ //\ output,\ pwm\ signal\ positive\ pulse\ width\ sets\ steering\ motor\ speed\ from\ full\ left\ to\ full\ speed\ right,\ (50\%\ is\ stopped).\ jaguar\ asks\ for\ an\ added\ 150ohm\ series\ R\ when\ high\ is\ 3.3V}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#define\ steer\_enc\_a\_pin\ 19\ }\textcolor{comment}{//\ usb-\/d-\//adc2.8\ \ *\ //\ reserved\ for\ usb\ or\ a\ steering\ quadrature\ encoder.}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#define\ steer\_enc\_b\_pin\ 20\ }\textcolor{comment}{//\ usb-\/d+/adc2.9\ \ *\ //\ reserved\ for\ usb\ or\ a\ steering\ quadrature\ encoder.}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#define\ \ \ \ \ onewire\_pin\ 21\ }\textcolor{comment}{//\ pwm0\ \ \ \ \ \ \ \ \ \ \ \ \ //\ onewire\ bus\ for\ temperature\ sensor\ data.\ note:\ tested\ this\ does\ not\ work\ on\ higher-\/numbered\ pins\ (\string~35+)}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#define\ \ \ \ \ \ speedo\_pin\ 35\ }\textcolor{comment}{//\ spiram/octspi\ \ \ \ //\ int\ input,\ active\ high,\ asserted\ when\ magnet\ south\ is\ in\ range\ of\ sensor.\ 1\ pulse\ per\ driven\ pulley\ rotation.\ (Open\ collector\ sensors\ need\ pullup)}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#define\ \ \ \ \ starter\_pin\ 36\ }\textcolor{comment}{//\ sram/ospi/glitch\ //\ input/Output\ (both\ active\ high),\ output\ when\ starter\ is\ being\ driven,\ otherwise\ input\ senses\ external\ starter\ activation}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#define\ \ \ \ \ \ \ \ tach\_pin\ 37\ }\textcolor{comment}{//\ spiram/octspi\ \ \ \ //\ int\ Input,\ active\ high,\ asserted\ when\ magnet\ south\ is\ in\ range\ of\ sensor.\ 1\ pulse\ per\ engine\ rotation.\ (no\ pullup)\ -\/\ note:\ placed\ on\ p36\ because\ filtering\ should\ negate\ any\ effects\ of\ 80ns\ low\ pulse\ when\ certain\ rtc\ devices\ power\ on}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#define\ \ encoder\_sw\_pin\ 38\ }\textcolor{comment}{//\ spiram/octspi\ \ *\ //\ input,\ Rotary\ encoder\ push\ switch,\ for\ the\ UI.\ active\ low\ (needs\ pullup).\ signal\ can\ be\ moved\ to\ pin\ 0\ to\ free\ up\ this\ pin.\ Pin\ 38\ is\ the\ neopixel\ pin\ on\ v1.1\ boards}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#define\ \ \ \ \ basicsw\_pin\ 39\ }\textcolor{comment}{//\ jtck/glitch\ \ \ \ \ \ //\ input,\ asserted\ to\ tell\ us\ to\ run\ in\ basic\ mode,\ active\ low\ (has\ ext\ pullup)\ -\/\ note:\ placed\ on\ p39\ because\ filtering\ should\ negate\ any\ effects\ of\ 80ns\ low\ pulse\ when\ certain\ rtc\ devices\ power\ on\ (see\ errata\ 3.11)}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#define\ \ \ hotrc\_ch4\_pin\ 40\ }\textcolor{comment}{//\ jtdo\ \ \ \ \ \ \ \ \ \ \ \ \ //\ syspower,\ starter,\ and\ cruise\ mode\ toggle\ control.\ hotrc\ ch4\ pwm\ toggle\ signal}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ \ \ hotrc\_ch3\_pin\ 41\ }\textcolor{comment}{//\ jtdi\ \ \ \ \ \ \ \ \ \ \ \ \ //\ ignition\ control,\ hotrc\ Ch3\ PWM\ toggle\ signal}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#define\ \ \ encoder\_a\_pin\ 42\ }\textcolor{comment}{//\ jtms\ \ \ \ \ \ \ \ \ \ \ \ \ //\ int\ input,\ the\ A\ (aka\ CLK)\ pin\ of\ the\ encoder.\ both\ A\ and\ B\ complete\ a\ negative\ pulse\ in\ between\ detents.\ if\ A\ pulse\ goes\ low\ first,\ turn\ is\ CCW.\ (needs\ pullup)}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#define\ \ \ \ \ uart\_tx\_pin\ 43\ }\textcolor{comment}{//\ "{}TX"{}/tx0\ \ \ \ \ \ \ \ \ //\ serial\ monitor\ data\ out.\ Also\ used\ to\ detect\ devboard\ vs.\ pcb\ at\ boot\ time\ (using\ pullup/pulldown,\ see\ below)}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#define\ \ \ \ \ uart\_rx\_pin\ 44\ }\textcolor{comment}{//\ "{}RX"{}/rx0\ \ \ \ \ \ \ \ \ //\ serial\ monitor\ data\ in.\ maybe\ could\ repurpose\ during\ runtime\ since\ we\ only\ need\ outgoing\ console\ data?}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#define\ \ \ \ ignition\_pin\ 45\ }\textcolor{comment}{//\ strap0\ \ \ \ \ \ \ \ \ \ \ //\ output\ to\ an\ nfet/pfet\ pair\ to\ control\ the\ car\ ignition}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#define\ \ \ \ syspower\_pin\ 46\ }\textcolor{comment}{//\ strap0\ \ \ \ \ \ \ \ \ \ \ //\ output\ to\ an\ nfet/pfet\ pair\ to\ power\ all\ the\ tranducers.}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#define\ \ \ encoder\_b\_pin\ 47\ }\textcolor{comment}{//\ NA\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ //\ int\ input,\ the\ B\ (aka\ DT)\ pin\ of\ the\ encoder.\ both\ A\ and\ B\ complete\ a\ negative\ pulse\ in\ between\ detents.\ if\ B\ pulse\ goes\ low\ first,\ turn\ is\ CW.\ (needs\ pullup)}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#define\ \ \ \ neopixel\_pin\ 48\ }\textcolor{comment}{//\ neopix\ \ \ \ \ \ \ \ \ \ \ //\ data\ line\ to\ onboard\ neopixel\ WS281x\ (on\ all\ v1\ devkit\ boards\ -\/\ pin\ 38\ is\ used\ on\ v1.1\ boards).\ Also\ used\ for\ onboard\ and\ external\ neopoxels\ -\/\ !\ pin\ is\ also\ defined\ in\ neopixel.h}}
\DoxyCodeLine{00041\ \textcolor{comment}{//\ external\ components\ needed\ (pullup/pulldown\ resistors,\ capacitors,\ etc.):\ (note:\ "{}BB"{}\ =\ on\ dev\ breadboards\ only,\ "{}PCB"{}\ =\ on\ vehicle\ PCB\ only)}}
\DoxyCodeLine{00042\ \textcolor{comment}{//\ 1.\ onewire\_pin,\ tach\_pin,\ speedo\_pin:\ Add\ 4.7k-\/ohm\ to\ 3.3V,\ needed\ for\ open\ collector\ sensor\ output\ to\ define\ logic-\/high\ voltage\ level.}}
\DoxyCodeLine{00043\ \textcolor{comment}{//\ 2.\ uart\_tx\_pin:\ (PCB)\ add\ 22k-\/ohm\ to\ GND.\ (BB)\ connect\ the\ 22k-\/ohm\ to\ 3.3V\ instead.\ for\ boot\ detection\ of\ vehicle\ PCB,\ so\ defaults\ are\ set\ appropriately.}}
\DoxyCodeLine{00044\ \textcolor{comment}{//\ 3.\ resistor\ dividers\ are\ needed\ for\ these\ inputs:\ starter\_pin\ (16V-\/>3.3V),\ mulebatt\_pin\ (16V-\/>3.3V),\ and\ pressure\_pin\ (5V-\/>3.3V).}}
\DoxyCodeLine{00045\ \textcolor{comment}{//\ 4.\ ignition\_pin,\ syspower\_pin,\ starter\_pin:\ require\ pulldowns\ to\ gnd,\ this\ is\ provided\ by\ nfet\ gate\ pulldown.}}
\DoxyCodeLine{00046\ \textcolor{comment}{//\ 5.\ gas\_pwm\_pin:\ should\ have\ a\ series\ \string~680-\/ohm\ R\ going\ to\ the\ servo.}}
\DoxyCodeLine{00047\ \textcolor{comment}{//\ 6.\ encoder\_a\_pin,\ encoder\_b\_pin,\ button\_pin:\ should\ have\ 10nF\ to\ gnd,\ tho\ it\ should\ work\ w/o\ it.\ pullups\ to\ 3.3V\ (4.7k-\/ohm\ is\ good)\ are\ also\ necessary,\ but\ the\ encoder\ we're\ using\ includes\ these.}}
\DoxyCodeLine{00048\ \textcolor{comment}{//\ 7.\ neopixel\_pin:\ (PCB)\ Add\ 330\ ohm\ in\ series\ (between\ pin\ and\ the\ DataIn\ pin\ of\ the\ 1st\ pixel).\ (BB)\ same,\ but\ this\ one\ is\ likely\ optional,\ e.g.\ mine\ works\ w/o\ it.\ \ for\ signal\ integrity\ over\ long\ wires.\ }}
\DoxyCodeLine{00049\ \textcolor{comment}{//\ 6.\ mulebatt\_pin,\ pressure\_pin,\ brake\_pos\_pin,\ pot\_wipe\_pin:\ (ADC\ inputs)\ should\ have\ 100nF\ cap\ to\ gnd,\ to\ improve\ signal\ stability,\ tho\ it\ works\ w/o\ it.}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \textcolor{comment}{//\ note\ onewire\ works\ on\ pins\ 19-\/21\ but\ not\ on\ pins\ 39-\/42}}
\DoxyCodeLine{00052\ \textcolor{comment}{//\ if\ more\ pins\ become\ needed,\ encoder\_sw\ may\ be\ moved\ to\ pin\ 0,\ freeing\ up\ pin\ 38\ (pin\ 0\ requires\ a\ pullup,\ which\ encoder\_sw\ has)}}
\DoxyCodeLine{00053\ \textcolor{comment}{//\ if\ more\ pins\ become\ needed,\ we\ can\ abandon\ the\ sd\ card\ and\ permanently\ enable\ the\ tft,\ getting\ us\ back\ 2\ pins\ for\ those\ chip\ selects}}
\DoxyCodeLine{00054\ \textcolor{comment}{//\ ESP32-\/S3\ TRM:\ https://www.espressif.com/sites/default/files/documentation/esp32-\/s3\_technical\_reference\_manual\_en.pdf\#dma}}
\DoxyCodeLine{00055\ \textcolor{comment}{//\ ESP32-\/S3\ datasheet:\ https://www.espressif.com/sites/default/files/documentation/esp32-\/s3\_datasheet\_en.pdf}}
\DoxyCodeLine{00056\ \textcolor{comment}{//\ ESP32-\/S3\ has\ 5\ DMA\ channels\ in\ each\ direction.\ We\ would\ use\ them\ for\ SPI\ data\ out\ to\ TFT,\ neopixel\ data\ out,\ and\ possibly\ out\ to\ the\ 3\ motor\ outputs\ and\ in\ from\ the\ 4\ hotrc\ channels.}}
\DoxyCodeLine{00057\ \textcolor{comment}{//\ dma\ works\ with:\ RMT,\ I2S0,\ I2S1,\ SPI2,\ SPI3,\ ADC,\ internal\ RAM,\ external\ PSRAM,\ and\ a\ few\ others\ (see\ the\ TRM)}}
\DoxyCodeLine{00058\ \textcolor{comment}{//\ official\ pin\ capabilities:\ https://docs.espressif.com/projects/esp-\/idf/en/latest/esp32s3/hw-\/reference/esp32s3/user-\/guide-\/devkitc-\/1.html?highlight=devkitc\#user-\/guide-\/s3-\/devkitc-\/1-\/v1-\/1-\/header-\/blocks}}
\DoxyCodeLine{00059\ \textcolor{comment}{//\ external\ flash\ uses\ pins\ 27-\/32.\ ADC\ ch2\ will\ not\ work\ if\ wifi\ is\ enabled}}
\DoxyCodeLine{00060\ \textcolor{comment}{//\ bootstrap\ pins:\ Pin\ 0\ must\ be\ pulled\ high,\ and\ pins\ 45\ and\ 46\ pulled\ low\ during\ bootup}}
\DoxyCodeLine{00061\ \textcolor{comment}{//\ glitch:\ pins\ 36\ and\ 39\ will\ be\ erroneously\ pulled\ low\ for\ \string~80ns\ when\ "{}certain\ RTC\ peripherals\ power\ up"{}\ (ESP32\ errata\ 3.11).\ can\ run\ adc\_power\_acquire()\ to\ work\ around\ glitch\ but\ draw\ \string~1mA\ more\ power.\ avoid\ interrupts\ on\ these\ pins}}
\DoxyCodeLine{00062\ \textcolor{comment}{//\ spi\ bus\ page\ including\ DMA\ information:\ https://docs.espressif.com/projects/esp-\/idf/en/v4.4/esp32s3/api-\/reference/peripherals/spi\_master.html}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#define\ tft\_rst\_pin\ -\/1\ \ \ \ \ }\textcolor{comment}{//\ tft\ reset\ allows\ us\ to\ reboot\ the\ screen\ hardware\ when\ it\ crashes.\ Otherwise\ connect\ screen\ reset\ line\ to\ esp\ reset\ pin}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#define\ tft\_ledk\_pin\ -\/1\ \ \ \ }\textcolor{comment}{//\ output,\ optional\ PWM\ signal\ to\ control\ brightness\ of\ LCD\ backlight\ (needs\ modification\ to\ shield\ board\ to\ work)}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#define\ touch\_irq\_pin\ -\/1\ \ \ }\textcolor{comment}{//\ input,\ optional\ touch\ occurence\ interrupt\ signal\ (for\ resistive\ touchscreen,\ prevents\ spi\ bus\ delays)\ -\/\ set\ to\ 255\ if\ not\ used}}
\DoxyCodeLine{00066\ \textcolor{comment}{//\ bm2023\ pins:\ tft\_dc\_pin\ 3,\ onewire\_pin\ 19,\ hotrc\_ch3\_pin\ 20,\ hotrc\_ch4\_pin\ 21,\ tach\_pin\ 36,\ ignition\_pin\ 37,\ syspower\_pin\ 38,\ encoder\_b\_pin\ 40,\ encoder\_a\_pin\ 41,\ encoder\_sw\_pin\ 42,\ starter\_pin\ 45,\ sdcard\_cs\_pin\ 46,\ touch\_cs\_pin\ 47}}
\DoxyCodeLine{00067\ \textcolor{preprocessor}{\#if\ USE\_BM23\_PINS\ \ \ \ \ \ \ \ \ \ }\textcolor{comment}{//\ for\ testing\ using\ box\ from\ bm23,\ override\ new\ pin\ assignments\ with\ old\ ones}}
\DoxyCodeLine{00068\ \textcolor{preprocessor}{\#define\ steer\_enc\_a\_pin\ 1\ \ }\textcolor{comment}{//\ not\ used\ in\ bm23,\ but\ moving\ to\ an\ unused\ pin}}
\DoxyCodeLine{00069\ \textcolor{preprocessor}{\#define\ steer\_enc\_b\_pin\ 2\ \ }\textcolor{comment}{//\ not\ used\ in\ bm23,\ but\ moving\ to\ an\ unused\ pin}}
\DoxyCodeLine{00070\ \textcolor{preprocessor}{\#define\ tft\_dc\_pin\ 3}}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#define\ onewire\_pin\ 19}}
\DoxyCodeLine{00072\ \textcolor{preprocessor}{\#define\ hotrc\_ch3\_pin\ 20`}}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#define\ hotrc\_ch4\_pin\ 21}}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#define\ tach\_pin\ 36}}
\DoxyCodeLine{00075\ \textcolor{preprocessor}{\#define\ ignition\_pin\ 37}}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#define\ syspower\_pin\ 38}}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#define\ encoder\_b\_pin\ 40}}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#define\ encoder\_a\_pin\ 41}}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#define\ encoder\_sw\_pin\ 42}}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#define\ starter\_pin\ 45}}
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#define\ sdcard\_cs\_pin\ 46}}
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#define\ tp\_cs\_fuel\_pin\ 47}}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{preprocessor}{\#define\ adcbits\ 12}}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\#define\ adcrange\_adc\ 4095\ \ \ \ \ }\textcolor{comment}{//\ =\ 2\string^adcbits-\/1}}
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#define\ adcmidscale\_adc\ 2047\ \ }\textcolor{comment}{//\ =\ 2\string^(adcbits-\/1)-\/1}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \textcolor{comment}{//\ these\ global\ enums\ are\ super\ convenient,\ just\ take\ care\ when\ making\ changes}}
\DoxyCodeLine{00090\ \textcolor{keyword}{enum}\ hotrc\_axis\ \{\ HORZ=0,\ VERT=1,\ CH3=2,\ CH4=3\ \};}
\DoxyCodeLine{00091\ \textcolor{keyword}{enum}\ hotrc\_val\ \{\ OPMIN=0,\ CENT=1,\ OPMAX=2,\ RAW=3,\ FILT=4,\ DBBOT=5,\ DBTOP=6\ \};}
\DoxyCodeLine{00092\ \textcolor{keyword}{enum}\ motor\_val\ \{\ PARKED=1,\ OUT=3,\ GOVERN=4\ ,\ ABSMIN=5,\ ABSMAX=6,\ MARGIN=7,\ NUM\_MOTORVALS=8\ \};\ \textcolor{comment}{//\ IDLE=8,\ NUM\_MOTORVALS=9\ \};}}
\DoxyCodeLine{00093\ \textcolor{keyword}{enum}\ stop\_val\ \{\ STOP=1\ \};}
\DoxyCodeLine{00094\ \textcolor{keyword}{enum}\ steer\_val\ \{\ SAFE=1\ \};}
\DoxyCodeLine{00095\ \textcolor{keyword}{enum}\ size\_enums\ \{\ NUM\_AXES=2,\ NUM\_CHANS=4,\ NUM\_VALUS=8\ \};}
\DoxyCodeLine{00096\ \textcolor{keyword}{enum}\ joydirs\ \{\ JOY\_RT=-\/2,\ JOY\_DN=-\/1,\ JOY\_CENT=0,\ JOY\_UP=1,\ JOY\_LT=2,\ JOY\_PLUS=3,\ JOY\_MINUS=4\ \};}
\DoxyCodeLine{00097\ \textcolor{keyword}{enum}\ runmode\ \{\ BASIC,\ ASLEEP,\ SHUTDOWN,\ STALL,\ HOLD,\ FLY,\ CRUISE,\ CAL,\ NUM\_RUNMODES\ \};}
\DoxyCodeLine{00098\ \textcolor{keyword}{enum}\ req\ \{\ REQ\_NA=-\/1,\ REQ\_OFF=0,\ REQ\_ON=1,\ REQ\_TOG=2\ \};\ \ \textcolor{comment}{//\ requesting\ handler\ actions\ of\ digital\ values\ with\ handler\ functions}}
\DoxyCodeLine{00099\ \textcolor{keyword}{enum}\ cruise\_modes\ \{\ PID\_SUSPEND\_FLY,\ THROTTLE\_ANGLE,\ THROTTLE\_DELTA\ \};}
\DoxyCodeLine{00100\ \textcolor{keyword}{enum}\ sw\_presses\ \{\ swNONE,\ swSHORT,\ swLONG\ \};}
\DoxyCodeLine{00101\ \textcolor{keyword}{enum}\ motor\_modes\ \{\ NA=-\/1,\ Halt=0,\ Idle=1,\ Release=2,\ OpenLoop=3,\ ActivePID=4,\ AutoStop=5,\ AutoHold=6,\ ParkMotor=7,\ Cruise=8,\ Calibrate=9,\ Starting=10,\ NumMotorModes=11\ \};}
\DoxyCodeLine{00102\ \textcolor{keyword}{enum}\ brake\_pid\_modes\ \{\ PositionPID=0,\ PressurePID=1,\ HybridPID=2,\ NumBrakePIDs=4\ \};\ \ \textcolor{comment}{//\ OpenLoop=3}}
\DoxyCodeLine{00103\ \textcolor{keyword}{enum}\ tunerstuff\ \{\ ERASE=-\/1,\ OFF=0,\ SELECT=1,\ EDIT=2\ \};}
\DoxyCodeLine{00104\ \textcolor{keyword}{enum}\ boolean\_states\ \{\ ON=1\ \};}
\DoxyCodeLine{00105\ \textcolor{keyword}{enum}\ datapages\ \{\ PG\_RUN,\ PG\_JOY,\ PG\_SENS,\ PG\_PWMS,\ PG\_IDLE,\ PG\_BPID,\ PG\_GPID,\ PG\_CPID,\ PG\_TEMP,\ PG\_SIM,\ PG\_UI,\ NUM\_DATAPAGES\ \};}
\DoxyCodeLine{00106\ \textcolor{keyword}{enum}\ temp\_categories\ \{\ AMBIENT=0,\ ENGINE=1,\ WHEEL=2,\ BRAKE=3,\ NUM\_TEMP\_CATEGORIES=4\ \};\ \ \textcolor{comment}{//\ }}
\DoxyCodeLine{00107\ \textcolor{keyword}{enum}\ temp\_lims\ \{\ DISP\_MIN=1,\ WARNING=3,\ ALARM=4,\ DISP\_MAX=5\ \};\ \ \ \textcolor{comment}{//\ possible\ sources\ of\ gas,\ brake,\ steering\ commands}}
\DoxyCodeLine{00108\ \textcolor{keyword}{enum}\ ui\_modes\ \{\ DatapagesUI=0,\ ScreensaverUI=1\ \};}
\DoxyCodeLine{00109\ \textcolor{keyword}{enum}\ codestatus\ \{\ Confused=0,\ Booting=1,\ Parked=2,\ Stopped=3,\ Driving=4,\ NumCodeStatuses=5\ \};}
\DoxyCodeLine{00110\ \textcolor{keyword}{enum}\ telemetry\_idiots\ \{\ \_None=-\/1,\ \_GasServo=0,\ \_BrakeMotor=1,\ \_SteerMotor=2,\ \_HotRC=3,\ \_Speedo=4,\ \_Tach=5,\ \_BrakePres=6,\ \_BrakePosn=7,\ \_Temps=8,\ \_Other=9,\ \_GPIO=10,\ NumTelemetryIdiots=11\ \};\ \ \textcolor{comment}{//\ \_MuleBatt,\ \_MAP,\ \_MAF,\ \_Pot,}}
\DoxyCodeLine{00111\ \textcolor{keyword}{enum}\ telemetry\_full\ \{\ \_HotRCHorz=11,\ \_HotRCVert=12,\ \_HotRCCh3=13,\ \_HotRCCh4=14,\ \_MuleBatt=15,\ \_AirVelo=16,\ \_MAP=17,\ \_Pot=18,\ \_TempEng=19,\ \_TempWhFL=20,\ \_TempWhFR=21,\ \_TempWhRL=22,\ \_TempWhRR=23,\ \_TempBrake=24,\ \_TempAmb=25,\ \_Ignition=26,\ \_Starter=27,\ \_BasicSw=28,\ \_FuelPump=29,\ NumTelemetryFull=30\ \};\ \ \textcolor{comment}{//\ 10\ per\ line}}
\DoxyCodeLine{00112\ \textcolor{keyword}{enum}\ err\_type\ \{\ LOST=0,\ RANGE=1,\ NUM\_ERR\_TYPES=2\ \};\ \ \textcolor{comment}{//\ VALUE=2,\ STATE=3,\ WARN=4,\ CRIT=5,\ INFO=6,\ }}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \textcolor{comment}{//\ global\ configuration\ settings}}
\DoxyCodeLine{00115\ \textcolor{keywordtype}{bool}\ brake\_hybrid\_pid\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \textcolor{comment}{//\ should\ the\ brake\ use\ different\ pid\ loops\ for\ each\ end\ of\ its\ travel?\ }}
\DoxyCodeLine{00116\ \textcolor{keywordtype}{int}\ brake\_default\_pid\ =\ PressurePID;\ \textcolor{comment}{//\ if\ hybrid\ pid\ is\ disabled,\ do\ we\ use\ PressurePID\ or\ PositionPID?}}
\DoxyCodeLine{00117\ \textcolor{keywordtype}{bool}\ autostop\_disabled\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \textcolor{comment}{//\ temporary\ measure\ to\ keep\ brake\ behaving\ until\ we\ get\ it\ debugged.\ Eventually\ should\ be\ false}}
\DoxyCodeLine{00118\ \textcolor{keywordtype}{bool}\ allow\_rolling\_start\ =\ \textcolor{keyword}{true};\ \ \ \ \ \textcolor{comment}{//\ are\ we\ lenient\ that\ it's\ ok\ to\ go\ to\ fly\ mode\ if\ the\ car\ is\ already\ moving?\ may\ be\ a\ smart\ prerequisite,\ may\ be\ us\ putting\ obstacles\ in\ our\ way}}
\DoxyCodeLine{00119\ \textcolor{keywordtype}{bool}\ flip\_the\_screen\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \textcolor{comment}{//\ did\ you\ mount\ your\ screen\ upside-\/down?}}
\DoxyCodeLine{00120\ \textcolor{keywordtype}{bool}\ cruise\_speed\_lowerable\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ allows\ use\ of\ trigger\ to\ adjust\ cruise\ speed\ target\ without\ leaving\ cruise\ mode.\ \ Otherwise\ cruise\ button\ is\ a\ "{}lock"{}\ button,\ and\ trigger\ activity\ cancels\ lock}}
\DoxyCodeLine{00121\ \textcolor{keywordtype}{bool}\ display\_enabled\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ should\ we\ run\ 325x\ slower\ in\ order\ to\ get\ bombarded\ with\ tiny\ numbers?\ \ Probably.}}
\DoxyCodeLine{00122\ \textcolor{keywordtype}{bool}\ use\_i2c\_baton\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ soren's\ custom\ homemade\ semaphores\ to\ prevent\ i2c\ bus\ collisions?}}
\DoxyCodeLine{00123\ \textcolor{keywordtype}{bool}\ always\_max\_refresh\ =\ \textcolor{keyword}{false};\ \ \ \ \ \textcolor{comment}{//\ set\ to\ true\ to\ enforce\ a\ cap\ on\ screen\ frame\ draws\ (90\ Hz\ I\ think\ it\ is),\ otherwise\ craw\ as\ fast\ as\ we\ can.\ fullscreen\ screensaver\ ignores\ this}}
\DoxyCodeLine{00124\ \textcolor{keywordtype}{bool}\ brake\_before\_starting\ =\ \textcolor{keyword}{true};\ \ \ \textcolor{comment}{//\ if\ true,\ the\ starter\ motor\ pushes\ the\ brake\ pedal\ first,\ and\ won't\ turn\ on\ until\ it\ senses\ the\ pressure}}
\DoxyCodeLine{00125\ \textcolor{keywordtype}{bool}\ watchdog\_enabled\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \textcolor{comment}{//\ enable\ the\ esp's\ built-\/in\ watchdog\ circuit,\ it\ will\ reset\ us\ if\ it\ doesn't\ get\ pet\ often\ enough\ (to\ prevent\ infinite\ hangs).\ disabled\ cuz\ it\ seems\ to\ mess\ with\ the\ hotrc\ (?)}}
\DoxyCodeLine{00126\ \textcolor{keywordtype}{bool}\ fuelpump\_supported\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \textcolor{comment}{//\ do\ we\ drive\ power\ to\ vehicle\ fuel\ pump?\ \ note\ if\ resistive\ touchscreen\ is\ present\ then\ fuelpump\ is\ automatically\ not\ supported\ regardless\ of\ this}}
\DoxyCodeLine{00127\ \textcolor{keywordtype}{int}\ throttle\_ctrl\_mode\ =\ OpenLoop;\ \ \ \textcolor{comment}{//\ should\ gas\ servo\ use\ the\ rpm-\/sensing\ pid?\ values:\ ActivePID\ or\ OpenLoop}}
\DoxyCodeLine{00128\ \textcolor{keywordtype}{bool}\ print\_task\_stack\_usage\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ enable\ to\ have\ remaining\ heap\ size\ and\ free\ task\ memory\ printed\ to\ console\ every\ so\ often.\ for\ tuning\ memory\ allocation}}
\DoxyCodeLine{00129\ \textcolor{keywordtype}{bool}\ autosaver\_display\_fps\ =\ \textcolor{keyword}{true};\ \ \ \textcolor{comment}{//\ do\ you\ want\ to\ see\ the\ fps\ performance\ of\ the\ fullscreen\ saver\ in\ the\ corner?}}
\DoxyCodeLine{00130\ \textcolor{keywordtype}{bool}\ crash\_driving\_recovery\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ if\ code\ crashes\ while\ driving,\ should\ it\ continue\ driving\ after\ reboot?}}
\DoxyCodeLine{00131\ \textcolor{comment}{//\ dev-\/board-\/only\ options:\ \ Note\ these\ are\ ignored\ and\ set\ false\ at\ boot\ by\ set\_board\_defaults()\ unless\ running\ on\ a\ breadboard\ with\ a\ 22k-\/ohm\ pullup\ to\ 3.3V\ the\ TX\ pin}}
\DoxyCodeLine{00132\ \textcolor{keywordtype}{bool}\ dont\_take\_temperatures\ =\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ disables\ temp\ sensors.\ in\ case\ debugging\ dallas\ sensors\ or\ causing\ problems}}
\DoxyCodeLine{00133\ \textcolor{keywordtype}{bool}\ console\_enabled\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ completely\ disables\ the\ console\ serial\ output.\ idea\ being,\ it\ may\ be\ safer\ to\ disable\ because\ serial\ printing\ itself\ can\ easily\ cause\ new\ problems,\ and\ libraries\ might\ do\ it\ whenever}}
\DoxyCodeLine{00134\ \textcolor{keywordtype}{bool}\ keep\_system\_powered\ =\ \textcolor{keyword}{false};\ \ \ \ \textcolor{comment}{//\ equivalent\ to\ syspower\ always\ being\ high.}}
\DoxyCodeLine{00135\ \textcolor{keywordtype}{bool}\ looptime\_print\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ makes\ code\ write\ out\ timestamps\ throughout\ loop\ to\ serial\ port.\ for\ analyzing\ what\ parts\ of\ the\ code\ take\ the\ most\ time}}
\DoxyCodeLine{00136\ \textcolor{keywordtype}{bool}\ touch\_reticles\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ draws\ tiny\ little\ plus\ reticles\ to\ aim\ at\ for\ doing\ touchscreen\ calibration}}
\DoxyCodeLine{00137\ \textcolor{keywordtype}{bool}\ button\_test\_heartbeat\_color\ =\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ makes\ boot\ button\ short\ press\ change\ heartbeat\ color.\ useful\ for\ testing\ code\ on\ bare\ esp}}
\DoxyCodeLine{00138\ \textcolor{keywordtype}{bool}\ wifi\_client\_mode\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \textcolor{comment}{//\ should\ wifi\ be\ in\ client\ or\ access\ point\ mode?}}
\DoxyCodeLine{00139\ \textcolor{keywordtype}{bool}\ saver\_on\_sleep\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ does\ fullscreen\ screensaver\ start\ automatically\ when\ asleep,\ after\ a\ delay?}}
\DoxyCodeLine{00140\ \textcolor{keywordtype}{bool}\ print\_framebuffers\ =\ \textcolor{keyword}{false};\ \ \ \ \ \textcolor{comment}{//\ dumps\ out\ ascii\ representations\ of\ screen\ buffer\ contents\ to\ console.\ for\ debugging\ frame\ buffers.\ *hella*\ slow}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \textcolor{comment}{//\ global\ tunable\ variables}}
\DoxyCodeLine{00143\ \textcolor{keywordtype}{int}\ sprite\_color\_depth\ =\ 8;}
\DoxyCodeLine{00144\ uint32\_t\ looptime\_linefeed\_threshold\ =\ 0;\ \ \ \textcolor{comment}{//\ when\ looptime\_print\ ==\ 1,\ will\ linefeed\ after\ printing\ loops\ taking\ >\ this\ value.\ Set\ to\ 0\ linefeeds\ all\ prints}}
\DoxyCodeLine{00145\ \textcolor{keywordtype}{float}\ flycruise\_vert\_margin\_pc\ =\ 0.3;\ \ \ \ \ \ \ \textcolor{comment}{//\ Margin\ of\ error\ for\ determining\ hard\ brake\ value\ for\ dropping\ out\ of\ cruise\ mode}}
\DoxyCodeLine{00146\ \textcolor{keywordtype}{int}\ cruise\_scheme\ =\ THROTTLE\_DELTA;}
\DoxyCodeLine{00147\ int32\_t\ cruise\_delta\_max\_pc\_per\_s\ =\ 16;\ \ \textcolor{comment}{//\ (in\ THROTTLE\_DELTA\ mode)\ What's\ the\ fastest\ rate\ cruise\ adjustment\ can\ change\ pulse\ width\ (in\ us\ per\ second)}}
\DoxyCodeLine{00148\ \textcolor{keywordtype}{float}\ cruise\_angle\_attenuator\ =\ 0.016;\ \ \ \textcolor{comment}{//\ (in\ THROTTLE\_ANGLE\ mode)\ Limits\ the\ change\ of\ each\ adjust\ trigger\ pull\ to\ this\ fraction\ of\ what's\ possible}}
\DoxyCodeLine{00149\ \textcolor{keywordtype}{float}\ temp\_lims\_f[NUM\_TEMP\_CATEGORIES][6]\{}
\DoxyCodeLine{00150\ \ \ \ \ \{45.0,\ 0.0,\ 115.0,\ 120.0,\ 130.0,\ 220.0\},\ \ \textcolor{comment}{//\ [AMBIENT]\ [OPMIN/DISP\_MIN/OPMAX/WARNING/ALARM]}}
\DoxyCodeLine{00151\ \ \ \ \ \{178.0,\ 0.0,\ 198.0,\ 202.0,\ 205.0,\ 220.0\},\ \textcolor{comment}{//\ [ENGINE]\ [OPMIN/DISP\_MIN/OPMAX/WARNING/ALARM]}}
\DoxyCodeLine{00152\ \ \ \ \ \{50.0,\ 0.0,\ 120.0,\ 130.0,\ 140.0,\ 220.0\},\ \ \textcolor{comment}{//\ [WHEEL]\ [OPMIN/DISP\_MIN/OPMAX/WARNING/ALARM]\ (applies\ to\ all\ wheels)}}
\DoxyCodeLine{00153\ \ \ \ \ \{45.0,\ 0.0,\ 120.0,\ 130.0,\ 140.0,\ 220.0\},\ \ \textcolor{comment}{//\ [BRAKE]\ [OPMIN/DISP\_MIN/OPMAX/WARNING/ALARM]}}
\DoxyCodeLine{00154\ \};}
\DoxyCodeLine{00155\ \textcolor{keywordtype}{float}\ temp\_room\ =\ 77.0;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ "{}room"{}\ temperature\ is\ 25\ C\ =\ 77\ F\ \ Who\ cares?}}
\DoxyCodeLine{00156\ \textcolor{keywordtype}{float}\ temp\_sensor\_min\_f\ =\ -\/67.0;\ \textcolor{comment}{//\ minimum\ reading\ of\ sensor\ is\ -\/25\ C\ =\ -\/67\ F}}
\DoxyCodeLine{00157\ \textcolor{keywordtype}{float}\ temp\_sensor\_max\_f\ =\ 257.0;\ \textcolor{comment}{//\ maximum\ reading\ of\ sensor\ is\ 125\ C\ =\ 257\ F}}
\DoxyCodeLine{00158\ \textcolor{keywordtype}{float}\ maf\_min\_gps\ =\ 0.0;}
\DoxyCodeLine{00159\ \textcolor{keywordtype}{float}\ maf\_max\_gps\ =\ 50.0;\ \textcolor{comment}{//\ i\ just\ made\ this\ number\ up\ as\ i\ have\ no\ idea\ what's\ normal\ for\ MAF}}
\DoxyCodeLine{00160\ \textcolor{keywordtype}{bool}\ flashdemo\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00161\ int32\_t\ neobright\ =\ 10;\ \ \ \textcolor{comment}{//\ default\ for\ us\ dim/brighten\ the\ neopixels}}
\DoxyCodeLine{00162\ int32\_t\ neodesat\ =\ 0;\ \ \ \ \ \textcolor{comment}{//\ default\ for\ lets\ us\ de/saturate\ the\ neopixels}}
\DoxyCodeLine{00163\ \textcolor{keywordtype}{float}\ tuning\_rate\_pcps\ =\ 7.5;\ \ \textcolor{comment}{//\ values\ being\ edited\ by\ touch\ buttons\ change\ value\ at\ this\ percent\ of\ their\ overall\ range\ per\ second}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \textcolor{comment}{//\ non-\/tunable\ values.\ probably\ these\ belong\ with\ their\ related\ code}}
\DoxyCodeLine{00166\ uint32\_t\ codestatus\ =\ Booting;}
\DoxyCodeLine{00167\ \textcolor{keywordtype}{bool}\ running\_on\_devboard\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \textcolor{comment}{//\ will\ overwrite\ with\ value\ read\ thru\ pull\ resistor\ on\ tx\ pin\ at\ boot}}
\DoxyCodeLine{00168\ \textcolor{keywordtype}{bool}\ fun\_flag\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ since\ now\ using\ temp\ sensor\ address\ to\ detect\ vehicle,\ our\ tx\ resistor\ can\ be\ used\ for\ who\ knows\ what\ else!}}
\DoxyCodeLine{00169\ \textcolor{keywordtype}{bool}\ shutdown\_incomplete\ =\ \textcolor{keyword}{true};\ \ \ \ \ \ \ \ \textcolor{comment}{//\ minor\ state\ variable\ for\ shutdown\ mode\ -\/\ Shutdown\ mode\ has\ not\ completed\ its\ work\ and\ can't\ yet\ stop\ activity}}
\DoxyCodeLine{00170\ \textcolor{keywordtype}{bool}\ parking\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ indicates\ in\ process\ of\ parking\ the\ brake\ \&\ gas\ motors\ so\ the\ pedals\ can\ be\ used\ manually\ without\ interference}}
\DoxyCodeLine{00171\ \textcolor{keywordtype}{bool}\ releasing\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ indicates\ in\ process\ of\ releasing\ the\ brake\ to\ the\ zero\ brake\ point}}
\DoxyCodeLine{00172\ \textcolor{keywordtype}{bool}\ cruise\_adjusting\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00173\ \textcolor{keywordtype}{bool}\ cal\_brakemode\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ allows\ direct\ control\ of\ brake\ motor\ using\ controller\ vert}}
\DoxyCodeLine{00174\ \textcolor{keywordtype}{bool}\ cal\_brakemode\_request\ =\ \textcolor{keyword}{false};\ \ \ \ \ \textcolor{comment}{//\ allows\ direct\ control\ of\ brake\ motor\ using\ controller\ vert}}
\DoxyCodeLine{00175\ \textcolor{keywordtype}{bool}\ cal\_gasmode\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ allows\ direct\ control\ of\ gas\ servo\ using\ pot.\ First\ requires\ pot\ to\ be\ in\ valid\ position\ before\ mode\ is\ entered}}
\DoxyCodeLine{00176\ \textcolor{keywordtype}{bool}\ cal\_gasmode\_request\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00177\ \textcolor{keywordtype}{bool}\ car\_hasnt\_moved\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ minor\ state\ variable\ for\ fly\ mode\ -\/\ Whether\ car\ has\ moved\ at\ all\ since\ entering\ fly\ mode}}
\DoxyCodeLine{00178\ \textcolor{keywordtype}{bool}\ powering\_up\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ minor\ state\ variable\ for\ asleep\ mode}}
\DoxyCodeLine{00179\ \textcolor{keywordtype}{bool}\ calmode\_request\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00180\ \textcolor{keywordtype}{bool}\ flycruise\_toggle\_request\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00181\ \textcolor{keywordtype}{bool}\ screensaver\ =\ \textcolor{keyword}{false};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ can\ enable\ experiment\ with\ animated\ screen\ draws}}
\DoxyCodeLine{00182\ \textcolor{keywordtype}{bool}\ basicmode\_request\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00183\ \textcolor{keywordtype}{int}\ tunctrl\ =\ OFF,\ tunctrl\_last\ =\ OFF;}
\DoxyCodeLine{00184\ \textcolor{keywordtype}{int}\ datapage\ =\ PG\_RUN,\ datapage\_last\ =\ PG\_TEMP;\ \ \textcolor{comment}{//\ which\ of\ the\ dataset\ pages\ is\ currently\ displayed\ and\ available\ to\ edit?}}
\DoxyCodeLine{00185\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{int}\ sel\_val\ =\ 0;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ real\ time\ tuning\ UI,\ which\ of\ the\ editable\ values\ is\ selected.\ -\/1\ for\ none\ }}
\DoxyCodeLine{00186\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{int}\ sel\_val\_last\ =\ 0;\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00187\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{int}\ sel\_val\_last\_last\ =\ 0;\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00188\ \textcolor{keywordtype}{bool}\ syspower\ =\ HIGH;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ set\ by\ handler\ only.\ Reflects\ current\ state\ of\ the\ signal}}
\DoxyCodeLine{00189\ \textcolor{comment}{//\ bool\ basicmodesw\ =\ LOW;}}
\DoxyCodeLine{00190\ \textcolor{keywordtype}{int}\ sleep\_request\ =\ REQ\_NA;}
\DoxyCodeLine{00191\ \textcolor{keywordtype}{float}\ maf\_gps\ =\ 0;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ manifold\ mass\ airflow\ in\ grams\ per\ second}}
\DoxyCodeLine{00192\ uint16\_t\ heartbeat\_override\_color\ =\ 0x0000;}
\DoxyCodeLine{00193\ \textcolor{keywordtype}{bool}\ nowtouch\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00194\ \textcolor{keywordtype}{bool}\ captouch\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00195\ \textcolor{keywordtype}{float}\ loop\_avg\_us;}
\DoxyCodeLine{00196\ \textcolor{keywordtype}{bool}\ sensidiots[11];}
\DoxyCodeLine{00197\ \textcolor{keywordtype}{bool}\ web\_disabled\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00198\ \textcolor{keywordtype}{int}\ ui\_context\ =\ DatapagesUI;}
\DoxyCodeLine{00199\ \textcolor{keywordtype}{bool}\ panicstop\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00200\ \textcolor{comment}{//\ bool\ sensor\_present[telemetry\_full];}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \textcolor{comment}{//\ fast\ macros}}
\DoxyCodeLine{00203\ \textcolor{preprocessor}{\#define\ arraysize(x)\ ((int32\_t)(sizeof(x)\ /\ sizeof((x)[0])))\ \ }\textcolor{comment}{//\ a\ macro\ function\ to\ determine\ the\ length\ of\ string\ arrays}}
\DoxyCodeLine{00204\ \textcolor{preprocessor}{\#undef\ constrain}}
\DoxyCodeLine{00205\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{float}\ constrain(\textcolor{keywordtype}{float}\ amt,\ \textcolor{keywordtype}{float}\ low,\ \textcolor{keywordtype}{float}\ high)\ \{\ \textcolor{keywordflow}{return}\ (amt\ <\ low)\ ?\ low\ :\ ((amt\ >\ high)\ ?\ high\ :\ amt);\ \}}
\DoxyCodeLine{00206\ \textcolor{keyword}{inline}\ int32\_t\ constrain(int32\_t\ amt,\ int32\_t\ low,\ int32\_t\ high)\ \{\ \textcolor{keywordflow}{return}\ (amt\ <\ low)\ ?\ low\ :\ ((amt\ >\ high)\ ?\ high\ :\ amt);\ \}}
\DoxyCodeLine{00207\ \textcolor{keyword}{inline}\ uint32\_t\ constrain(uint32\_t\ amt,\ uint32\_t\ low,\ uint32\_t\ high)\ \{\ \textcolor{keywordflow}{return}\ (amt\ <\ low)\ ?\ low\ :\ ((amt\ >\ high)\ ?\ high\ :\ amt);\ \}}
\DoxyCodeLine{00208\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{long}\ constrain(\textcolor{keywordtype}{long}\ amt,\ \textcolor{keywordtype}{long}\ low,\ \textcolor{keywordtype}{long}\ high)\ \{\ \textcolor{keywordflow}{return}\ (amt\ <\ low)\ ?\ low\ :\ ((amt\ >\ high)\ ?\ high\ :\ amt);\ \}}
\DoxyCodeLine{00209\ \textcolor{preprocessor}{\#undef\ map}}
\DoxyCodeLine{00210\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{float}\ map(\textcolor{keywordtype}{float}\ x,\ \textcolor{keywordtype}{float}\ in\_min,\ \textcolor{keywordtype}{float}\ in\_max,\ \textcolor{keywordtype}{float}\ out\_min,\ \textcolor{keywordtype}{float}\ out\_max)\ \{}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordflow}{if}\ (in\_max\ -\/\ in\_min)\ \textcolor{keywordflow}{return}\ out\_min\ +\ (x\ -\/\ in\_min)\ *\ (out\_max\ -\/\ out\_min)\ /\ (in\_max\ -\/\ in\_min);}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordflow}{return}\ out\_max;\ \ \textcolor{comment}{//\ instead\ of\ dividing\ by\ zero,\ return\ the\ highest\ valid\ result}}
\DoxyCodeLine{00213\ \}}
\DoxyCodeLine{00214\ \textcolor{keyword}{inline}\ int32\_t\ map(int32\_t\ x,\ int32\_t\ in\_min,\ int32\_t\ in\_max,\ int32\_t\ out\_min,\ int32\_t\ out\_max)\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{keywordflow}{if}\ (in\_max\ -\/\ in\_min)\ \textcolor{keywordflow}{return}\ out\_min\ +\ (x\ -\/\ in\_min)\ *\ (out\_max\ -\/\ out\_min)\ /\ (in\_max\ -\/\ in\_min);}
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{keywordflow}{return}\ out\_max;\ \ \textcolor{comment}{//\ instead\ of\ dividing\ by\ zero,\ return\ the\ highest\ valid\ result}}
\DoxyCodeLine{00217\ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \textcolor{comment}{//\ pin\ operations}}
\DoxyCodeLine{00220\ \textcolor{keywordtype}{void}\ set\_pin(\textcolor{keywordtype}{int}\ pin,\ \textcolor{keywordtype}{int}\ mode)\ \{\ \textcolor{keywordflow}{if}\ (pin\ >=\ 0\ \&\&\ pin\ !=\ 255)\ pinMode\ (pin,\ mode);\ \}}
\DoxyCodeLine{00221\ \textcolor{keywordtype}{void}\ write\_pin(\textcolor{keywordtype}{int}\ pin,\ \textcolor{keywordtype}{int}\ val)\ \{\ \ \textcolor{keywordflow}{if}\ (pin\ >=\ 0\ \&\&\ pin\ !=\ 255)\ digitalWrite\ (pin,\ val);\ \}}
\DoxyCodeLine{00222\ \textcolor{keywordtype}{void}\ set\_pin(\textcolor{keywordtype}{int}\ pin,\ \textcolor{keywordtype}{int}\ mode,\ \textcolor{keywordtype}{int}\ val)\ \{\ set\_pin(pin,\ mode);\ write\_pin(pin,\ val);\ \}}
\DoxyCodeLine{00223\ int32\_t\ read\_pin(int32\_t\ pin)\ \{\ \textcolor{keywordflow}{return}\ (pin\ >=\ 0\ \&\&\ pin\ !=\ 255)\ ?\ digitalRead\ (pin)\ :\ -\/1;\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \textcolor{keywordtype}{float}\ convert\_units(\textcolor{keywordtype}{float}\ from\_units,\ \textcolor{keywordtype}{float}\ convert\_factor,\ \textcolor{keywordtype}{bool}\ invert,\ \textcolor{keywordtype}{float}\ in\_offset\ =\ 0.0,\ \textcolor{keywordtype}{float}\ out\_offset\ =\ 0.0)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordflow}{if}\ (!invert)\ \textcolor{keywordflow}{return}\ out\_offset\ +\ convert\_factor\ *\ (from\_units\ -\/\ in\_offset);}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keywordflow}{if}\ (from\_units\ -\/\ in\_offset)\ \textcolor{keywordflow}{return}\ out\_offset\ +\ convert\_factor\ /\ (from\_units\ -\/\ in\_offset);}
\DoxyCodeLine{00228\ \ \ \ \ printf\ (\textcolor{stringliteral}{"{}convert\_units\ refused\ to\ divide\ by\ zero:\ \%lf,\ \%lf,\ \%d,\ \%lf,\ \%lf"{}},\ from\_units,\ convert\_factor,\ invert,\ in\_offset,\ out\_offset);}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00230\ \}}
\DoxyCodeLine{00231\ \textcolor{comment}{//\ Exponential\ Moving\ Average\ filter\ :\ smooth\ out\ noise\ on\ inputs.\ 0\ <\ alpha\ <\ 1\ where\ lower\ =\ smoother\ and\ higher\ =\ more\ responsive}}
\DoxyCodeLine{00232\ \textcolor{comment}{//\ pass\ in\ a\ fresh\ raw\ value,\ address\ of\ filtered\ value,\ and\ alpha\ factor,\ filtered\ value\ will\ get\ updated}}
\DoxyCodeLine{00233\ \textcolor{keywordtype}{float}\ ema\_filt(\textcolor{keywordtype}{float}\ \_raw,\ \textcolor{keywordtype}{float}\ \_filt,\ \textcolor{keywordtype}{float}\ \_alpha)\ \{}
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{keywordflow}{return}\ (\_alpha\ *\ \_raw)\ +\ ((1\ -\/\ \_alpha)\ *\ \_filt);}
\DoxyCodeLine{00235\ \}}
\DoxyCodeLine{00236\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ RAW\_T,\ \textcolor{keyword}{typename}\ FILT\_T>}
\DoxyCodeLine{00237\ \textcolor{keywordtype}{void}\ ema\_filt(RAW\_T\ \_raw,\ FILT\_T*\ \_filt,\ \textcolor{keywordtype}{float}\ \_alpha)\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordtype}{float}\ \_raw\_f\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(\_raw);}
\DoxyCodeLine{00239\ \ \ \ \ \textcolor{keywordtype}{float}\ \_filt\_f\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(*\_filt);}
\DoxyCodeLine{00240\ \ \ \ \ *\_filt\ =\ \textcolor{keyword}{static\_cast<}FILT\_T\textcolor{keyword}{>}(ema\_filt(\_raw\_f,\ \_filt\_f,\ \_alpha));}
\DoxyCodeLine{00241\ \}}
\DoxyCodeLine{00242\ \textcolor{comment}{//\ functions\ for\ changing\ values\ while\ respecting\ min\ and\ max\ constraints.\ used\ in\ tuner\ ui}}
\DoxyCodeLine{00243\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00244\ T\ adj\_val(T\ variable,\ T\ modify,\ T\ low\_limit,\ T\ high\_limit)\ \{}
\DoxyCodeLine{00245\ \ \ \ \ T\ oldval\ =\ variable;}
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::is\_same<T,\ int32\_t>::value)\ variable\ +=\ (T)modify;}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (std::is\_same<T,\ float>::value)\ variable\ +=\ (T)(modify\ *\ tuning\_rate\_pcps\ *\ (high\_limit-\/low\_limit)\ *\ loop\_avg\_us\ /\ (1000000\ *\ 100.0));}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{return}\ variable\ <\ low\_limit\ ?\ low\_limit\ :\ (variable\ >\ high\_limit\ ?\ high\_limit\ :\ variable);}
\DoxyCodeLine{00249\ \}}
\DoxyCodeLine{00250\ \textcolor{keywordtype}{bool}\ adj\_val(int32\_t\ *variable,\ int32\_t\ modify,\ int32\_t\ low\_limit,\ int32\_t\ high\_limit)\ \{\ \textcolor{comment}{//\ sets\ an\ int\ reference\ to\ new\ val\ constrained\ to\ given\ range}}
\DoxyCodeLine{00251\ \ \ \ \ int32\_t\ oldval\ =\ *variable;}
\DoxyCodeLine{00252\ \ \ \ \ *variable\ =\ adj\_val(*variable,\ modify,\ low\_limit,\ high\_limit);}
\DoxyCodeLine{00253\ \ \ \ \ \textcolor{keywordflow}{return}\ (*variable\ !=\ oldval);}
\DoxyCodeLine{00254\ \}}
\DoxyCodeLine{00255\ \textcolor{keywordtype}{bool}\ adj\_val(\textcolor{keywordtype}{float}\ *variable,\ \textcolor{keywordtype}{float}\ modify,\ \textcolor{keywordtype}{float}\ low\_limit,\ \textcolor{keywordtype}{float}\ high\_limit)\ \{\ \textcolor{comment}{//\ sets\ an\ int\ reference\ to\ new\ val\ constrained\ to\ given\ range}}
\DoxyCodeLine{00256\ \ \ \ \ \textcolor{keywordtype}{float}\ oldval\ =\ *variable;}
\DoxyCodeLine{00257\ \ \ \ \ *variable\ =\ adj\_val(*variable,\ modify,\ low\_limit,\ high\_limit);}
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{keywordflow}{return}\ (*variable\ !=\ oldval);}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ \textcolor{keywordtype}{bool}\ adj\_bool(\textcolor{keywordtype}{bool}\ val,\ int32\_t\ delta)\ \{\ \textcolor{keywordflow}{return}\ delta\ !=\ 0\ ?\ delta\ >\ 0\ :\ val;\ \}\ \textcolor{comment}{//\ returns\ 1\ on\ delta=1,\ 0\ on\ delta=-\/1,\ or\ val\ on\ delta=0}}
\DoxyCodeLine{00261\ \textcolor{keywordtype}{void}\ adj\_bool(\textcolor{keywordtype}{bool}\ *val,\ int32\_t\ delta)\ \{\ *val\ =\ adj\_bool(*val,\ delta);\ \}\ \ \ \ \ \ \ \textcolor{comment}{//\ sets\ a\ bool\ reference\ to\ 1\ on\ 1\ delta\ or\ 0\ on\ -\/1\ delta}}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00264\ T\ hsv\_to\_rgb(uint16\_t\ hue,\ uint8\_t\ sat\ =\ 255,\ uint8\_t\ val\ =\ 255)\ \{}
\DoxyCodeLine{00265\ \ \ \ \ uint8\_t\ rgb[3]\ =\ \{\ 0,\ 0,\ 0\ \};\ \ \textcolor{comment}{//\ [r,g,b];}}
\DoxyCodeLine{00266\ \ \ \ \ hue\ =\ (hue\ *\ 1530L\ +\ 32768)\ /\ 65536;}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{keywordflow}{if}\ (hue\ <\ 510)\ \{\ \textcolor{comment}{//\ Red\ to\ Green-\/1}}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (hue\ <\ 255)\ \{\ rgb[0]\ =\ 255;\ rgb[1]\ =\ hue;\ \}\ \ \textcolor{comment}{//\ \ \ Red\ to\ Yellow-\/1,\ g\ =\ 0\ to\ 254}}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ rgb[0]\ =\ 510\ -\/\ hue;\ rgb[1]\ =\ 255;\ \}\ \ \textcolor{comment}{//\ \ Yellow\ to\ Green-\/1,\ r\ =\ 255\ to\ 1}}
\DoxyCodeLine{00270\ \ \ \ \ \}}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (hue\ <\ 1020)\ \{\ \textcolor{comment}{//\ Green\ to\ Blue-\/1}}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (hue\ <\ 765)\ \{\ rgb[1]\ =\ 255;\ rgb[2]\ =\ hue\ -\/\ 510;\ \}\ \ \textcolor{comment}{//\ \ Green\ to\ Cyan-\/1,\ b\ =\ 0\ to\ 254}}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ rgb[1]\ =\ 1020\ -\/\ hue;\ rgb[2]\ =\ 255;\ \}\ \ \textcolor{comment}{//\ Cyan\ to\ Blue-\/1,\ g\ =\ 255\ to\ 1}}
\DoxyCodeLine{00274\ \ \ \ \ \}}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (hue\ <\ 1530)\ \{\ \ \textcolor{comment}{//\ Blue\ to\ Red-\/1}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (hue\ <\ 1275)\ \{\ rgb[0]\ =\ hue\ -\/\ 1020;\ rgb[2]\ =\ 255;\ \}\ \ \textcolor{comment}{//\ Blue\ to\ Magenta-\/1,\ r\ =\ 0\ to\ 254}}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ rgb[0]\ =\ 255;\ rgb[2]\ =\ 1530\ -\/\ hue;\ \}\ \ \textcolor{comment}{//\ \ \ Magenta\ to\ Red-\/1,\ b\ =\ 255\ to\ 1}}
\DoxyCodeLine{00278\ \ \ \ \ \}}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ rgb[0]\ =\ 255;\ \}\ \ \textcolor{comment}{//\ Last\ 0.5\ Red\ (quicker\ than\ \%\ operator)}}
\DoxyCodeLine{00280\ \ \ \ \ uint32\_t\ v1\ =\ 1\ +\ val;\ \ \textcolor{comment}{//\ 1\ to\ 256;\ allows\ >>8\ instead\ of\ /255}}
\DoxyCodeLine{00281\ \ \ \ \ uint16\_t\ s1\ =\ 1\ +\ sat;\ \ \textcolor{comment}{//\ 1\ to\ 256;\ same\ reason}}
\DoxyCodeLine{00282\ \ \ \ \ uint8\_t\ s2\ =\ 255\ -\/\ sat;\ \textcolor{comment}{//\ 255\ to\ 0}}
\DoxyCodeLine{00283\ \ \ \ \ uint16\_t\ out[3];}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ led=0;\ led<3;\ led++)\ out[led]\ =\ (((((rgb[led]\ *\ s1)\ >>\ 8)\ +\ s2)\ *\ v1)\ \&\ 0xff00)\ >>\ 8;}
\DoxyCodeLine{00285\ \ \ \ \ \textcolor{comment}{//\ if\ (fake\_color332)\ \{}}
\DoxyCodeLine{00286\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ if\ (std::is\_same<T,\ uint16\_t>::value)\ return\ (T)((out[0]\ \&\ 0xe0)\ <<\ 8)\ |\ ((out[1]\ \&\ 0xe0)\ <<\ 5)\ |\ ((out[2]\ \&\ 0xc0)\ >>\ 3);}}
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::is\_same<T,\ uint16\_t>::value)\ \textcolor{keywordflow}{return}\ (T)((out[0]\ \&\ 0xf8)\ <<\ 8)\ |\ ((out[1]\ \&\ 0xfc)\ <<\ 5)\ |\ (out[2]\ >>\ 3);}
\DoxyCodeLine{00289\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (std::is\_same<T,\ uint8\_t>::value)\ \textcolor{keywordflow}{return}\ (T)((out[0]\ \&\ 0xe0)\ |\ ((out[1]\ \&\ 0xe0)\ >>\ 3)\ |\ ((out[2]\ \&\ 0xc0)\ >>\ 6));}
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (std::is\_same<T,\ uint32\_t>::value)\ \textcolor{keywordflow}{return}\ (T)((out[0]\ <<\ 16)\ |\ (out[1]\ <<\ 8)\ |\ out[2]);}
\DoxyCodeLine{00291\ \}}
\DoxyCodeLine{00292\ \textcolor{comment}{//\ template\ <typename\ T>}}
\DoxyCodeLine{00293\ \textcolor{comment}{//\ T\ hsv\_to\_rgb(uint8\_t\ hue,\ uint8\_t\ sat,\ uint8\_t\ val)\ \{}}
\DoxyCodeLine{00294\ \textcolor{comment}{//\ \ \ \ \ return\ hsv\_to\_rgb((uint16\_t)hue\ <<\ 8,\ sat,\ val);}}
\DoxyCodeLine{00295\ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00296\ uint8\_t\ rando\_color()\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \textcolor{keywordflow}{return}\ ((uint8\_t)random(0x7)\ <<\ 5)\ |\ ((uint8\_t)random(0x7)\ <<\ 2)\ |\ (uint8\_t)random(0x3);\ }
\DoxyCodeLine{00298\ \}}
\DoxyCodeLine{00299\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_timer}{Timer}}\ \{\ \ \textcolor{comment}{//\ !!!\ beware,\ this\ 54-\/bit\ microsecond\ timer\ overflows\ after\ every\ 571\ years}}
\DoxyCodeLine{00300\ \ \ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keyword}{volatile}\ int64\_t\ start\_us,\ timeout\_us;}
\DoxyCodeLine{00302\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00303\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}()\ \{\ reset();\ \}}
\DoxyCodeLine{00304\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}(uint32\_t\ arg\_timeout\_us)\ \{\ set\ ((int64\_t)arg\_timeout\_us);\ \}}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ set\ (int64\_t\ arg\_timeout\_us)\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ timeout\_us\ =\ arg\_timeout\_us;}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ start\_us\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00308\ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ reset()\ \{\ start\_us\ =\ esp\_timer\_get\_time();\ \}}
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{keywordtype}{bool}\ IRAM\_ATTR\ expired()\ \{\ \textcolor{keywordflow}{return}\ esp\_timer\_get\_time()\ >=\ start\_us\ +\ timeout\_us;\ \}}
\DoxyCodeLine{00311\ \ \ \ \ int64\_t\ IRAM\_ATTR\ elapsed()\ \{\ \textcolor{keywordflow}{return}\ esp\_timer\_get\_time()\ -\/\ start\_us;\ \}}
\DoxyCodeLine{00312\ \ \ \ \ int64\_t\ timeout()\ \{\ \textcolor{keywordflow}{return}\ timeout\_us;\ \}}
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{keywordtype}{bool}\ IRAM\_ATTR\ expireset()\ \{\ \ \textcolor{comment}{//\ Like\ expired()\ but\ immediately\ resets\ if\ expired}}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ int64\_t\ now\_us\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now\_us\ <\ start\_us\ +\ timeout\_us)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ start\_us\ =\ now\_us;}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00318\ \ \ \ \ \}\ \ \ \ }
\DoxyCodeLine{00319\ \};}
\DoxyCodeLine{00320\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_abs_timer}{AbsTimer}}\ \{\ \ \textcolor{comment}{//\ absolute\ timer\ ensures\ consecutive\ timeouts\ happen\ on\ regular\ intervals}}
\DoxyCodeLine{00321\ \ \ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00322\ \ \ \ \ \textcolor{keyword}{volatile}\ int64\_t\ end,\ timeout\_us;}
\DoxyCodeLine{00323\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00324\ \ \ \ \ \mbox{\hyperlink{class_abs_timer}{AbsTimer}}()\ \{\ reset();\ \}}
\DoxyCodeLine{00325\ \ \ \ \ \mbox{\hyperlink{class_abs_timer}{AbsTimer}}(uint32\_t\ arg\_timeout)\ \{\ set\ ((int64\_t)arg\_timeout);\ \}}
\DoxyCodeLine{00326\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ set\ (int64\_t\ arg\_timeout)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ timeout\_us\ =\ arg\_timeout;}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ end\ =\ esp\_timer\_get\_time()\ +\ timeout\_us;}
\DoxyCodeLine{00329\ \ \ \ \ \}}
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ set()\ \{\ end\ =\ esp\_timer\_get\_time()\ +\ timeout\_us;\ \}\ \ \textcolor{comment}{//\ use\ to\ rezero\ the\ timer\ phase}}
\DoxyCodeLine{00331\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ reset()\ \{\ \ \textcolor{comment}{//\ move\ expiration\ to\ the\ next\ timeout\ multiple}}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ int64\_t\ now\ =\ esp\_timer\_get\_time();}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now\ >=\ end)\ end\ +=\ timeout\_us\ *\ (1\ +\ (now\ -\/\ end)\ /\ timeout\_us);}
\DoxyCodeLine{00334\ \ \ \ \ \}}
\DoxyCodeLine{00335\ \ \ \ \ \textcolor{keywordtype}{bool}\ IRAM\_ATTR\ expired()\ \{\ \textcolor{keywordflow}{return}\ esp\_timer\_get\_time()\ >=\ end;\ \}}
\DoxyCodeLine{00336\ \ \ \ \ int64\_t\ IRAM\_ATTR\ elapsed()\ \{\ \textcolor{keywordflow}{return}\ esp\_timer\_get\_time()\ +\ timeout\_us\ -\/\ end;\ \}}
\DoxyCodeLine{00337\ \ \ \ \ int64\_t\ timeout()\ \{\ \textcolor{keywordflow}{return}\ timeout\_us;\ \}\ \ \ \ }
\DoxyCodeLine{00338\ \ \ \ \ \textcolor{comment}{//\ never\ finished\ writing\ this\ ...}}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{comment}{//\ uint32\_t\ IRAM\_ATTR\ expireset()\ \{\ \ //\ Like\ expired()\ but\ immediately\ resets\ if\ expired}}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ int64\_t\ now\_us\ =\ esp\_timer\_get\_time();}}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ if\ (now\ >=\ end)\ }}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ end\ +=\ timeout\_us\ *\ (1\ +\ (now\ -\/\ end)\ /\ timeout\_us);}}
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ if\ (now\_us\ <\ start\_us\ +\ timeout\_us)\ return\ false;}}
\DoxyCodeLine{00345\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ start\_us\ =\ now\_us;}}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ return\ true;}}
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00348\ \};}
\DoxyCodeLine{00349\ \mbox{\hyperlink{class_timer}{Timer}}\ sleep\_inactivity\_timer(300000000);}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \textcolor{keywordtype}{void}\ kick\_inactivity\_timer(\textcolor{keywordtype}{int}\ source=0)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ sleep\_inactivity\_timer.reset();\ \ \textcolor{comment}{//\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00353\ \ \ \ \ \textcolor{comment}{//\ Serial.printf("{}kick\%d\ "{},\ source);}}
\DoxyCodeLine{00354\ \}}

\end{DoxyCode}

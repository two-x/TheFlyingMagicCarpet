\doxysection{inputs.\+h}
\hypertarget{inputs_8h_source}{}\label{inputs_8h_source}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ "{}FunctionalInterrupt.h"{}}}
\DoxyCodeLine{00003\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_momentary_button}{MomentaryButton}}\ \{}
\DoxyCodeLine{00004\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00005\ \ \ \ \ int32\_t\ \_sw\_action\ =\ swNONE;\ \ \textcolor{comment}{//\ Flag\ for\ encoder\ handler\ to\ know\ an\ encoder\ switch\ action\ needs\ to\ be\ handled}}
\DoxyCodeLine{00006\ \ \ \ \ \textcolor{keywordtype}{bool}\ \_timer\_active\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Flag\ to\ prevent\ re-\/handling\ long\ presses\ if\ the\ sw\ is\ just\ kept\ down}}
\DoxyCodeLine{00007\ \ \ \ \ \textcolor{keywordtype}{bool}\ \_suppress\_click\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Flag\ to\ prevent\ a\ short\ click\ on\ switch\ release\ after\ successful\ long\ press}}
\DoxyCodeLine{00008\ \ \ \ \ \textcolor{keywordtype}{bool}\ activity\_timer\_keepalive\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ will\ activity\ on\ this\ switch\ be\ considered\ that\ the\ user\ is\ active?}}
\DoxyCodeLine{00009\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ \_spinspeedTimer;\ \ \textcolor{comment}{//\ Used\ to\ figure\ out\ how\ fast\ we're\ spinning\ the\ knob.\ \ OK\ to\ not\ be\ volatile?}}
\DoxyCodeLine{00010\ \ \ \ \ \textcolor{comment}{//\ \ -\/-\/-\/-\/\ tunable\ -\/-\/-\/-\/}}
\DoxyCodeLine{00011\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ \_longPressTimer\ =\ \mbox{\hyperlink{class_timer}{Timer}}(375000);\ \ \textcolor{comment}{//\ Used\ to\ time\ long\ button\ presses}}
\DoxyCodeLine{00012\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00013\ \ \ \ \ \textcolor{keywordtype}{int}\ \_sw\_pin\ =\ -\/1;}
\DoxyCodeLine{00014\ \ \ \ \ \textcolor{keywordtype}{bool}\ now\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Remember\ whether\ switch\ is\ being\ pressed}}
\DoxyCodeLine{00015\ \ \ \ \ \mbox{\hyperlink{class_momentary_button}{MomentaryButton}}()\ \{\}}
\DoxyCodeLine{00016\ \ \ \ \ \mbox{\hyperlink{class_momentary_button}{MomentaryButton}}(\textcolor{keywordtype}{int}\ pin,\ \textcolor{keywordtype}{bool}\ \_act\_keepalive=\textcolor{keyword}{true})\ :\ \_sw\_pin(pin),\ activity\_timer\_keepalive(\_act\_keepalive)\ \{\}}
\DoxyCodeLine{00017\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_pin(\textcolor{keywordtype}{int}\ pin)\ \{}
\DoxyCodeLine{00018\ \ \ \ \ \ \ \ \ \_sw\_pin\ =\ pin;}
\DoxyCodeLine{00019\ \ \ \ \ \}}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ and\ interpret\ encoder\ switch\ activity.\ Encoder\ rotation\ is\ handled\ in\ interrupt\ routine}}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Encoder\ handler\ routines\ should\ act\ whenever\ encoder\_sw\_action\ is\ swSHORT\ or\ swLONG,\ setting\ it\ back\ to}}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ swNONE\ once\ handled.\ When\ handling\ press,\ if\ encoder\_long\_clicked\ is\ nonzero\ then\ press\ is\ a\ long\ press}}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ myread\ =\ now;}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \ \ \ \ myread\ =\ digitalRead(\_sw\_pin);\ \ \ \textcolor{comment}{//\ !value\ because\ electrical\ signal\ is\ active\ low}}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (myread\ !=\ digitalRead(\_sw\_pin));\ \textcolor{comment}{//\ some\ pins\ have\ a\ tiny\ (70ns)\ window\ in\ which\ it\ could\ get\ invalid\ low\ values,\ so\ read\ it\ twice\ to\ be\ sure}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!myread)\ \{\ \ \textcolor{comment}{//\ if\ encoder\ sw\ is\ being\ pressed\ (switch\ is\ active\ low)}}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!now)\ \{\ \ \textcolor{comment}{//\ if\ the\ press\ just\ occurred}}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (activity\_timer\_keepalive)\ kick\_inactivity\_timer(0);\ \ \textcolor{comment}{//\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_longPressTimer.reset();\ \ \textcolor{comment}{//\ start\ a\ press\ timer}}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_timer\_active\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ flag\ to\ indicate\ timing\ for\ a\ possible\ long\ press}}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_timer\_active\ \&\&\ \_longPressTimer.expired())\ \{\ \ \textcolor{comment}{//\ If\ press\ time\ exceeds\ long\ press\ threshold}}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_sw\_action\ =\ swLONG;\ \ \textcolor{comment}{//\ Set\ flag\ to\ handle\ the\ long\ press\ event.\ Note,\ routine\ handling\ press\ should\ clear\ this}}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_timer\_active\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Keeps\ us\ from\ entering\ this\ logic\ again\ until\ after\ next\ sw\ release\ (to\ prevent\ repeated\ long\ presses)}}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_suppress\_click\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ Prevents\ the\ switch\ release\ after\ a\ long\ press\ from\ causing\ a\ short\ press}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ now\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ Remember\ a\ press\ is\ in\ effect}}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ \ \textcolor{comment}{//\ if\ encoder\ sw\ is\ not\ being\ pressed}}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (now)\ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (activity\_timer\_keepalive)\ kick\_inactivity\_timer(1);\ \ \textcolor{comment}{//\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!\_suppress\_click)\ \_sw\_action\ =\ swSHORT;\ \ \textcolor{comment}{//\ if\ the\ switch\ was\ just\ released,\ a\ short\ press\ occurred,\ which\ must\ be\ handled}}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \_timer\_active\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Allows\ detection\ of\ next\ long\ press\ event}}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ now\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ Remember\ press\ is\ not\ in\ effect}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \_suppress\_click\ =\ \textcolor{keyword}{false};\ \ \textcolor{comment}{//\ End\ click\ suppression}}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00051\ \ \ \ \ \}}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{bool}\ pressed()\ \{}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ now;}
\DoxyCodeLine{00054\ \ \ \ \ \}}
\DoxyCodeLine{00055\ \ \ \ \ uint32\_t\ press\_event(\textcolor{keywordtype}{bool}\ autoreset\ =\ \textcolor{keyword}{true})\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ uint32\_t\ ret\ =\ \_sw\_action;}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (autoreset)\ \_sw\_action\ =\ swNONE;}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ ret;}
\DoxyCodeLine{00059\ \ \ \ \ \}}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordtype}{void}\ press\_reset()\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \_sw\_action\ =\ swNONE;}
\DoxyCodeLine{00062\ \ \ \ \ \}}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{bool}\ longpress()\ \{\ \ \textcolor{comment}{//\ code\ may\ call\ this\ to\ check\ for\ long\ press\ and\ if\ so\ act\ upon\ it.\ Resets\ the\ long\ press\ if\ asserted}}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ ret\ =\ (\_sw\_action\ ==\ swLONG);}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ret)\ \_sw\_action\ =\ swNONE;}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ ret;}
\DoxyCodeLine{00067\ \ \ \ \ \}}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordtype}{bool}\ shortpress()\ \{\ \ \textcolor{comment}{//\ code\ may\ call\ this\ to\ check\ for\ short\ press\ and\ if\ so\ act\ upon\ it.\ Resets\ the\ long\ press\ if\ asserted}}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ ret\ =\ (\_sw\_action\ ==\ swSHORT);}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ret)\ \_sw\_action\ =\ swNONE;}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ ret;}
\DoxyCodeLine{00072\ \ \ \ \ \}}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{void}\ setup(\textcolor{keywordtype}{int}\ pin\ =\ -\/1)\ \{}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pin\ !=\ -\/1)\ \_sw\_pin\ =\ pin;}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ pinMode(\_sw\_pin,\ INPUT\_PULLUP);}
\DoxyCodeLine{00076\ \ \ \ \ \}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordtype}{void}\ setLongPressTimer(uint32\_t\ t)\{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \_longPressTimer.set(t);}
\DoxyCodeLine{00079\ \ \ \ \ \}}
\DoxyCodeLine{00080\ \};}
\DoxyCodeLine{00081\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_encoder}{Encoder}}\ \{}
\DoxyCodeLine{00082\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keyword}{enum}\ \_inputs\ \{\ ENC\_A,\ ENC\_B\ \};}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ class\ vars}}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{comment}{//\ \ -\/-\/-\/-\/\ tunable\ -\/-\/-\/-\/}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{//\ TODO:\ these\ are\ all\ currently\ private\ const,\ if\ we\ ever\ actually\ want\ to\ tune\ them\ live\ we\ would\ need\ to\ change\ this}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ uint32\_t\ \_spinrate\_min\_us\ =\ 2500;\ \ \textcolor{comment}{//\ Will\ reject\ spins\ faster\ than\ this\ as\ an\ attempt\ to\ debounce\ behavior}}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ uint32\_t\ \_accel\_thresh\_us\ =\ 60000;\ \ \textcolor{comment}{//\ Spins\ faster\ than\ this\ will\ be\ accelerated}}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ int32\_t\ \_accel\_max\ =\ 15;\ \ \textcolor{comment}{//\ Maximum\ acceleration\ factor}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{//\ instance\ vars}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keyword}{volatile}\ uint32\_t\ \_spinrate\_isr\_us\ =\ 100000;\ \ \textcolor{comment}{//\ Time\ elapsed\ between\ last\ two\ detents}}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keyword}{volatile}\ int32\_t\ \_bounce\_danger\ =\ ENC\_B;\ \ \textcolor{comment}{//\ Which\ of\ the\ encoder\ A\ or\ B\ inputs\ is\ currently\ untrustworthy\ due\ to\ bouncing\ }}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{volatile}\ int32\_t\ \_delta\ =\ 0;\ \ \textcolor{comment}{//\ Keeps\ track\ of\ un-\/handled\ rotary\ clicks\ of\ the\ encoder.\ \ Positive\ for\ CW\ clicks,\ Negative\ for\ CCW.\ }}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordtype}{int}\ \_a\_pin,\ \_b\_pin,\ \_sw\_pin;}
\DoxyCodeLine{00097\ \ \ \ \ int32\_t\ \_state\ =\ 0;}
\DoxyCodeLine{00098\ \ \ \ \ uint32\_t\ \_spinrate\_us\ =\ 1000000;\ \ \textcolor{comment}{//\ How\ many\ us\ elapsed\ between\ the\ last\ two\ encoder\ detents?\ realistic\ range\ while\ spinning\ is\ 5\ to\ 100\ ms\ I'd\ guess}}
\DoxyCodeLine{00099\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ \_spinspeedTimer;\ \ \textcolor{comment}{//\ Used\ to\ figure\ out\ how\ fast\ we're\ spinning\ the\ knob.\ \ OK\ to\ not\ be\ volatile?}}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ \ -\/-\/-\/-\/\ tunable\ -\/-\/-\/-\/}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ \_a\_isr()\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bounce\_danger\ !=\ Encoder::ENC\_A)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!enc\_a)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_spinrate\_isr\_us\ =\ \_spinspeedTimer.elapsed();}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_spinspeedTimer.reset();}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \_spinrate\_isr\_us\ =\ \_spinspeedTimer.elapset();}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ enc\_b\ =\ !digitalRead(\_b\_pin);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_delta\ +=\ enc\_b\ ?\ -\/1\ :\ 1;}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \_bounce\_danger\ =\ Encoder::ENC\_A;}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordtype}{void}\ IRAM\_ATTR\ \_b\_isr()\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bounce\_danger\ !=\ Encoder::ENC\_B)\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ enc\_a\ =\ !digitalRead(\_a\_pin);}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \_bounce\_danger\ =\ Encoder::ENC\_B;}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00123\ \ \ \ \ \mbox{\hyperlink{class_momentary_button}{MomentaryButton}}\ button;}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordtype}{bool}\ enc\_a\ =\ LOW;\ \ \textcolor{comment}{//\ if\ initializing\ HIGH\ sets\ us\ up\ right\ after\ a\ reboot\ with\ a\ bit\ of\ a\ hair\ trigger\ which\ turns\ left\ at\ the\ slightest\ touch}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordtype}{bool}\ enc\_b\ =\ HIGH;}
\DoxyCodeLine{00126\ \ \ \ \ \mbox{\hyperlink{class_encoder}{Encoder}}(\textcolor{keywordtype}{int}\ a,\ \textcolor{keywordtype}{int}\ b,\ \textcolor{keywordtype}{int}\ sw)\ :\ \_a\_pin(a),\ \_b\_pin(b),\ \_sw\_pin(sw)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ button.setup(\_sw\_pin);}
\DoxyCodeLine{00128\ \ \ \ \ \}}
\DoxyCodeLine{00129\ \ \ \ \ \mbox{\hyperlink{class_encoder}{Encoder}}()\ =\ \textcolor{keyword}{delete};\ \textcolor{comment}{//\ must\ be\ instantiated\ with\ pins}}
\DoxyCodeLine{00130\ \ \ \ \ }
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Encoder\ setup..\(\backslash\)n"{}});}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ set\_pin(\_a\_pin,\ INPUT\_PULLUP);}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ set\_pin(\_b\_pin,\ INPUT\_PULLUP);}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ button.setup();}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ set\_pin(\_sw\_pin,\ INPUT\_PULLUP);\ \ //\ The\ esp32\ pullup\ is\ too\ weak.\ Use\ resistor}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ attachInterrupt(digitalPinToInterrupt(\_a\_pin),\ [\textcolor{keyword}{this}]\{\ \_a\_isr();\ \},\ CHANGE);\ \(\backslash\)}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ attachInterrupt(digitalPinToInterrupt(\_b\_pin),\ [\textcolor{keyword}{this}]\{\ \_b\_isr();\ \},\ CHANGE);}
\DoxyCodeLine{00139\ \ \ \ \ \}}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ button.update();}
\DoxyCodeLine{00142\ \ \ \ \ \}}
\DoxyCodeLine{00143\ \ \ \ \ int32\_t\ rotation(\textcolor{keywordtype}{bool}\ accel\ =\ \textcolor{keyword}{false})\ \{\ \ \textcolor{comment}{//\ Returns\ detents\ spun\ since\ last\ call,\ accelerated\ by\ spin\ rate\ or\ not}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ int32\_t\ d\ =\ 0;}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_delta)\ \{\ \ \textcolor{comment}{//\ Now\ handle\ any\ new\ rotations}}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ kick\_inactivity\_timer(2);\ \ \textcolor{comment}{//\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_spinrate\_isr\_us\ >=\ \_spinrate\_min\_us)\ \{\ \ \textcolor{comment}{//\ Reject\ clicks\ coming\ in\ too\ fast\ as\ bounces}}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (accel)\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_spinrate\_us\ =\ constrain\ (\_spinrate\_isr\_us,\ \_spinrate\_min\_us,\ \_accel\_thresh\_us);}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_spinrate\_us\ =\ map\ (\_spinrate\_us,\ \_spinrate\_min\_us,\ \_accel\_thresh\_us,\ \_accel\_max,\ 1);\ \ \textcolor{comment}{//\ if\ turning\ faster\ than\ 100ms/det,\ proportionally\ accelerate\ the\ effect\ of\ each\ detent\ by\ up\ to\ 50x.\ encoder\_temp\ variable\ repurposed\ here\ to\ hold\ \#\ of\ edits\ per\ detent\ turned}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ d\ =\ \_delta\ *\ \_spinrate\_us;\ \ \textcolor{comment}{//\ If\ a\ tunable\ value\ is\ being\ edited,\ turning\ the\ encoder\ changes\ the\ value}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ d\ =\ constrain\ (\_delta,\ -\/1,\ 1);\ \ \textcolor{comment}{//\ Only\ change\ one\ at\ a\ time\ when\ selecting\ or\ turning\ pages}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \_delta\ =\ 0;\ \ \textcolor{comment}{//\ Our\ responsibility\ to\ reset\ this\ flag\ after\ handling\ events}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ \};}
\DoxyCodeLine{00160\ \textcolor{preprocessor}{\#define\ touch\_cell\_v\_pix\ 48\ \ }\textcolor{comment}{//\ When\ touchscreen\ gridded\ as\ buttons,\ height\ of\ each\ button}}
\DoxyCodeLine{00161\ \textcolor{preprocessor}{\#define\ touch\_cell\_h\_pix\ 53\ \ }\textcolor{comment}{//\ When\ touchscreen\ gridded\ as\ buttons,\ width\ of\ each\ button}}
\DoxyCodeLine{00162\ \textcolor{preprocessor}{\#define\ touch\_margin\_h\_pix\ 1\ \ }\textcolor{comment}{//\ On\ horizontal\ axis,\ we\ need\ an\ extra\ margin\ along\ both\ sides\ button\ sizes\ to\ fill\ the\ screen}}
\DoxyCodeLine{00163\ \textcolor{preprocessor}{\#define\ touch\_reticle\_offset\ 50\ \ }\textcolor{comment}{//\ Distance\ of\ center\ of\ each\ reticle\ to\ nearest\ screen\ edge}}
\DoxyCodeLine{00164\ \textcolor{preprocessor}{\#define\ disp\_tuning\_lines\ 11\ \ }\textcolor{comment}{//\ Lines\ of\ dynamic\ variables/values\ in\ dataset\ pages\ }}
\DoxyCodeLine{00165\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_touchscreen}{Touchscreen}}\ \{}
\DoxyCodeLine{00166\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00167\ \ \ \ \ \mbox{\hyperlink{class_l_g_f_x}{LGFX}}*\ \_tft;}
\DoxyCodeLine{00168\ \ \ \ \ \mbox{\hyperlink{class_i2_c}{I2C}}*\ \_i2c;}
\DoxyCodeLine{00169\ \ \ \ \ int32\_t\ corners[2][2][2]\ =\ \{\ \{\ \{\ -\/25,\ -\/3549\ \},\ \{\ 185,\ 3839\ \}\ \},\ \ \textcolor{comment}{//\ [restouch][xx/yy][min/max]\ \ //\ Read\ resistance\ values\ from\ upper-\/left\ and\ lower-\/right\ corners\ of\ screen,\ for\ calibration}}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{\ \{\ -\/100,\ 319\ \},\ \{\ 0,\ 174\ \}\ \}\ \};\ \ \ \textcolor{comment}{//\ [captouch][xx/yy][min/max]\ \ //\ Read\ resistance\ values\ from\ upper-\/left\ and\ lower-\/right\ corners\ of\ screen,\ for\ calibration}}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordtype}{bool}\ touch\_longpress\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordtype}{bool}\ landed\_coordinates\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{keywordtype}{bool}\ lasttouch\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordtype}{int}\ tedit\_exponent\ =\ 0;}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{keywordtype}{float}\ tedit\ =\ (float)(1\ <<\ tedit\_exponent);}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{keywordtype}{int}\ touch\_fudge\ =\ 0;}
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keywordtype}{int}\ tedit\_exponent\_max\ =\ 6;}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{int}\ tlast\_x,\ tlast\_y;}
\DoxyCodeLine{00179\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ touchHoldTimer\{550000\};\ \ \textcolor{comment}{//\ Hold\ this\ long\ to\ count\ as\ a\ long\ press}}
\DoxyCodeLine{00180\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ touchAccelTimer\{400000\};}
\DoxyCodeLine{00181\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ touchDoublePressTimer\{40000\};\ \ \textcolor{comment}{//\ Won't\ allow\ a\ new\ press\ within\ this\ long\ after\ an\ old\ press\ (prevent\ accidental\ double\ clicks)}}
\DoxyCodeLine{00182\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ touchSenseTimer\{15000\};\ \ \textcolor{comment}{//\ touch\ chip\ can't\ respond\ faster\ than\ some\ time\ period}}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keywordtype}{bool}\ touchPrintEnabled\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ lastTouchPrintTime\ =\ 0;}
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ touchPrintInterval\ =\ 500;\ \textcolor{comment}{//\ Adjust\ this\ interval\ as\ needed\ (in\ milliseconds)}}
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{keyword}{enum}\ touch\_axis\ :\ \textcolor{keywordtype}{int}\ \{\ xx,\ yy,\ zz\ \};}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{keyword}{enum}\ touch\_lim\ :\ \textcolor{keywordtype}{int}\ \{\ tsmin,\ tsmax\ \};}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keywordtype}{int}\ trow,\ tcol,\ disp\_size[2],\ touch\_read[3],\ tft\_touch[2],\ landed[2];\ \ \textcolor{comment}{//\ landed\ are\ the\ initial\ coordinates\ of\ a\ touch\ event,\ unaffected\ by\ subsequent\ dragging}}
\DoxyCodeLine{00189\ \ \ \ \ uint16\_t\ tquad;\ \ \textcolor{comment}{//\ imagine\ screen\ divided\ into\ rows\ and\ columns\ as\ touch\ buttons.\ First\ byte\ encodes\ row,\ 2nd\ byte\ is\ column\ }}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{comment}{//\ uint16\_t\ touch\_cal\_data[5]\ =\ \{\ 404,\ 3503,\ 460,\ 3313,\ 1\ \};\ \ //\ Got\ from\ running\ TFT\_eSPI/examples/Generic/Touch\_calibrate/Touch\_calibrate.ino}}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{comment}{//\ lcd.setTouch(touch\_cal\_data);}}
\DoxyCodeLine{00192\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ uint8\_t\ addr\ =\ 0x38;\ \ \textcolor{comment}{//\ i2c\ addr\ for\ captouch\ panel}}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordtype}{int}\ idelta\ =\ 0;}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordtype}{bool}\ increment\_datapage\ =\ \textcolor{keyword}{false},\ increment\_sel\_val\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00196\ \ \ \ \ \mbox{\hyperlink{class_touchscreen}{Touchscreen}}()\ \{\}}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordtype}{void}\ setup(\mbox{\hyperlink{class_l_g_f_x}{LGFX}}*\ tft,\ \mbox{\hyperlink{class_i2_c}{I2C}}*\ i2c,\ \textcolor{keywordtype}{int}\ width,\ \textcolor{keywordtype}{int}\ height)\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!display\_enabled)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \_tft\ =\ tft;}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \_i2c\ =\ i2c;}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ disp\_size[HORZ]\ =\ width;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ disp\_size[VERT]\ =\ height;}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ captouch\ =\ (i2c-\/>detected(i2c\_touch));}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Touchscreen..\ \%s\ panel\(\backslash\)n"{}},\ (captouch)\ ?\ \textcolor{stringliteral}{"{}detected\ captouch"{}}\ :\ \textcolor{stringliteral}{"{}using\ resistive"{}});}
\DoxyCodeLine{00205\ \ \ \ \ \}}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{keywordtype}{bool}\ touched()\ \{\ \textcolor{keywordflow}{return}\ nowtouch;\ \}}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{keywordtype}{int}\ touch\_x()\ \{\ \textcolor{keywordflow}{return}\ tft\_touch[xx];\ \}}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordtype}{int}\ touch\_y()\ \{\ \textcolor{keywordflow}{return}\ tft\_touch[yy];\ \}}
\DoxyCodeLine{00209\ \ \ \ \ int16\_t\ touch\_pt(uint8\_t\ axis)\ \{\ \textcolor{keywordflow}{return}\ tft\_touch[axis];\ \}}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordtype}{bool}\ ontouch()\ \{\ \textcolor{keywordflow}{return}\ nowtouch\ \&\&\ !lasttouch;\ \}}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordtype}{bool}\ longpress()\ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ retval\ =\ touch\_longpress\_valid\ \&\&\ touchHoldTimer.expired();}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (retval)\ touch\_longpress\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ retval;}
\DoxyCodeLine{00215\ \ \ \ \ \}}
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (captouch\ \&\&\ \_i2c-\/>not\_my\_turn(i2c\_touch))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (touchSenseTimer.expireset())\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t\ count\ =\ \_tft-\/>getTouch(\&(touch\_read[xx]),\ \&(touch\_read[yy]));}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (captouch)\ count\ =\ \_tft-\/>getTouch(\&(touch\_read[xx]),\ \&(touch\_read[yy]),\ \&(touch\_read[zz]));}}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.printf("{}n\%d\ rx:\%d\ ry:\%d\ "{},\ nowtouch,\ touch\_read[0],\ touch\_read[1]);}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ nowtouch\ =\ (count\ >\ 0);}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (nowtouch)\ \{}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kick\_inactivity\_timer(4);\ \ \textcolor{comment}{//\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ axis=0;\ axis<=1;\ axis++)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (captouch)\ tft\_touch[axis]\ =\ touch\_read[axis];\ \ //\ disp\_width\ -\/\ 1\ -\/\ touch\_read[xx];}}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tft\_touch[axis]\ =\ map(touch\_read[axis],\ corners[captouch][axis][tsmin],\ corners[captouch][axis][tsmax],\ 0,\ disp\_size[axis]);}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tft\_touch[axis]\ =\ constrain(tft\_touch[axis],\ 0,\ disp\_size[axis]\ -\/\ 1);}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (flip\_the\_screen)\ tft\_touch[axis]\ =\ disp\_size[axis]\ -\/\ tft\_touch[axis];}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!landed\_coordinates\_valid)\ \{}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ landed[axis]\ =\ tft\_touch[axis];}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (axis)\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ landed\_coordinates\_valid\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ on\ 2nd\ time\ thru\ set\ this\ true}}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ui\_context\ ==\ DatapagesUI)\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (touchHoldTimer.elapsed()\ >\ (tedit\_exponent\ +\ 1)\ *\ touchAccelTimer.timeout())\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tedit\_exponent\ =\ constrain(tedit\_exponent+1,\ 0,\ tedit\_exponent\_max);}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tedit\ =\ (float)(1\ <<\ tedit\_exponent);\ \textcolor{comment}{//\ Update\ the\ touch\ acceleration\ value}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ process\_ui();}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{\ \ \textcolor{comment}{//\ if\ not\ being\ touched}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lasttouch)\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ landed\_coordinates\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ idelta\ =\ 0;\ \ \textcolor{comment}{//\ Stop\ changing\ the\ value}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ touchDoublePressTimer.reset();\ \ //\ Upon\ end\ of\ a\ touch,\ begin\ timer\ to\ reject\ any\ accidental\ double\ touches}}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tedit\_exponent\ =\ 0;}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tedit\ =\ (float)(1\ <<\ tedit\_exponent);\ \textcolor{comment}{//\ Reset\ touch\ acceleration\ value\ to\ 1}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ touchHoldTimer.reset();}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ touch\_longpress\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \_i2c-\/>pass\_i2c\_baton();}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ lasttouch\ =\ nowtouch;}
\DoxyCodeLine{00259\ \ \ \ \ \}}
\DoxyCodeLine{00260\ \ \ \ \ \textcolor{keywordtype}{void}\ process\_ui()\ \{}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!nowtouch)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ tquad\ =\ (constrain((landed[xx]\ -\/\ touch\_margin\_h\_pix)\ /\ touch\_cell\_h\_pix,\ 0,\ 5)\ <<\ 4)\ |\ constrain((landed[yy]\ +\ touch\_fudge)\ /\ touch\_cell\_v\_pix,\ 0,\ 4);}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.printf("{}n\%dl\%dv\%d\ q\%02x\ tx:\%3d\ ty:\%3d\ e\%d\ x\%d\(\backslash\)r"{},\ nowtouch,\ lasttouch,\ landed\_coordinates\_valid,\ tquad,\ tft\_touch[0],\ tft\_touch[1],\ tedit,\ (int)tedit\_exponent);}}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ std::cout\ <<\ "{}n"{}\ <<\ nowtouch\ <<\ "{}\ e"{}\ <<\ tedit\ <<\ "{}\ x"{}\ <<\ tedit\_exponent\ <<\ "{}\(\backslash\)r"{};}}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x00\ \&\&\ ontouch())\ increment\_datapage\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ Displayed\ dataset\ page\ can\ also\ be\ changed\ outside\ of\ simulator\ \ //\ trying\ to\ prevent\ ghost\ touches\ we\ experience\ occasionally}}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x01)\ \{\ \ \textcolor{comment}{//\ Long\ touch\ to\ enter/exit\ editing\ mode,\ if\ in\ editing\ mode,\ press\ to\ change\ the\ selection\ of\ the\ item\ to\ edit}}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ OFF)\ \{}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sel\_val\ =\ 0;\ \ \textcolor{comment}{//\ If\ entering\ select\ mode\ from\ off\ mode,\ select\ the\ first\ variable}}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (longpress())\ tunctrl\ =\ SELECT;}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ EDIT\ \&\&\ ontouch())\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tunctrl\ =\ SELECT;\ \ \textcolor{comment}{//\ Drop\ back\ to\ select\ mode}}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ increment\_sel\_val\ =\ \textcolor{keyword}{true};\ \ \textcolor{comment}{//\ Move\ to\ the\ next\ selection}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ SELECT)\ \{}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ontouch())\ increment\_sel\_val\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (longpress())\ tunctrl\ =\ OFF;}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x02)\ \{\ \ \textcolor{comment}{//\ Pressed\ the\ increase\ value\ button,\ for\ real-\/time\ tuning\ of\ variables}}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ SELECT)\ tunctrl\ =\ EDIT;\ \ \textcolor{comment}{//\ If\ just\ entering\ edit\ mode,\ don't\ change\ the\ value\ yet}}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ EDIT)\ idelta\ =\ (int)tedit;\ \ \textcolor{comment}{//\ If\ in\ edit\ mode,\ increase\ the\ value}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x03)\ \{\ \ \textcolor{comment}{//\ Pressed\ the\ decrease\ value\ button,\ for\ real-\/time\ tuning\ of\ variables}}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ SELECT)\ tunctrl\ =\ EDIT;\ \ \textcolor{comment}{//\ If\ just\ entering\ edit\ mode,\ don't\ change\ the\ value\ yet}}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tunctrl\ ==\ EDIT)\ idelta\ =\ (int)(-\/tedit);\ \ \textcolor{comment}{//\ If\ in\ edit\ mode,\ decrease\ the\ value}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x04\ \&\&\ longpress())\ sim.toggle();\ \ \textcolor{comment}{//\ Pressed\ the\ simulation\ mode\ toggle.\ Needs\ long-\/press}}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x20\ \&\&\ sim.enabled()\ \&\&\ longpress())\ calmode\_request\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x40\ \&\&\ sim.enabled()\ \&\&\ longpress())\ ignition.request(REQ\_TOG);}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x50\ \&\&\ sim.enabled()\ \&\&\ longpress())\ sleep\_request\ =\ REQ\_TOG;\ \ \textcolor{comment}{//\ sleep\ requests\ are\ handled\ by\ shutdown\ or\ asleep\ mode,\ otherwise\ will\ be\ ignored}}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x30\ \&\&\ sim.simulating(sens::basicsw)\ \&\&\ longpress())\ basicmode\_request\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x31\ \&\&\ sim.simulating(sens::pressure)\ \&\&\ pressure.source()\ ==\ src::TOUCH)\ pressure.add\_human(tedit);\ \textcolor{comment}{//\ (+=\ 25)\ Pressed\ the\ increase\ brake\ pressure\ button}}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x32\ \&\&\ sim.simulating(sens::pressure)\ \&\&\ pressure.source()\ ==\ src::TOUCH)\ pressure.add\_human(-\/tedit);\ \textcolor{comment}{//\ (-\/=\ 25)\ Pressed\ the\ decrease\ brake\ pressure\ button}}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x33\ \&\&\ sim.simulating(sens::brkpos)\ \&\&\ brkpos.source()\ ==\ src::TOUCH)\ brkpos.add\_human(tedit);\ \textcolor{comment}{//\ (-\/=\ 25)\ Pressed\ the\ decrease\ brake\ pressure\ button}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x34\ \&\&\ sim.simulating(sens::brkpos)\ \&\&\ brkpos.source()\ ==\ src::TOUCH)\ brkpos.add\_human(-\/tedit);\ \textcolor{comment}{//\ (-\/=\ 25)\ Pressed\ the\ decrease\ brake\ pressure\ button}}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x41\ \&\&\ sim.simulating(sens::tach)\ \&\&\ tach.source()\ ==\ src::TOUCH)\ tach.add\_human(tedit);}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x42\ \&\&\ sim.simulating(sens::tach)\ \&\&\ tach.source()\ ==\ src::TOUCH)\ tach.add\_human(-\/tedit);}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x43\ \&\&\ sim.simulating(sens::joy))\ adj\_val(\&hotrc.pc[VERT][FILT],\ tedit,\ hotrc.pc[VERT][OPMIN],\ hotrc.pc[VERT][OPMAX]);}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x44\ \&\&\ sim.simulating(sens::joy))\ adj\_val(\&hotrc.pc[VERT][FILT],\ -\/tedit,\ hotrc.pc[VERT][OPMIN],\ hotrc.pc[VERT][OPMAX]);}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x51\ \&\&\ sim.simulating(sens::speedo)\ \&\&\ speedo.source()\ ==\ src::TOUCH)\ speedo.add\_human(tedit);}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x52\ \&\&\ sim.simulating(sens::speedo)\ \&\&\ speedo.source()\ ==\ src::TOUCH)\ speedo.add\_human(-\/tedit);}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x53\ \&\&\ sim.simulating(sens::joy))\ adj\_val(\&hotrc.pc[HORZ][FILT],\ tedit,\ hotrc.pc[HORZ][OPMIN],\ hotrc.pc[HORZ][OPMAX]);}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tquad\ ==\ 0x54\ \&\&\ sim.simulating(sens::joy))\ adj\_val(\&hotrc.pc[HORZ][FILT],\ -\/tedit,\ hotrc.pc[HORZ][OPMIN],\ hotrc.pc[HORZ][OPMAX]);}
\DoxyCodeLine{00305\ \ \ \ \ \}}
\DoxyCodeLine{00306\ \ \ \ \ \textcolor{keywordtype}{void}\ enableTouchPrint(\textcolor{keywordtype}{bool}\ enable)\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ touchPrintEnabled\ =\ enable;}
\DoxyCodeLine{00308\ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{keywordtype}{void}\ printTouchInfo()\ \{}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (touchPrintEnabled\ \&\&\ touched())\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ currentTime\ =\ millis();}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (currentTime\ -\/\ lastTouchPrintTime\ >=\ touchPrintInterval)\ \{\}\ \ \textcolor{comment}{//\ Serial.printf("{}Touch\ \%sdetected"{},\ (read\_touch())\ ?\ "{}"{}\ :\ "{}not\ "{});}}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (nowtouch)\ Serial.printf(\textcolor{stringliteral}{"{}\ x:\%d\ y:\%d\(\backslash\)n"{}},\ tft\_touch[xx],\ tft\_touch[yy]);}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ Serial.printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ available,\ you\ can\ print\ touch\ pressure\ as\ well\ (for\ capacitive\ touch)}}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \ \ lastTouchPrintTime\ =\ currentTime;}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00317\ \ \ \ \ \}}
\DoxyCodeLine{00318\ \};}

\end{DoxyCode}

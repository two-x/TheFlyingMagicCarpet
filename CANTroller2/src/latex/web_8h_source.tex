\doxysection{web.\+h}
\hypertarget{web_8h_source}{}\label{web_8h_source}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ <Arduino.h>}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <FS.h>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <LittleFS.h>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <FFat.h>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <WiFi.h>}\ \ \textcolor{comment}{//\ "{}Wifi.h"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <ESPAsyncWebServer.h>}\ \ \textcolor{comment}{//\ To\ run\ wifi\ in\ Soft\ Access\ Point\ (SAP)\ mode\ (standalone\ w/o\ router)}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <ESPmDNS.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <WebSocketsServer.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <ArduinoJson.h>}\ \ \textcolor{comment}{//\ <AsyncJson.h>\ \ //\ "{}json.h"{}\ \ needed\ for\ JSON\ encapsulation\ (send\ multiple\ variables\ with\ one\ string)}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <ElegantOTA.h>}\ \ \textcolor{comment}{//\ includes\ <AsyncTCP.h>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#define\ FORMAT\_LITTLEFS\_IF\_FAILED\ true}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ create\ a\ callback\ function,\ triggered\ by\ web\ socket\ events}}
\DoxyCodeLine{00014\ \textcolor{keywordtype}{void}\ webSocketEvent(\textcolor{keywordtype}{byte}\ num,\ WStype\_t\ type,\ uint8\_t\ *\ payload,\ \textcolor{keywordtype}{size\_t}\ length)\ \{\ \ \textcolor{comment}{//\ the\ parameters\ of\ this\ callback\ function\ are\ always\ the\ same\ -\/>\ num:\ id\ of\ the\ client\ who\ send\ the\ event,\ type:\ type\ of\ message,\ payload:\ actual\ data\ sent\ and\ length:\ length\ of\ payload}}
\DoxyCodeLine{00015\ \ \ \ \ \textcolor{keywordflow}{switch}\ (type)\ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ switch\ on\ the\ type\ of\ information\ sent}}
\DoxyCodeLine{00016\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ WStype\_DISCONNECTED:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ a\ client\ is\ disconnected,\ then\ type\ ==\ WStype\_DISCONNECTED}}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Client\ "{}}\ +\ String(num)\ +\ \textcolor{stringliteral}{"{}\ disconnected"{}});}
\DoxyCodeLine{00018\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ WStype\_CONNECTED:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ a\ client\ is\ connected,\ then\ type\ ==\ WStype\_CONNECTED}}
\DoxyCodeLine{00020\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Client\ "{}}\ +\ String(num)\ +\ \textcolor{stringliteral}{"{}\ connected"{}});}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ optionally\ you\ can\ add\ code\ here\ what\ to\ do\ when\ connected}}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ WStype\_TEXT:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ a\ client\ has\ sent\ data,\ then\ type\ ==\ WStype\_TEXT}}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ try\ to\ decipher\ the\ JSON\ string\ received}}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ StaticJsonDocument<200>\ doc;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ create\ a\ JSON\ container}}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ DeserializationError\ error\ =\ deserializeJson(doc,\ payload);}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (error)\ \{}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(F(\textcolor{stringliteral}{"{}deserializeJson()\ failed:\ "{}}));}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(error.f\_str());}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ JSON\ string\ was\ received\ correctly,\ so\ information\ can\ be\ retrieved:}}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ g\_brand\ =\ doc[\textcolor{stringliteral}{"{}brand"{}}];}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ g\_type\ =\ doc[\textcolor{stringliteral}{"{}type"{}}];}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ g\_year\ =\ doc[\textcolor{stringliteral}{"{}year"{}}];}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ g\_color\ =\ doc[\textcolor{stringliteral}{"{}color"{}}];}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Received\ guitar\ info\ from\ user:\ "{}}\ +\ String(num));}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Brand:\ "{}}\ +\ String(g\_brand));}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Type:\ "{}}\ +\ String(g\_type));}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Year:\ "{}}\ +\ String(g\_year));}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Color:\ "{}}\ +\ String(g\_color));}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ for\ (int\ i=0;\ i<length;\ i++)\ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ //\ print\ received\ data\ from\ client}}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ Serial.print((char)payload[i]);}}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ if\ ((char)payload[i]\ ==\ 'Y')\ heartbeat\_override\_color\ =\ 0xfff8;}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ else\ if\ ((char)payload[i]\ ==\ 'N')\ heartbeat\_override\_color\ =\ 0x5cac;}}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \}}}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.println("{}"{});}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ break;}}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ \ \ case\ WStype\_BIN:}}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ printf("{}[\%u]\ get\ binary\ length:\ \%u\(\backslash\)n"{},\ num,\ length);}}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ printf("{}incloming\ data:\ 0x"{});}}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ for\ (int\ byt=0;\ byt<length;\ byt++)\ printf("{}\%02x"{});}}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ Serial.println("{}"{});}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ break;}}
\DoxyCodeLine{00059\ \ \ \ \ \}}
\DoxyCodeLine{00060\ \}}
\DoxyCodeLine{00061\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_file_system}{FileSystem}}\ \{}
\DoxyCodeLine{00062\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{void}\ cleanLittleFS()\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}Cleaning\ LittleFS..."{}});}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ LittleFS.format();}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ Serial.println(\textcolor{stringliteral}{"{}LittleFS\ cleaned."{}});}
\DoxyCodeLine{00067\ \ \ \ \ \}}
\DoxyCodeLine{00068\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00069\ \ \ \ \ \mbox{\hyperlink{class_file_system}{FileSystem}}()\ \{\}}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Littlefs\ mount\ \%s"{}},\ LittleFS.begin(FORMAT\_LITTLEFS\_IF\_FAILED)\ ?\ \textcolor{stringliteral}{"{}point\ "{}}\ :\ \textcolor{stringliteral}{"{}failed\ "{}});}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ esp\_vfs\_fat\_sdmmc\_mount("{}/"{},\ );\ \ //\ esp\_vfs\_fat\_sdmmc\_mount(const\ char\ *base\_path,\ const\ sdmmc\_host\_t\ *host\_config,\ const\ void\ *slot\_config,\ const\ esp\_vfs\_fat\_mount\_config\_t\ *mount\_config,\ sdmmc\_card\_t\ **out\_card)}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ listDir(LittleFS,\ \textcolor{stringliteral}{"{}/"{}},\ 3);}
\DoxyCodeLine{00076\ \ \ \ \ \}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordtype}{void}\ listDir(fs::FS\ \&fs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ dirname,\ uint8\_t\ levels)\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\%s"{}},\ dirname);}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ File\ root\ =\ fs.open(dirname);}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!root)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n\ \ failed\ to\ open\ directory"{}});}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!root.isDirectory())\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n\ \ not\ a\ directory"{}});}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ File\ file\ =\ root.openNextFile();}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}(file)\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(file.isDirectory())\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n\ \ dir:\ \%s"{}},\ file.name());}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(levels)\ listDir(fs,\ file.path(),\ levels\ -\/1);}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ printf(\textcolor{stringliteral}{"{}\(\backslash\)n\ \ file:\ \%s\ \ size:\ \%d"{}},\ file.name(),\ file.size());}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ file\ =\ root.openNextFile();}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \};}
\DoxyCodeLine{00100\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_access_point}{AccessPoint}}\ \{}
\DoxyCodeLine{00101\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00102\ \ \ \ \ IPAddress\ localip,\ gateway,\ subnet,\ primarydns,\ secondarydns;}
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ apssid\ =\ \textcolor{stringliteral}{"{}artcarpet"{}};}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ appassword\ =\ \textcolor{stringliteral}{"{}checkmate"{}};}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ ssid\ =\ \textcolor{stringliteral}{"{}"{}};\ \ \textcolor{comment}{//\ non-\/ap\ mode\ need\ real\ credentials\ here,\ but\ we\ don't\ want\ this\ in\ github}}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ password\ =\ \textcolor{stringliteral}{"{}"{}};\ \ \textcolor{comment}{//\ non-\/ap\ mode\ need\ real\ credentials\ here,\ but\ we\ don't\ want\ this\ in\ github}}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordtype}{void}\ connect\_existing\_wifi()\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}connecting\ to\ \%s"{}},\ ssid);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ primarydns\ =\ IPAddress(8,\ 8,\ 8,\ 8);}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ secondarydns\ =\ IPAddress(8,\ 8,\ 4,\ 4);}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ WiFi.setAutoReconnect(\textcolor{keyword}{true});}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ WiFi.config(localip,\ gateway,\ subnet,\ primarydns,\ secondarydns);}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ WiFi.begin(ssid,\ password);}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (WiFi.status()\ !=\ WL\_CONNECTED)\ \{}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ delay(500);}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ Serial.print(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}wifi\ connected.\ ip\ addr:\ "{}});}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ Serial.println(WiFi.localIP());}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00122\ \ \ \ \ \mbox{\hyperlink{class_access_point}{AccessPoint}}()\ :\ localip(192,168,1,69),\ gateway(192,168,1,5),\ subnet(255,255,255,0)\ \{\}}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}Wifi\ access\ point..\ "{}});}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ WiFi.disconnect();\ \ \textcolor{comment}{//\ in\ case\ already\ connected\ to\ another\ wifi\ as\ client\ or\ something}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ WiFi.mode(WIFI\_STA);}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ WiFi.persistent(\textcolor{keyword}{false});\ \ \textcolor{comment}{//\ Don't\ store\ wifi\ config\ in\ eeprom,\ b/c\ it\ can\ get\ stuck\ there}}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ WiFi.setSleep(\textcolor{keyword}{false});\ \ \textcolor{comment}{//\ ensure\ server\ is\ awake\ for\ accessibility}}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ WiFi.softAPConfig(localip,\ gateway,\ subnet);}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ WiFi.softAP(apssid,\ appassword);}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ Serial.printf(\textcolor{stringliteral}{"{}active.\ ssid:\%s,\ pwd:\%s,\ ip:"{}},\ apssid,\ appassword);}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ Serial.println(WiFi.softAPIP());}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ std::cout\ <<\ "{}ip\ =\ "{}\ <<\ WiFi.softAPIP()\ <<\ std::endl;}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ printf("{}\ ip\ =\ \%s\(\backslash\)n"{},\ my\_ip.c\_str());}}
\DoxyCodeLine{00135\ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordtype}{void}\ enable(\textcolor{keywordtype}{bool}\ sw)\ \{\ WiFi.setSleep(!sw);\ \}}
\DoxyCodeLine{00137\ \};}
\DoxyCodeLine{00138\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_web}{Web}}\ \{}
\DoxyCodeLine{00139\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00140\ \ \ \ \ AsyncWebServer\ webserver;}
\DoxyCodeLine{00141\ \ \ \ \ WebSocketsServer\ socket;}
\DoxyCodeLine{00142\ \ \ \ \ \mbox{\hyperlink{class_timer}{Timer}}\ socket\_timer;}
\DoxyCodeLine{00143\ \ \ \ \ uint32\_t\ socket\_refresh\_us\ =\ 1000000,\ dumdum\ =\ 1;}
\DoxyCodeLine{00144\ \ \ \ \ \mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ looptimer;}
\DoxyCodeLine{00145\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00146\ \ \ \ \ \mbox{\hyperlink{class_web}{Web}}()\ :\ webserver(80),\ socket(81)\ \{\}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordtype}{void}\ setup(\mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ \_lt)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ looptimer\ =\ \_lt;}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Web\ services..\(\backslash\)n"{}});}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ webserver.on(\textcolor{stringliteral}{"{}/tester"{}},\ HTTP\_GET,\ [](AsyncWebServerRequest\ *request)\{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>send(200,\ \textcolor{stringliteral}{"{}text/plain"{}},\ \textcolor{stringliteral}{"{}Hello,\ tester"{}});}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ webserver.on(\textcolor{stringliteral}{"{}/"{}},\ HTTP\_GET,\ [](AsyncWebServerRequest\ *request)\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ AsyncWebServerResponse\ *response\ =\ request-\/>beginResponse(LittleFS,\ \textcolor{stringliteral}{"{}/index.html"{}},\ \textcolor{stringliteral}{"{}text/html"{}});\ \ \textcolor{comment}{//\ Serve\ the\ HTML\ page}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>send(response);}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ webserver.on(\textcolor{stringliteral}{"{}/chessboard.js"{}},\ HTTP\_GET,\ [](AsyncWebServerRequest\ *request)\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ AsyncWebServerResponse\ *response\ =\ request-\/>beginResponse(LittleFS,\ \textcolor{stringliteral}{"{}/chessboard.js"{}},\ \textcolor{stringliteral}{"{}application/javascript"{}});\ \ \textcolor{comment}{//\ Serve\ the\ JavaScript\ file}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>send(response);}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ webserver.onNotFound([](AsyncWebServerRequest\ *request)\ \{\ \ \textcolor{comment}{//\ Send\ back\ a\ plain\ text\ message\ (can\ be\ made\ html\ if\ required)}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ request-\/>send(404,\ \textcolor{stringliteral}{"{}text/plain"{}},\ \textcolor{stringliteral}{"{}404\ -\/\ Page\ Not\ Found.\ \ Try\ '/'\ or\ '/update'"{}});}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\ \ Over-\/The-\/Air\ update\ support..\(\backslash\)n"{}});}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ ElegantOTA.begin(\&webserver);\ \ \textcolor{comment}{//\ start\ OTA\ after\ all\ server.on\ requests,\ before\ starting\ web\ server}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\ \ Webserver..\(\backslash\)n"{}});}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ webserver.begin();}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\ \ Websockets..\(\backslash\)n"{}});}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ socket.begin();}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ socket.onEvent(webSocketEvent);}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ socket\_timer.set(socket\_refresh\_us);}
\DoxyCodeLine{00172\ \ \ \ \ \}}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{keywordtype}{void}\ update\ ()\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ webserver.handleClient();}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ socket.loop();}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (socket\_timer.expireset())\ \{}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ String\ sendme\ =\ String(random(100));}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ socket.broadcastTXT(sendme.c\_str());}}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ String\ jsonString\ =\ \textcolor{stringliteral}{"{}"{}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ create\ a\ JSON\ string\ for\ sending\ data\ to\ the\ client}}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ StaticJsonDocument<200>\ doc;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ create\ a\ JSON\ container}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ JsonObject\ \textcolor{keywordtype}{object}\ =\ doc.to<JsonObject>();\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ create\ a\ JSON\ Object}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}[\textcolor{stringliteral}{"{}rand1"{}}]\ =\ random(100);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ write\ data\ into\ the\ JSON\ object\ -\/>\ I\ used\ "{}rand1"{}\ and\ "{}rand2"{}\ here,\ but\ you\ can\ use\ anything\ else}}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}[\textcolor{stringliteral}{"{}rand2"{}}]\ =\ random(100);}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}[\textcolor{stringliteral}{"{}loopavg"{}}]\ =\ (int32\_t)(loop\_avg\_us);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ write\ data\ into\ the\ JSON\ object\ -\/>\ I\ used\ "{}rand1"{}\ and\ "{}rand2"{}\ here,\ but\ you\ can\ use\ anything\ else}}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}[\textcolor{stringliteral}{"{}looppeak"{}}]\ =\ looptimer-\/>loop\_peak\_us;}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ serializeJson(doc,\ jsonString);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ convert\ JSON\ object\ to\ string}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Serial.println(jsonString);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ //\ print\ JSON\ string\ to\ console\ for\ debug\ purposes\ (you\ can\ comment\ this\ out)}}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ socket.broadcastTXT(jsonString);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ send\ JSON\ string\ to\ clients}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00190\ \ \ \ \ \}}
\DoxyCodeLine{00191\ \};}
\DoxyCodeLine{00192\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_web_manager}{WebManager}}\ \{}
\DoxyCodeLine{00193\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordtype}{bool}\ web\_started\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00195\ \ \ \ \ \mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ looptimer;}
\DoxyCodeLine{00196\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00197\ \ \ \ \ \mbox{\hyperlink{class_file_system}{FileSystem}}\ fs;}
\DoxyCodeLine{00198\ \ \ \ \ \mbox{\hyperlink{class_access_point}{AccessPoint}}\ wifi;}
\DoxyCodeLine{00199\ \ \ \ \ \mbox{\hyperlink{class_web}{Web}}\ server;}
\DoxyCodeLine{00200\ \ \ \ \ \mbox{\hyperlink{class_web_manager}{WebManager}}(\mbox{\hyperlink{class_loop_timer}{LoopTimer}}*\ \_lt)\ :\ looptimer(\_lt)\ \{\}}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordtype}{void}\ setup()\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ wifi.setup();}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ fs.setup();}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ server.setup(looptimer);}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ web\_started\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00206\ \ \ \ \ \}}
\DoxyCodeLine{00207\ \ \ \ \ String\ processor(\textcolor{keyword}{const}\ String\ \&var)\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (var\ ==\ \textcolor{stringliteral}{"{}CHESSBOARD\_COLOR"{}})\ \textcolor{keywordflow}{return}\ getRandomColor();\ \ \textcolor{comment}{//\ Replace\ placeholders\ in\ the\ HTML\ with\ dynamic\ content}}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ String();}
\DoxyCodeLine{00210\ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \ \ String\ getRandomColor()\ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ String(\textcolor{stringliteral}{"{}rgb("{}})\ +\ String(random(256))\ +\ \textcolor{stringliteral}{"{},"{}}\ +\ String(random(256))\ +\ \textcolor{stringliteral}{"{},"{}}\ +\ String(random(256))\ +\ \textcolor{stringliteral}{"{})"{}};\ \ \textcolor{comment}{//\ Generate\ a\ random\ RGB\ color}}
\DoxyCodeLine{00213\ \ \ \ \ \}}
\DoxyCodeLine{00214\ \ \ \ \ \textcolor{keywordtype}{void}\ update()\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (web\_disabled)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!web\_started)\ setup();}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ wifi.enable(syspower);}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (syspower)\ server.update();}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ (<activity\ in\ web\ page\ is\ detected>)\ sleep\_inactivity\_timer.reset();\ \ //\ evidence\ of\ user\ activity}}
\DoxyCodeLine{00220\ \ \ \ \ \}}
\DoxyCodeLine{00221\ \};}

\end{DoxyCode}
